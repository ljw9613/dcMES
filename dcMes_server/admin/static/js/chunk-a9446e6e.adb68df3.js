(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-a9446e6e"],{"0dfe":function(e,t,a){"use strict";a("2b43")},"14e1":function(e,t,a){e.exports=a.p+"static/media/cfbd.7c42ce8c.mp3"},"2b43":function(e,t,a){},"31b6":function(e,t,a){e.exports=a.p+"static/media/bdcg.762434df.mp3"},3394:function(e,t,a){"use strict";a("5092")},"33fd":function(e,t,a){e.exports=a.p+"static/media/tmyw.a5dd40df.mp3"},5092:function(e,t,a){},"7da5":function(e,t){},de6b:function(e,t,a){e.exports=a.p+"static/media/smcg.fe637541.mp3"},ed91:function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"b",(function(){return s})),a.d(t,"c",(function(){return i})),a.d(t,"d",(function(){return c}));var r=a("b775");function n(e){return Object(r.a)({url:"/create-flow",method:"post",data:e})}function s(e){return Object(r.a)({url:"/scan-components",method:"post",data:e})}function i(e){return Object(r.a)({url:"/unbind-components",method:"post",data:e})}function c(e){return Object(r.a)({url:"/update-flow-nodes",method:"post",data:e})}},f783:function(e,t,a){"use strict";a.r(t);var r=(a("f559"),a("456d"),a("8615"),a("a481"),a("28a5"),a("6762"),a("2fdb"),a("7514"),a("2909")),n=(a("1c4c"),a("14b9"),a("b85c")),s=(a("ac6a"),a("5df3"),a("4f7f"),a("c7eb")),i=(a("96cf"),a("1da1")),c=a("7e1e"),o=a("ed91"),l=a("b775");function u(e){return Object(l.a)({url:"/material-barcode/create",method:"post",data:e})}var d=a("6ace");function p(e){new Audio(e).play().catch((function(e){console.warn("éŸ³é¢‘æ’­æ”¾å¤±è´¥:",e)}))}var h=a("de6b"),m=a.n(h),f=a("33fd"),b=a.n(f),v=a("31b6"),g=a.n(v),k=a("14e1"),x=a.n(k),_=(a("7da5"),{name:"TscPrinter",props:{materialCode:{type:String,default:""},barcode:{type:String,default:""},visible:{type:Boolean,default:!1}},data:function(){return{usbChecked:!0,networkChecked:!1,driverChecked:!1,usbPrinters:[],selectedUsbPrinter:"",printerIP:"",printerPort:"9100",driverPrinters:[],selectedDriver:"",printing:!1,websocket:null,wsUrl:"ws://127.0.0.1:8888",dialogVisible:!1,checkingStatus:!1,wsConnected:!1}},watch:{visible:{handler:function(e){this.dialogVisible=e},immediate:!0}},mounted:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.initWebSocket();case 2:setTimeout((function(){t.getUsbPrinterList(),t.getDriverList()}),1e3);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),methods:{initWebSocket:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.websocket=new WebSocket(this.wsUrl),this.websocket.onopen=this.handleWsOpen,this.websocket.onclose=this.handleWsClose,this.websocket.onmessage=this.handleWsMessage,this.websocket.onerror=this.handleWsError;case 5:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),handleWsOpen:function(){this.wsConnected=!0,this.reconnectAttempts=0,console.log("WebSocketè¿æ¥æˆåŠŸ"),this.$message.success("æ‰“å°æœåŠ¡è¿æ¥æˆåŠŸ")},handleWsClose:function(e){this.wsConnected=!1;var t=this.getCloseReason(e.code);console.error("WebSocketè¿æ¥å…³é—­: ".concat(t)),this.$message.error("æ‰“å°æœåŠ¡è¿æ¥æ–­å¼€: ".concat(t))},getCloseReason:function(e){return{1001:"æœåŠ¡å™¨å…³é—­æˆ–æµè§ˆå™¨ç¦»å¼€é¡µé¢",1002:"åè®®é”™è¯¯",1003:"æ¥æ”¶åˆ°ä¸æ”¯æŒçš„æ•°æ®ç±»å‹",1004:"ä¿ç•™çŠ¶æ€ç ",1005:"æ²¡æœ‰æ”¶åˆ°çŠ¶æ€ç ",1006:"è¿æ¥å¼‚å¸¸å…³é—­",1007:"æ¥æ”¶åˆ°éUTF-8æ•°æ®",1008:"è¿åç­–ç•¥",1009:"æ¥æ”¶åˆ°è¿‡å¤§çš„æ¶ˆæ¯",1010:"å®¢æˆ·ç«¯éœ€è¦çš„æ‰©å±•æœªåå•†",1011:"æœåŠ¡å™¨é‡åˆ°æ„å¤–æƒ…å†µ",1015:"TLSæ¡æ‰‹å¤±è´¥"}[e]||"æœªçŸ¥åŸå› "},handleWsMessage:function(e){console.log("æ”¶åˆ°æœåŠ¡å™¨æ¶ˆæ¯:",e.data);try{if("Finished"===e.data)return void this.$message.success("æ“ä½œå®Œæˆ");var t=JSON.parse(e.data);t.usb_list&&(0===t.usb_list.length&&this.$message.warning("æœªæ‰¾åˆ°USBæ‰“å°æœº"),this.usbPrinters=t.usb_list,this.usbPrinters.length>0&&(this.selectedUsbPrinter=this.usbPrinters[0].USBPath)),t.driver_list&&(0===t.driver_list.length&&this.$message.warning("æœªæ‰¾åˆ°é©±åŠ¨æ‰“å°æœº"),this.driverPrinters=t.driver_list,this.driverPrinters.length),t.Function_Failed&&this.$message.error("æ“ä½œå¤±è´¥: ".concat(t.Function_Failed)),t.printerstatus&&t.printerstatus.length>0&&this.$message.info("æ‰“å°æœºçŠ¶æ€:\n".concat(t.printerstatus.join("\n"))),t.printername&&this.$message.info("æ‰“å°æœºåç§°: ".concat(t.printername)),t.printerserial&&this.$message.info("æ‰“å°æœºåºåˆ—å·: ".concat(t.printerserial))}catch(e){console.error("æ¶ˆæ¯è§£æé”™è¯¯:",e),this.$message.error("æ¥æ”¶åˆ°æ— æ•ˆæ•°æ®")}},handleWsError:function(e){this.wsConnected=!1,console.error("WebSocketé”™è¯¯:",e),this.$message.error("æ‰“å°æœåŠ¡è¿æ¥é”™è¯¯ï¼Œè¯·ç¡®ä¿TSCæ‰“å°æœåŠ¡å·²å¯åŠ¨")},sendWsMessage:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("sendWsMessage",t),this.wsConnected){e.next=3;break}throw new Error("æ‰“å°æœåŠ¡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥æ‰“å°æœåŠ¡æ˜¯å¦å¯åŠ¨");case 3:if(this.websocket.readyState!==WebSocket.OPEN){e.next=7;break}this.websocket.send(JSON.stringify(t)),e.next=8;break;case 7:throw new Error("WebSocketè¿æ¥æœªå°±ç»ª");case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleUsbCheck:function(e){e&&(this.networkChecked=!1,this.driverChecked=!1)},handleNetworkCheck:function(e){e&&(this.usbChecked=!1,this.driverChecked=!1)},handleDriverCheck:function(e){e&&(this.usbChecked=!1,this.networkChecked=!1)},getUsbPrinterList:function(){this.sendWsMessage({usb_list:[]})},getDriverList:function(){this.sendWsMessage({driver_list:[]})},checkInterface:function(){if(this.usbChecked)return!(this.usbPrinters.length<=0||!this.selectedUsbPrinter)||(this.$message.error("è¯·é€‰æ‹©USBæ‰“å°æœº"),!1);if(this.networkChecked){return/^(\d{1,3}\.){3}\d{1,3}$/.test(this.printerIP)?!!/^[1-9]\d*$/.test(this.printerPort)||(this.$message.error("æ— æ•ˆçš„ç«¯å£å·"),!1):(this.$message.error("æ— æ•ˆçš„IPåœ°å€"),!1)}return this.driverChecked?!(this.driverPrinters.length<=0||!this.selectedDriver)||(this.$message.error("è¯·é€‰æ‹©æ‰“å°æœºé©±åŠ¨"),!1):(this.$message.error("è¯·é€‰æ‹©æ‰“å°æœºè¿æ¥æ–¹å¼"),!1)},printTemplate:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,this.printing=!0,t={functions_inorder:[{init:""},this.usbChecked?{openport_usb:this.selectedUsbPrinter}:this.networkChecked?{openport_net:"".concat(this.printerIP,",").concat(this.printerPort)}:{openport_driver:this.selectedDriver},{clearbuffer:""},{setup:"60,28,4,8,0,3,0"},{windowsfont:"40,40,".concat(28,",0,0,0,Arial,ç‰©æ–™ï¼š").concat(this.materialCode)},{windowsfont:"40,120,".concat(28,",0,0,0,Arial,æ¡ç å¦‚ä¸‹ï¼š")},{windowsfont:"40,200,".concat(28,",0,0,0,Arial,").concat(this.barcode)},{sendcommand_crlf:'QRCODE 440,24,H,8,A,0,M2,S5,"'.concat(this.barcode,'"')},{printlabel:"1,1"},{closeport:""}]},e.next=9,this.sendWsMessage(t);case 9:this.$emit("print-success"),this.$message.success("æ‰“å°æˆåŠŸ"),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("æ‰“å°å¤±è´¥:",e.t0),this.$emit("print-error",e.t0.message||"æ‰“å°å¤±è´¥"),this.$message.error("æ‰“å°å¤±è´¥: ".concat(e.t0.message||"æœªçŸ¥é”™è¯¯"));case 18:return e.prev=18,this.printing=!1,e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[2,13,18,21]])})));return function(){return e.apply(this,arguments)}}(),printTestPage:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,t={functions_inorder:[{function:"init"},this.usbChecked?{function:"openport_usb",args:[this.selectedUsbPrinter]}:this.networkChecked?{function:"openport_net",args:[this.printerIP,this.printerPort]}:{function:"openport_driver",args:[this.selectedDriver]},{function:"sendcommand",args:["SELFTEST"]},{function:"closeport"}]},e.next=6,this.sendWsMessage(t);case 6:this.$message.success("æµ‹è¯•é¡µæ‰“å°æˆåŠŸ"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),this.$message.error("æµ‹è¯•é¡µæ‰“å°å¤±è´¥: ".concat(e.t0.message||"æœªçŸ¥é”™è¯¯"));case 12:case"end":return e.stop()}}),e,this,[[2,9]])})));return function(){return e.apply(this,arguments)}}(),checkPrinterStatus:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,this.checkingStatus=!0,t={functions_inorder:[{function:"init"},this.usbChecked?{function:"openport_usb",args:[this.selectedUsbPrinter]}:this.networkChecked?{function:"openport_net",args:[this.printerIP,this.printerPort]}:{function:"openport_driver",args:[this.selectedDriver]},{function:"printerstatus"},{function:"printername"},{function:"printerserial"},{function:"closeport"}]},e.next=7,this.sendWsMessage(t);case 7:this.$message.success("æ‰“å°æœºè¿æ¥æ­£å¸¸"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),console.error("æ£€æŸ¥æ‰“å°æœºçŠ¶æ€å¤±è´¥:",e.t0),this.$message.error("æ£€æŸ¥æ‰“å°æœºçŠ¶æ€å¤±è´¥: ".concat(e.t0.message||"æœªçŸ¥é”™è¯¯"));case 14:return e.prev=14,this.checkingStatus=!1,e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[2,10,14,17]])})));return function(){return e.apply(this,arguments)}}(),handleClose:function(){this.dialogVisible=!1},confirmPrint:function(){var e=this;this.printTemplate().then((function(){e.handleClose()}))},print:function(){return this.printTemplate()}}}),C=_,w=(a("3394"),a("2877")),I=Object(w.a)(C,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{attrs:{title:"æ‰“å°è®¾ç½®",visible:e.dialogVisible,width:"600px","before-close":e.handleClose,"close-on-click-modal":!1,"close-on-press-escape":!1},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("div",{staticClass:"tsc-printer"},[a("div",{staticClass:"param-display interface-block"},[a("div",{staticClass:"card-header"},[a("i",{staticClass:"el-icon-document"}),e._v(" "),a("span",[e._v("æ‰“å°å‚æ•°")])]),e._v(" "),a("div",{staticClass:"param-table"},[a("table",[a("tr",[a("th",[e._v("ç‰©æ–™ç¼–ç ")]),e._v(" "),a("td",[e._v(e._s(e.materialCode))]),e._v(" "),a("th",[e._v("æ¡ç å†…å®¹")]),e._v(" "),a("td",[e._v(e._s(e.barcode))])])])])]),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"card-header"},[a("i",{staticClass:"el-icon-printer"}),e._v(" "),a("span",[e._v("æ‰“å°æœºè¿æ¥")])]),e._v(" "),a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleUsbCheck},model:{value:e.usbChecked,callback:function(t){e.usbChecked=t},expression:"usbChecked"}},[e._v("USBè¿æ¥")]),e._v(" "),a("i",{staticClass:"el-icon-usb"})],1),e._v(" "),e.usbChecked?a("div",{staticClass:"printer-select"},[a("span",[e._v("æ‰“å°æœºåç§°ï¼š")]),e._v(" "),a("el-select",{model:{value:e.selectedUsbPrinter,callback:function(t){e.selectedUsbPrinter=t},expression:"selectedUsbPrinter"}},e._l(e.usbPrinters,(function(e){return a("el-option",{key:e.USBPath,attrs:{label:e.USBName,value:e.USBPath}})})),1)],1):e._e()]),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleNetworkCheck},model:{value:e.networkChecked,callback:function(t){e.networkChecked=t},expression:"networkChecked"}},[e._v("ç½‘ç»œè¿æ¥")]),e._v(" "),a("i",{staticClass:"el-icon-connection"})],1),e._v(" "),e.networkChecked?[a("div",{staticClass:"network-input"},[a("span",[e._v("æ‰“å°æœºIPåœ°å€ï¼š")]),e._v(" "),a("el-input",{attrs:{placeholder:"è¯·è¾“å…¥IPåœ°å€"},model:{value:e.printerIP,callback:function(t){e.printerIP=t},expression:"printerIP"}})],1),e._v(" "),a("div",{staticClass:"network-input"},[a("span",[e._v("ç«¯å£å·ï¼š")]),e._v(" "),a("el-input",{attrs:{placeholder:"9100"},model:{value:e.printerPort,callback:function(t){e.printerPort=t},expression:"printerPort"}})],1)]:e._e()],2),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleDriverCheck},model:{value:e.driverChecked,callback:function(t){e.driverChecked=t},expression:"driverChecked"}},[e._v("é©±åŠ¨è¿æ¥")])],1),e._v(" "),e.driverChecked?a("div",{staticClass:"printer-select"},[a("span",[e._v("é©±åŠ¨åç§°ï¼š")]),e._v(" "),a("el-select",{model:{value:e.selectedDriver,callback:function(t){e.selectedDriver=t},expression:"selectedDriver"}},e._l(e.driverPrinters,(function(e){return a("el-option",{key:e.DriverName,attrs:{label:e.DriverName,value:e.DriverName}})})),1)],1):e._e()]),e._v(" "),a("div",{staticClass:"print-controls"},[a("el-button",{attrs:{type:"primary",loading:e.printing},on:{click:e.confirmPrint}},[e._v("\n                "+e._s(e.printing?"æ‰“å°ä¸­...":"ç¡®è®¤æ‰“å°")+"\n            ")]),e._v(" "),a("el-button",{attrs:{type:"info",loading:e.checkingStatus},on:{click:e.checkPrinterStatus}},[e._v("\n                "+e._s(e.checkingStatus?"æ£€æŸ¥ä¸­...":"æ£€æŸ¥æ‰“å°æœº")+"\n            ")]),e._v(" "),a("el-button",{on:{click:e.handleClose}},[e._v("å–æ¶ˆ")])],1)])])}),[],!1,null,"00ea37fe",null),S=I.exports,O={name:"ScanBarCode",components:{ZrSelect:d.a,TscPrinter:S},data:function(){return{formData:{productModel:"",productLine:"",processStep:"",componentName:""},productOptions:[],processStepOptions:[],materialOptions:[],materialLoading:!1,mainMaterialName:"",mainMaterialCode:"",workmainMaterialId:"",workmainMaterialCode:"",processMaterials:[],scanForm:{mainBarcode:"",barcodes:{}},productLineOptions:[{_id:"1",FNumber:"1",FName:"äº§çº¿1"},{_id:"2",FNumber:"2",FName:"äº§çº¿2"}],validateStatus:{mainBarcode:!1},loading:!1,unifiedScanInput:"",hasEditPermission:!1,scanTimer:null,batchMaterialCache:{},printDialogVisible:!1,currentBatchBarcode:"",autoPrint:!1,isCollapsed:!1}},computed:{mainMaterialId:{get:function(){return localStorage.getItem("mainMaterialId")||""},set:function(e){localStorage.setItem("mainMaterialId",e)}},processStepId:{get:function(){return localStorage.getItem("processStepId")||""},set:function(e){localStorage.setItem("processStepId",e)}},materialName:{get:function(){return localStorage.getItem("materialName")||""},set:function(e){localStorage.setItem("materialName",e)}},processName:{get:function(){return localStorage.getItem("processName")||""},set:function(e){localStorage.setItem("processName",e)}},productLineId:{get:function(){return localStorage.getItem("productLineId")||""},set:function(e){localStorage.setItem("productLineId",e)}},productLineName:{get:function(){return localStorage.getItem("productLineName")||""},set:function(e){localStorage.setItem("productLineName",e)}}},watch:{mainMaterialId:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=5;break}return e.next=3,this.getMainMaterialInfo();case 3:e.next=6;break;case 5:this.mainMaterialName="";case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),processStepId:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=5;break}return e.next=3,this.getProcessMaterials();case 3:e.next=8;break;case 5:this.processMaterials=[],this.scanForm.barcodes={},this.validateStatus={mainBarcode:!1};case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),validateStatus:{handler:function(e){},deep:!0}},methods:{handlePrintBatch:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a,r=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.$loading({lock:!0,text:"æ­£åœ¨ç”Ÿæˆæ‰¹æ¬¡æ¡ç ...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),e.prev=1,this.mainMaterialCode){e.next=4;break}throw new Error("æœªè·å–åˆ°ç‰©æ–™ç¼–ç ä¿¡æ¯");case 4:return e.next=6,u({materialCode:this.mainMaterialCode});case 6:if(200!==(a=e.sent).code||!a.data.batchId){e.next=27;break}return this.currentBatchBarcode=a.data.batchId,e.next=11,this.$nextTick();case 11:if(!this.autoPrint){e.next=23;break}if(!this.currentBatchBarcode||!this.mainMaterialCode){e.next=20;break}return e.next=15,this.$refs.tscPrinter.print();case 15:return this.unifiedScanInput=this.currentBatchBarcode,e.next=18,this.handleUnifiedScan(this.currentBatchBarcode);case 18:e.next=21;break;case 20:throw new Error("æ‰“å°æ•°æ®æœªå‡†å¤‡å°±ç»ª");case 21:e.next=24;break;case 23:this.$refs.tscPrinter.dialogVisible=!0;case 24:this.$nextTick((function(){r.$refs.scanInput.focus()})),e.next=28;break;case 27:throw new Error("æ‰¹æ¬¡æ¡ç ç”Ÿæˆå¤±è´¥");case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(1),this.$message.error(e.t0.message||"æ‰¹æ¬¡æ¡ç ç”Ÿæˆå¤±è´¥");case 33:return e.prev=33,t.close(),this.$nextTick((function(){r.$refs.scanInput.focus()})),e.finish(33);case 37:case"end":return e.stop()}}),e,this,[[1,30,33,37]])})));return function(){return e.apply(this,arguments)}}(),handleProductionLineSelect:function(e){e&&(this.formData.lineName=e.lineName,this.formData.productLine=e._id,localStorage.setItem("productLineName",e.lineName),localStorage.setItem("productLineId",e._id))},getMaterialById:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("k3_BD_MATERIAL",{query:{_id:t}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getCraftByMaterialId:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("craft",{query:{materialId:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessStepById:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("processStep",{query:{_id:t},sort:{sort:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessMaterialById:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("processMaterials",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getMaterialList:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===t){e.next=18;break}return this.materialLoading=!0,e.prev=2,e.next=5,Object(c.b)("k3_BD_MATERIAL",{query:{$or:[{FNumber:{$regex:t,$options:"i"}},{FName:{$regex:t,$options:"i"}}]},page:1,limit:20});case 5:a=e.sent,this.productOptions=a.data,e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("è·å–äº§å“å‹å·å¤±è´¥:",e.t0),this.$message.error("è·å–äº§å“å‹å·å¤±è´¥");case 13:return e.prev=13,this.materialLoading=!1,e.finish(13);case 16:e.next=19;break;case 18:this.productOptions=[];case 19:case"end":return e.stop()}}),e,this,[[2,9,13,16]])})));return function(t){return e.apply(this,arguments)}}(),getAllProcessSteps:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a,r,i,o,l,u,d,p,h,m,f,b,v,g=arguments;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=g.length>1&&void 0!==g[1]?g[1]:new Set,r=g.length>2&&void 0!==g[2]?g[2]:new Set,i=g.length>3&&void 0!==g[3]?g[3]:0,e.prev=3,!r.has(t)){e.next=6;break}return e.abrupt("return",a);case 6:return r.add(t),e.next=9,Object(c.b)("craft",{query:{materialId:t},page:1,limit:1});case 9:if((o=e.sent).data&&0!==o.data.length){e.next=12;break}return e.abrupt("return",a);case 12:return l=o.data[0],e.next=15,Object(c.b)("processStep",{query:{craftId:l._id},sort:{sort:1}});case 15:if(!(u=e.sent).data){e.next=55;break}d=Object(n.a)(u.data),e.prev=18,d.s();case 20:if((p=d.n()).done){e.next=47;break}return(h=p.value).levelPrefix="â”—".repeat(i),a.add(h),e.next=26,Object(c.b)("processMaterials",{query:{processStepId:h._id}});case 26:if(!(m=e.sent).data){e.next=45;break}f=Object(n.a)(m.data),e.prev=29,f.s();case 31:if((b=f.n()).done){e.next=37;break}return v=b.value,e.next=35,this.getAllProcessSteps(v.materialId,a,r,i+1);case 35:e.next=31;break;case 37:e.next=42;break;case 39:e.prev=39,e.t0=e.catch(29),f.e(e.t0);case 42:return e.prev=42,f.f(),e.finish(42);case 45:e.next=20;break;case 47:e.next=52;break;case 49:e.prev=49,e.t1=e.catch(18),d.e(e.t1);case 52:return e.prev=52,d.f(),e.finish(52);case 55:return e.abrupt("return",a);case 58:return e.prev=58,e.t2=e.catch(3),console.error("è·å–å·¥åºå¤±è´¥:",e.t2),e.abrupt("return",a);case 62:case"end":return e.stop()}}),e,this,[[3,58],[18,49,52,55],[29,39,42,45]])})));return function(t){return e.apply(this,arguments)}}(),handleProductChange:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t._id,this.processStepOptions=[],this.formData.processStep="",this.mainMaterialId="",a){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,e.next=9,this.getAllProcessSteps(a,new Set,new Set);case 9:r=e.sent,console.log("è·å–åˆ°çš„å·¥åº:",r),this.processStepOptions=Array.from(r),this.formData.productModel=a,e.next=19;break;case 15:e.prev=15,e.t0=e.catch(6),console.error("è·å–å·¥åºåˆ—è¡¨å¤±è´¥:",e.t0),this.$message.error("è·å–å·¥åºåˆ—è¡¨å¤±è´¥");case 19:case"end":return e.stop()}}),e,this,[[6,15]])})));return function(t){return e.apply(this,arguments)}}(),handleProcessChange:function(e){e?this.formData.processStep=e:this.processStepId=""},handleSave:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.formData.productModel&&this.formData.processStep&&this.formData.productLine){e.next=3;break}return this.$message.warning("è¯·é€‰æ‹©äº§å“å‹å·ã€å·¥åºå’Œäº§çº¿"),e.abrupt("return");case 3:return t=this.$loading({lock:!0,text:"ä¿å­˜ä¸­...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),e.prev=4,this.resetScanForm(),this.mainMaterialId=this.formData.productModel,this.processStepId=this.formData.processStep,this.productLineId=this.formData.productLine,e.next=11,this.getMaterialById(this.formData.productModel);case 11:return(a=e.sent)&&(this.materialName="".concat(a.FNumber," - ").concat(a.FName)),e.next=15,this.getProcessStepById(this.formData.processStep);case 15:(r=e.sent)&&(this.processName=r.processName),this.$message.success("ä¿å­˜æˆåŠŸ"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(4),console.error("ä¿å­˜å¤±è´¥:",e.t0),this.$message.error("ä¿å­˜å¤±è´¥"),t.close();case 26:case"end":return e.stop()}}),e,this,[[4,21]])})));return function(){return e.apply(this,arguments)}}(),getMainMaterialInfo:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("æ­£åœ¨è·å–ä¸»ç‰©æ–™ä¿¡æ¯ï¼ŒID:",this.mainMaterialId),e.next=4,Object(c.b)("k3_BD_MATERIAL",{query:{_id:this.mainMaterialId},page:1,limit:1});case 4:(t=e.sent).data&&t.data[0]?(console.log("è·å–åˆ°çš„ä¸»ç‰©æ–™ä¿¡æ¯:",t.data[0]),this.mainMaterialName=t.data[0].FName,this.mainMaterialCode=t.data[0].FNumber):(console.log("æœªæ‰¾åˆ°ä¸»ç‰©æ–™ä¿¡æ¯"),this.mainMaterialName="",this.mainMaterialCode=""),e.next=14;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("è·å–ä¸»ç‰©æ–™ä¿¡æ¯å¤±è´¥:",e.t0),this.$message.error("è·å–ä¸»ç‰©æ–™ä¿¡æ¯å¤±è´¥"),this.mainMaterialName="",this.mainMaterialCode="";case 14:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),getProcessMaterials:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a,r,n,i,o,l=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("æ­£åœ¨è·å–å·¥åºä¿¡æ¯ï¼ŒID:",this.processStepId),e.next=4,Object(c.b)("processStep",{query:{_id:this.processStepId},page:1,limit:1});case 4:if((t=e.sent).data&&0!==!t.data.length){e.next=7;break}throw new Error("æœªæ‰¾åˆ°å·¥åºä¿¡æ¯");case 7:return a=t.data[0],e.next=10,Object(c.b)("craft",{query:{_id:a.craftId},page:1,limit:1});case 10:if((r=e.sent).data&&0!==!r.data.length){e.next=13;break}throw new Error("æœªæ‰¾åˆ°å·¥è‰ºä¿¡æ¯");case 13:return n=r.data[0],e.next=16,this.getMaterialById(n.materialId);case 16:if(i=e.sent){e.next=19;break}throw new Error("æœªæ‰¾åˆ°ç‰©æ–™ä¿¡æ¯");case 19:return this.workmainMaterialId=i._id,this.workmainMaterialCode=i.FNumber,this.mainMaterialName=i.FName,this.mainMaterialCode=i.FNumber,console.log("processStep",a),e.prev=24,e.next=27,Object(c.b)("processMaterials",{query:{processStepId:this.processStepId}});case 27:(o=e.sent).data?(this.processMaterials=o.data,this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={},this.processMaterials.forEach((function(e){l.validateStatus[e._id]=!1,l.$set(l.scanForm.barcodes,e._id,"")}))):(this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={}),e.next=38;break;case 31:e.prev=31,e.t0=e.catch(24),console.error("è·å–å·¥åºç‰©æ–™å¤±è´¥:",e.t0),this.$message.error("è·å–å·¥åºç‰©æ–™å¤±è´¥"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 38:e.next=47;break;case 40:e.prev=40,e.t1=e.catch(0),console.error("è·å–å·¥åºç‰©æ–™å¤±è´¥:",e.t1),this.$message.error(e.t1.message||"è·å–å·¥åºç‰©æ–™å¤±è´¥"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 47:case"end":return e.stop()}}),e,this,[[0,40],[24,31]])})));return function(){return e.apply(this,arguments)}}(),validateDICode:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a,n,i,o;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(c.b)("productDiNum",{query:{diNum:t},populate:JSON.stringify([{path:"productId",model:"k3_BD_MATERIAL"}])});case 3:if(0!==(a=e.sent).data.length){e.next=7;break}return this.$message.error("è¯¥DIç¼–ç ä¸å­˜åœ¨æœ¬ç³»ç»Ÿ"),e.abrupt("return",{isValid:!1});case 7:if(n=a.data.filter((function(e){return e.productId&&e.productId.FNumber})).map((function(e){return e.productId.FNumber})),0!==n.length){e.next=11;break}return this.$message.error("è¯¥DIç¼–ç æœªå…³è”æœ‰æ•ˆç‰©æ–™"),e.abrupt("return",{isValid:!1});case 11:if(i=[this.mainMaterialCode].concat(Object(r.a)(this.processMaterials.map((function(e){return e.materialCode})))),o=n.find((function(e){return i.includes(e)})),o){e.next=16;break}return this.$message.error("è¯¥DIç¼–ç å¯¹åº”çš„ç‰©æ–™ä¸å½“å‰å·¥åºä¸åŒ¹é…"),e.abrupt("return",{isValid:!1});case 16:return e.abrupt("return",{isValid:!0,materialCode:o});case 19:return e.prev=19,e.t0=e.catch(0),console.error("DIç éªŒè¯å¤±è´¥:",e.t0),this.$message.error("DIç éªŒè¯å¤±è´¥"),e.abrupt("return",{isValid:!1});case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),validateBarcode:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a,r,n,i,c,o,l,u,d,h,m,f,v,g,k,x,_,C,w;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("validateBarcode",t),t){e.next=3;break}return e.abrupt("return",!1);case 3:if(r="",n=!1,t.includes("#")&&(4===(i=t.split("#")).length&&(a=i[2],r=i[1],n=!0)),n||t.includes("-")&&34!=t.length&&35!=t.length&&(a=t.split("-")[0],r=t.split("-")[1],n=!0),n){e.next=18;break}if(!t.includes("(")){e.next=18;break}return c=t.substring(4,18),console.log("productDI",c),e.next=13,this.validateDICode(c);case 13:if((o=e.sent).isValid){e.next=16;break}return e.abrupt("return",!1);case 16:a=o.materialCode,n=!0;case 18:if(n){e.next=83;break}console.log("barcode",t.length),e.t0=t.length,e.next=35===e.t0?23:34===e.t0?33:48===e.t0?53:32===e.t0?62:20===e.t0?71:80;break;case 23:if(!t.includes("-")){e.next=32;break}return l=t.split("-")[1],console.log("middlePart",l),e.next=28,this.validateDICode(l);case 28:if((u=e.sent).isValid){e.next=31;break}return e.abrupt("return",!1);case 31:a=u.materialCode;case 32:return e.abrupt("break",83);case 33:if(!t.includes("-")){e.next=44;break}return d=t.substring(7,19),console.log("fanDI",d),e.next=38,this.validateDICode(d);case 38:if((h=e.sent).isValid){e.next=41;break}return e.abrupt("return",!1);case 41:a=h.materialCode,e.next=52;break;case 44:return m=t.substring(0,16),console.log("materialDI",m),e.next=48,this.validateDICode(m);case 48:if((f=e.sent).isValid){e.next=51;break}return e.abrupt("return",!1);case 51:a=f.materialCode;case 52:return e.abrupt("break",83);case 53:return v=t.substring(0,12),console.log("lightDI",v),e.next=57,this.validateDICode(v);case 57:if((g=e.sent).isValid){e.next=60;break}return e.abrupt("return",!1);case 60:return a=g.materialCode,e.abrupt("break",83);case 62:return k=t.substring(0,8),console.log("remoteDI",k),e.next=66,this.validateDICode(k);case 66:if((x=e.sent).isValid){e.next=69;break}return e.abrupt("return",!1);case 69:return a=x.materialCode,e.abrupt("break",83);case 71:return _=t.substring(0,11),console.log("batchDI",_),e.next=75,this.validateDICode(_);case 75:if((C=e.sent).isValid){e.next=78;break}return e.abrupt("return",!1);case 78:return a=C.materialCode,e.abrupt("break",83);case 80:return this.$message.error("æ¡ç æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºï¼šç‰©æ–™ç¼–å·-åºå·"),p(b.a),e.abrupt("return",!1);case 83:if(a!==this.mainMaterialCode){e.next=85;break}return e.abrupt("return",{materialCode:a,isValid:!0,relatedBill:r});case 85:if(w=this.processMaterials.find((function(e){return e.materialCode===a})),!w){e.next=88;break}return e.abrupt("return",{materialCode:a,isValid:!0,relatedBill:r});case 88:return this.$message.error("è¯¥æ¡ç å¯¹åº”çš„ç‰©æ–™ä¸å½“å‰å·¥åºæ‰€éœ€ç‰©æ–™ä¸åŒ¹é…"),e.abrupt("return",{materialCode:a,isValid:!1});case 90:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleMainBarcode:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(c.b)("material_process_flow",{query:{barcode:t}});case 3:if(!((a=e.sent).data&&a.data.length>0)){e.next=9;break}a.data[0],this.$message.success("æ‰«ææˆåŠŸ"),e.next=17;break;case 9:return e.next=11,Object(o.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:t,productLineId:this.productLineId,productLineName:this.productLineName});case 11:if(200!==(r=e.sent).code){e.next=16;break}this.$message.success("æˆå“æ¡ç è¿½æº¯è®°å½•åˆ›å»ºæˆåŠŸ"),e.next=17;break;case 16:throw new Error(r.msg||"åˆ›å»ºæˆå“æ¡ç è¿½æº¯è®°å½•å¤±è´¥");case 17:e.next=24;break;case 19:throw e.prev=19,e.t0=e.catch(0),console.error("å¤„ç†ä¸»æ¡ç å¤±è´¥:",e.t0),p(b.a),e.t0;case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),handleSubBarcode:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t,a){var r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=this.processMaterials.find((function(e){return e._id===t})),r){e.next=4;break}throw new Error("æœªæ‰¾åˆ°å¯¹åº”çš„ç‰©æ–™ä¿¡æ¯");case 4:if(r.materialCode===a){e.next=6;break}throw new Error("ç‰©æ–™ç¼–ç ä¸ä¸€è‡´");case 6:this.validateStatus[t]=!0,this.$message.success("æ‰«ç æˆåŠŸ"),e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),console.error("å¤„ç†å­ç‰©æ–™æ¡ç å¤±è´¥:",e.t0),p(b.a),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t,a){return e.apply(this,arguments)}}(),fillFormData:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.mainMaterialId&&this.materialName&&(this.formData.productName=this.materialName),this.processStepId&&this.processName&&(this.formData.processStep=this.processName),this.productLineId&&this.productLineName&&(this.formData.productLine=this.productLineId,this.formData.lineName=this.productLineName);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),resetScanForm:function(){var e=this;this.scanForm.mainBarcode="";var t={};this.processMaterials.forEach((function(a){if(a.isBatch){var r="batch_".concat(e.mainMaterialId,"_").concat(e.processStepId,"_").concat(a._id),n=localStorage.getItem(r);n?(t[a._id]=n,e.$set(e.validateStatus,a._id,!0)):(t[a._id]="",e.$set(e.validateStatus,a._id,!1))}else t[a._id]="",e.$set(e.validateStatus,a._id,!1)})),this.scanForm.barcodes=t,this.$set(this.validateStatus,"mainBarcode",!1),this.currentFlowId=null},handleUnifiedScan:function(){var e=Object(i.a)(Object(s.a)().mark((function e(t){var a=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:this.scanTimer&&clearTimeout(this.scanTimer),this.scanTimer=setTimeout(Object(i.a)(Object(s.a)().mark((function e(){var r,i,c,o,l,u,d,h,f,v;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=t.trim().replace(/[\r\n]/g,"")){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,a.validateBarcode(r);case 6:if((i=e.sent).isValid){e.next=13;break}return setTimeout((function(){p(b.a)}),300),a.$notify({title:"æ¡ç éªŒè¯å¤±è´¥",message:"æ¡ç æ ¼å¼ä¸æ­£ç¡®,æœªåœ¨ç³»ç»Ÿä¸­æ³¨å†Œ",type:"error",duration:3e3,position:"top-right"}),a.unifiedScanInput="",a.$refs.scanInput.focus(),e.abrupt("return");case 13:if(c=i.materialCode,o=!1,c!==a.mainMaterialCode){e.next=23;break}return a.scanForm.mainBarcode=t,a.validateStatus.mainBarcode=!0,e.next=20,a.handleMainBarcode(t);case 20:p(m.a),a.$notify({title:"ä¸»ç‰©æ–™æ‰«ææˆåŠŸ",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>ç‰©æ–™åç§°: '.concat(a.mainMaterialName,"</div>\n                                    <div>ç‰©æ–™ç¼–ç : ").concat(c,"</div>\n                                    <div>æ¡ç : ").concat(t,"</div>\n                                </div>\n                            "),type:"success",duration:3e3,position:"top-right"}),o=!0;case 23:if(o){e.next=49;break}l=Object(n.a)(a.processMaterials),e.prev=25,l.s();case 27:if((u=l.n()).done){e.next=41;break}if((d=u.value).materialCode!==c){e.next=39;break}return a.$set(a.scanForm.barcodes,d._id,t),a.$set(a.validateStatus,d._id,!0),d.isBatch&&(h="batch_".concat(a.mainMaterialId,"_").concat(a.processStepId,"_").concat(d._id),localStorage.setItem(h,t)),e.next=35,a.handleSubBarcode(d._id,c);case 35:return p(m.a),a.$notify({title:"å­ç‰©æ–™æ‰«ææˆåŠŸ",dangerouslyUseHTMLString:!0,message:'\n                                        <div style="line-height: 1.5">\n                                            <div>ç‰©æ–™åç§°: '.concat(d.materialName,"</div>\n                                            <div>ç‰©æ–™ç¼–ç : ").concat(d.materialCode,"</div>\n                                            <div>æ¡ç : ").concat(t,"</div>\n                                            ").concat(i.relatedBill?"<div>å…³è”å•å·: ".concat(i.relatedBill,"</div>"):"","\n                                        </div>\n                                    "),type:"success",duration:3e3,position:"top-right"}),o=!0,e.abrupt("break",41);case 39:e.next=27;break;case 41:e.next=46;break;case 43:e.prev=43,e.t0=e.catch(25),l.e(e.t0);case 46:return e.prev=46,l.f(),e.finish(46);case 49:if(f=Object.values(a.validateStatus).every((function(e){return!0===e})),!f){e.next=56;break}return a.$notify({title:"æ‰«æå®Œæˆ",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>æ‰€æœ‰ç‰©æ–™å·²æ‰«æå®Œæˆ</div>\n                                    <div style="color: #67C23A">æ­£åœ¨å‘é€ç¡®è®¤æäº¤...</div>\n                                </div>\n                            ',type:"success",duration:3e3,position:"top-right"}),e.next=54,a.handleConfirm();case 54:e.next=58;break;case 56:v=a.processMaterials.filter((function(e){return!a.validateStatus[e._id]})).map((function(e){return"".concat(e.materialName,"(").concat(e.materialCode,")")})).join("\n"),v&&a.$notify({title:"ç»§ç»­æ‰«æ",dangerouslyUseHTMLString:!0,message:'\n                                    <div style="line-height: 1.5">\n                                        <div>è¯·ç»§ç»­æ‰«æä»¥ä¸‹ç‰©æ–™ï¼š</div>\n                                        <div style="color: #E6A23C; white-space: pre-line">'.concat(v,"</div>\n                                    </div>\n                                "),type:"info",duration:3e3,position:"top-right"});case 58:e.next=65;break;case 60:e.prev=60,e.t1=e.catch(0),console.error("æ‰«æå¤„ç†å¤±è´¥:",e.t1),setTimeout((function(){p(b.a)}),1e3),a.$notify({title:"æ‰«æå¤±è´¥",message:e.t1.message||"æ‰«æå¤„ç†å¤±è´¥",type:"error",duration:3e3,position:"top-right"});case 65:return e.prev=65,a.unifiedScanInput="",a.$refs.scanInput.focus(),e.finish(65);case 69:case"end":return e.stop()}}),e,null,[[0,60,65,69],[25,43,46,49]])}))),1e3);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),focusInput:function(){this.$refs.scanInput.focus()},handleCancelSave:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("ç¡®è®¤å–æ¶ˆå½“å‰å·¥åºè®¾ç½®ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ‰¹æ¬¡ç‰©æ–™çš„ç¼“å­˜æ•°æ®ã€‚","æç¤º",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"});case 3:t=this.$loading({lock:!0,text:"å–æ¶ˆè®¾ç½®ä¸­...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),localStorage.removeItem("mainMaterialId"),localStorage.removeItem("processStepId"),localStorage.removeItem("materialName"),localStorage.removeItem("processName"),a=this.formData.productLine,r=this.formData.lineName,this.formData={productModel:"",productLine:a,lineName:r,processStep:"",componentName:""},this.$message.success("å·²å–æ¶ˆå·¥åºè®¾ç½®"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("å–æ¶ˆè®¾ç½®å¤±è´¥:",e.t0),this.$message.error("å–æ¶ˆè®¾ç½®å¤±è´¥"));case 20:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),getValidateIcon:function(e){return this.validateStatus[e]?"el-icon-check success-icon":"el-icon-close error-icon"},handleConfirm:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a,r,n,i,l,u,d=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=Object.values(this.validateStatus).every((function(e){return!0===e})),t){e.next=5;break}return this.$message.warning("è¯·å®Œæˆæ‰€æœ‰æ¡ç æ‰«æ"),e.abrupt("return");case 5:return e.next=7,Object(c.b)("material_process_flow",{query:{barcode:this.scanForm.mainBarcode}});case 7:if((r=e.sent).data&&0!==r.data.length){e.next=23;break}return e.prev=9,e.next=12,Object(o.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:this.scanForm.mainBarcode,productLineId:this.productLineId,productLineName:this.productLineName});case 12:if(200===(n=e.sent).code){e.next=15;break}throw new Error("åˆ›å»ºä¸»æµç¨‹è®°å½•å¤±è´¥");case 15:a=n.data,e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(9),new Error("åˆ›å»ºæµç¨‹è®°å½•å¤±è´¥: ".concat(e.t0.message));case 21:e.next=24;break;case 23:a=r.data[0];case 24:if(a){e.next=26;break}throw new Error("æœªèƒ½è·å–æˆ–åˆ›å»ºæœ‰æ•ˆçš„å·¥è‰ºæµç¨‹è®°å½•");case 26:return i=[],this.processMaterials.forEach((function(e){i.push({materialId:e.materialId,barcode:d.scanForm.barcodes[e._id]})})),console.log("ğŸš€ ~ handleConfirm ~ componentScans:",i),l={mainBarcode:this.scanForm.mainBarcode,processStepId:this.processStepId,componentScans:i,userId:this.$store.getters.id},console.log("ğŸš€ ~ handleConfirm ~ scanReq:",l),e.next=33,Object(o.b)(l);case 33:if(200===(u=e.sent).code){e.next=36;break}throw new Error(u.message||"æ‰«ç å¤±è´¥");case 36:200==u.code&&setTimeout((function(){p(g.a)}),1e3),this.resetScanForm(),e.next=45;break;case 40:e.prev=40,e.t1=e.catch(0),this.resetScanForm(),console.error("ç¡®è®¤å¤±è´¥:",e.t1),e.t1.message.includes("è¯¥ä¸»ç‰©æ–™æ¡ç å¯¹åº”å·¥åºèŠ‚ç‚¹å·²å®Œæˆæˆ–å¤„äºå¼‚å¸¸çŠ¶æ€")?(this.$message.warning(e.t1.message),setTimeout((function(){p(x.a)}),1e3)):(this.$message.error("ç¡®è®¤å¤±è´¥:"+e.t1.message),setTimeout((function(){p(b.a)}),1e3));case 45:case"end":return e.stop()}}),e,this,[[0,40],[9,18]])})));return function(){return e.apply(this,arguments)}}(),handlePrintSuccess:function(){this.$message.success("æ‰¹æ¬¡æ¡ç æ‰“å°æˆåŠŸ"),this.currentBatchBarcode=""},handlePrintError:function(e){this.$message.error("æ‰“å°å¤±è´¥: ".concat(e)),this.currentBatchBarcode=""},handleDialogClose:function(){this.printDialogVisible=!1,this.currentBatchBarcode=""},handleAutoPrintChange:function(e){localStorage.setItem("autoPrint",e),this.$message.success("å·²".concat(e?"å¼€å¯":"å…³é—­","è‡ªåŠ¨æ‰“å°æ¨¡å¼"))},handleClearCache:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("ç¡®è®¤æ¸…é™¤æ‰€æœ‰é¡µé¢ç¼“å­˜æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚","æç¤º",{confirmButtonText:"ç¡®å®š",cancelButtonText:"å–æ¶ˆ",type:"warning"});case 3:t=this.$loading({lock:!0,text:"æ¸…é™¤ç¼“å­˜ä¸­...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),this.$message.success("ç¼“å­˜æ¸…é™¤æˆåŠŸ"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("æ¸…é™¤ç¼“å­˜å¤±è´¥:",e.t0),this.$message.error("æ¸…é™¤ç¼“å­˜å¤±è´¥"));case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),toggleCollapse:function(){this.isCollapsed=!this.isCollapsed}},created:function(){var e=Object(i.a)(Object(s.a)().mark((function e(){var t,a=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.mainMaterialId){e.next=3;break}return e.next=3,this.getMainMaterialInfo();case 3:if(!this.processStepId){e.next=7;break}return e.next=6,this.getProcessMaterials();case 6:this.processMaterials.forEach((function(e){if(e.isBatch){var t="batch_".concat(a.mainMaterialId,"_").concat(a.processStepId,"_").concat(e._id),r=localStorage.getItem(t);r&&(a.$set(a.scanForm.barcodes,e._id,r),a.$set(a.validateStatus,e._id,!0))}}));case 7:return e.next=9,this.fillFormData();case 9:null!==(t=localStorage.getItem("autoPrint"))&&(this.autoPrint="true"===t);case 11:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),mounted:function(){console.log("ğŸš€ ~ mounted ~ this.$store.getters.id:",this.$store.getters),this.mainMaterialId&&this.processStepId&&this.$refs.scanInput.focus(),console.log("Complete roles data:",this.$store.getters.roles);var e=this.$store.getters.roles;if(!e||!e.buttonList)return!1;e.buttonList.includes("scan_edit_configuration")&&(this.hasEditPermission=!0)},beforeDestroy:function(){this.scanTimer&&clearTimeout(this.scanTimer)}},j=O,M=(a("0dfe"),Object(w.a)(j,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"scan-container"},[a("div",{staticClass:"left-form",class:{collapsed:e.isCollapsed}},[a("el-card",{staticClass:"init-card"},[a("div",{staticClass:"card-header"},[a("i",{staticClass:"el-icon-setting"}),e._v(" "),a("span",[e._v("å·¥åºåˆå§‹åŒ–è®¾ç½®")])]),e._v(" "),a("el-form",{attrs:{model:e.formData,"label-width":"100px"}},[a("div",{staticClass:"form-section"},[a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-goods"}),e._v(" "),a("span",[e._v("åŸºç¡€ä¿¡æ¯")])]),e._v(" "),a("el-form-item",{attrs:{label:"äº§å“å‹å·"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"è¯·è¾“å…¥ç‰©æ–™ç¼–ç /åç§°æœç´¢",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.productName,callback:function(t){e.$set(e.formData,"productName",t)},expression:"formData.productName"}}):a("zr-select",{attrs:{collection:"k3_BD_MATERIAL",disabled:!!e.mainMaterialId&&!!e.processStepId,"search-fields":["FNumber","FName"],"label-key":"FName","sub-key":"FMATERIALID",multiple:!1,placeholder:"è¯·è¾“å…¥ç‰©æ–™ç¼–ç /åç§°æœç´¢"},on:{select:e.handleProductChange},scopedSlots:e._u([{key:"option",fn:function(t){var r=t.item;return[a("div",{staticClass:"item-option"},[a("div",{staticClass:"item-info"},[a("span",[e._v(e._s(r.FNumber)+" - "+e._s(r.FName))]),e._v(" "),a("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(e._s(r.FMATERIALID)+" -"+e._s(r.FUseOrgId))])],1)])]}}],null,!1,1794309911),model:{value:e.formData.productModel,callback:function(t){e.$set(e.formData,"productModel",t)},expression:"formData.productModel"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"äº§å“å·¥åº"}},[a("el-select",{staticClass:"custom-select",attrs:{placeholder:"è¯·é€‰æ‹©äº§å“å·¥åº",disabled:!!e.mainMaterialId&&!!e.processStepId},on:{change:e.handleProcessChange},model:{value:e.formData.processStep,callback:function(t){e.$set(e.formData,"processStep",t)},expression:"formData.processStep"}},e._l(e.processStepOptions,(function(t){return a("el-option",{key:t._id,attrs:{label:t.processName,value:t._id}},[a("div",{staticClass:"option-content"},[a("span",{staticClass:"option-main"},[e._v(e._s(""+(t.levelPrefix||"")+t.sort+"."+t.processName))]),e._v(" "),a("span",{staticClass:"option-sub"},[e._v(e._s(t.processCode))])])])})),1)],1),e._v(" "),a("el-form-item",{attrs:{label:"äº§çº¿ç¼–ç "}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"è¯·è¾“å…¥äº§çº¿ä¿¡æ¯æœç´¢",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.lineName,callback:function(t){e.$set(e.formData,"lineName",t)},expression:"formData.lineName"}}):a("zr-select",{attrs:{disabled:!!e.mainMaterialId&&!!e.processStepId,collection:"production_line","search-fields":["lineCode","lineName"],"label-key":"lineName","tag-key":"lineCode","sub-key":"workshop",multiple:!1,placeholder:"è¯·è¾“å…¥äº§çº¿ä¿¡æ¯æœç´¢"},on:{select:e.handleProductionLineSelect},model:{value:e.formData.productLine,callback:function(t){e.$set(e.formData,"productLine",t)},expression:"formData.productLine"}})],1)],1),e._v(" "),e.hasEditPermission?a("div",{staticClass:"button-group"},[e.mainMaterialId&&e.processStepId?a("el-button",{attrs:{type:"danger",icon:"el-icon-close"},on:{click:e.handleCancelSave}},[e._v("\n                        å–æ¶ˆè®¾ç½®\n                    ")]):a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleSave}},[e._v("\n                        ä¿å­˜è®¾ç½®\n                    ")])],1):e._e()])],1)],1),e._v(" "),a("div",{staticClass:"right-content"},[e.mainMaterialId&&e.processStepId?[a("el-card",{staticClass:"scan-card"},[a("div",{staticClass:"card-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-scan"}),e._v(" "),a("span",[e._v("æ¡ç æ‰«æ")]),e._v(" "),a("el-button",{attrs:{type:"text"},on:{click:e.toggleCollapse}},[a("i",{class:e.isCollapsed?"el-icon-d-arrow-right":"el-icon-d-arrow-left"}),e._v("\n                            "+e._s(e.isCollapsed?"å±•å¼€":"æ”¶èµ·")+"\n                        ")])],1),e._v(" "),a("el-button",{attrs:{type:"text",icon:"el-icon-delete"},on:{click:e.handleClearCache}},[e._v("\n                        æ¸…é™¤æ‰¹æ¬¡ç‰©æ–™ç¼“å­˜\n                    ")])],1),e._v(" "),a("el-form",{ref:"scanForm",attrs:{model:e.scanForm,"label-width":"100%"}},[a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-camera"}),e._v(" "),a("span",[e._v("ç»Ÿä¸€æ‰«æåŒºåŸŸ")])]),e._v(" "),a("div",{staticClass:"scan-input-section"},[a("el-input",{ref:"scanInput",attrs:{placeholder:"è¯·æ‰«ææ¡ç ",clearable:""},on:{input:e.handleUnifiedScan,clear:e.focusInput},model:{value:e.unifiedScanInput,callback:function(t){e.unifiedScanInput=t},expression:"unifiedScanInput"}})],1),e._v(" "),a("div",{staticClass:"section-header"},[a("div",{staticClass:"section-title"},[a("i",{staticClass:"el-icon-goods"}),e._v(" "),a("span",[e._v("ä¸»ç‰©æ–™")])]),e._v(" "),a("div",{staticClass:"print-batch-btn"},[a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"è‡ªåŠ¨","inactive-text":"æ‰‹åŠ¨"},on:{change:e.handleAutoPrintChange},model:{value:e.autoPrint,callback:function(t){e.autoPrint=t},expression:"autoPrint"}}),e._v(" "),a("el-button",{staticClass:"print-batch-btn",attrs:{type:"primary",size:"mini"},on:{click:e.handlePrintBatch}},[e._v("\n                                æ‰“å°\n                            ")])],1)]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"ç¼–å·ï¼š"+e.mainMaterialCode+"  åç§°ï¼š"+e.mainMaterialName,"label-width":"100%"}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus.mainBarcode},attrs:{placeholder:"è¯·æ‰«æä¸»ç‰©æ–™æ¡ç ",readonly:""},model:{value:e.scanForm.mainBarcode,callback:function(t){e.$set(e.scanForm,"mainBarcode",t)},expression:"scanForm.mainBarcode"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})])],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus.mainBarcode}},[a("i",{class:e.getValidateIcon("mainBarcode")})])],1)])],1),e._v(" "),a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-box"}),e._v(" "),a("span",[e._v("å­ç‰©æ–™")])]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-row",{attrs:{gutter:20}},e._l(e.processMaterials,(function(t){return a("el-col",{key:t._id,attrs:{span:12}},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"ç¼–å·ï¼š"+t.materialCode+"  åç§°ï¼š"+t.materialName+"  "}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus[t._id]},attrs:{placeholder:"è¯·æ‰«æå­ç‰©æ–™æ¡ç ",readonly:""},model:{value:e.scanForm.barcodes[t._id],callback:function(a){e.$set(e.scanForm.barcodes,t._id,a)},expression:"scanForm.barcodes[material._id]"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})]),e._v(" "),t.isBatch?a("template",{slot:"suffix"},[a("el-tag",{attrs:{type:"warning"}},[e._v("æ‰¹æ¬¡ç‰©æ–™")])],1):e._e()],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus[t._id]}},[a("i",{class:e.getValidateIcon(t._id)})])],1)])],1)})),1)],1),e._v(" "),a("div",{staticClass:"button-group"},[a("el-button",{attrs:{plain:"",icon:"el-icon-refresh"},on:{click:e.resetScanForm}},[e._v("é‡ç½®")]),e._v(" "),a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleConfirm}},[e._v("ç¡®è®¤")])],1)])],1)]:[e._m(0)]],2),e._v(" "),a("tsc-printer",{ref:"tscPrinter",attrs:{materialCode:e.mainMaterialCode,barcode:e.currentBatchBarcode}})],1)}),[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"init-tip"},[a("div",{staticClass:"overlay"},[a("i",{staticClass:"el-icon-warning-outline pulse"}),e._v(" "),a("p",[e._v("è¯·å…ˆåˆå§‹åŒ–å·¥åºè®¾ç½®")])])])}],!1,null,"2e1cb9c0",null));t.default=M.exports}}]);