# 镭雕设备接口对接文档

## 概述

本文档描述了镭雕设备与MES系统对接的两个核心接口，用于实现条码数据获取和使用状态确认的完整流程。

## 接口列表

### 1. 获取打印条码数据接口

#### 接口信息
- **接口地址**: `/api/v1/get-laser-print-barcode`
- **请求方式**: `POST`
- **接口描述**: 镭雕设备根据自身IP地址获取下一个可用的产品条码数据，用于打印镭雕

#### 请求参数

| 参数名 | 类型 | 是否必填 | 描述 |
|--------|------|----------|------|
| machineIp | string | 是 | 镭雕设备的IP地址 |

#### 请求示例
```json
{
  "machineIp": "192.168.1.100"
}
```

#### 返回参数

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | number | 响应状态码，200表示成功 |
| success | boolean | 请求是否成功 |
| message | string | 响应消息 |
| data | object | 条码数据对象 |

#### data对象结构

| 参数名 | 类型 | 描述 |
|--------|------|------|
| id | string | 条码记录ID |
| barcode | string | 生产条码（基础条码） |
| printBarcode | string | 基础打印条码 |
| transformedBarcode | string | 转换后的条码 |
| transformedPrintBarcode | string | 转换后的打印条码 |
| serialNumber | number | 序列号 |
| segmentBreakdown | object | 段落明细 |
| ruleName | string | 条码规则名称 |
| ruleCode | string | 条码规则编码 |

#### 成功响应示例
```json
{
  "code": 200,
  "success": true,
  "message": "获取打印条码数据成功",
  "data": {
    "id": "64f7c8a9b1234567890abcde",
    "barcode": "ABC123456789",
    "printBarcode": "ABC123456789",
    "transformedBarcode": "ABC123456789DEF",
    "transformedPrintBarcode": "ABC123456789DEF",
    "serialNumber": 1,
    "segmentBreakdown": {
      "prefix": "ABC",
      "serialNumber": "123456789",
      "suffix": "DEF"
    },
    "ruleName": "产品条码规则",
    "ruleCode": "PRODUCT_BARCODE_RULE_001"
  }
}
```

#### 错误响应示例
```json
{
  "code": 500,
  "success": false,
  "message": "未找到可用的预生产条码",
  "errorCode": "LINE-G-002"
}
```

#### 错误码说明

| 错误码 | 错误消息 | 描述 |
|--------|----------|------|
| LINE-G-001 | 缺少必要参数：设备IP地址 | 请求参数中缺少machineIp |
| LINE-H-002 | 未找到对应的设备信息 | 根据IP地址未找到设备记录 |
| LINE-H-003 | 未找到设备对应的产线信息 | 设备未绑定产线 |
| LINE-F-004 | 未找到产线对应的正在生产工单 | 产线没有正在进行的生产工单 |
| LINE-G-002 | 未找到可用的预生产条码 | 工单下没有可用的待使用条码 |

---

### 2. 确认使用条码接口

#### 接口信息
- **接口地址**: `/api/v1/confirm-laser-barcode-used`
- **请求方式**: `POST`
- **接口描述**: 镭雕设备完成打印后，确认条码已被使用，系统更新条码状态并完成工序绑定

#### 请求参数

| 参数名 | 类型 | 是否必填 | 描述 |
|--------|------|----------|------|
| barcodeId | string | 是 | 条码记录ID（从获取接口返回的id） |
| machineIp | string | 是 | 镭雕设备的IP地址 |
| userId | string | 否 | 操作用户ID，为空时使用默认值 |

#### 请求示例
```json
{
  "barcodeId": "64f7c8a9b1234567890abcde",
  "machineIp": "192.168.1.100",
  "userId": "user001"
}
```

#### 返回参数

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | number | 响应状态码，200表示成功 |
| success | boolean | 请求是否成功 |
| message | string | 响应消息 |
| data | object | 操作结果数据 |

#### data对象结构

| 参数名 | 类型 | 描述 |
|--------|------|------|
| barcodeId | string | 条码记录ID |
| barcode | string | 条码值 |
| status | string | 条码状态（USED表示已使用） |
| usedAt | string | 使用时间 |
| flowRecordId | string | 流程记录ID |
| processStepId | string | 工序ID |
| processStepName | string | 工序名称 |
| bindResult | object | 工序绑定结果 |

#### 成功响应示例
```json
{
  "code": 200,
  "success": true,
  "message": "条码使用状态更新成功，并已完成工序绑定",
  "data": {
    "barcodeId": "64f7c8a9b1234567890abcde",
    "barcode": "ABC123456789",
    "status": "USED",
    "usedAt": "2024-01-15T10:30:00.000Z",
    "flowRecordId": "64f7c8a9b1234567890abcdf",
    "processStepId": "64f7c8a9b1234567890abce0",
    "processStepName": "镭雕工序",
    "bindResult": {
      "success": true,
      "message": "工序绑定成功"
    }
  }
}
```

#### 错误响应示例
```json
{
  "code": 500,
  "success": false,
  "message": "未找到指定的条码记录",
  "errorCode": "LINE-G-002"
}
```

#### 错误码说明

| 错误码 | 错误消息 | 描述 |
|--------|----------|------|
| LINE-G-001 | 缺少必要参数：条码ID和设备IP | 请求参数不完整 |
| LINE-G-002 | 未找到指定的条码记录 | 条码ID不存在 |
| LINE-H-002 | 未找到对应的设备信息 | 设备IP对应的设备不存在 |

---

## 对接流程说明

### 标准对接流程

1. **获取条码数据**
   - 镭雕设备调用 `/api/v1/get-laser-print-barcode` 接口
   - 传入设备IP地址
   - 获取待打印的条码数据

2. **执行镭雕打印**
   - 设备使用返回的条码数据进行镭雕打印
   - 可使用 `printBarcode` 或 `transformedPrintBarcode` 字段

3. **确认使用状态**
   - 打印完成后，调用 `/api/v1/confirm-laser-barcode-used` 接口
   - 传入条码ID和设备IP
   - 系统更新条码状态并完成工序绑定

### 异常处理

1. **条码获取失败**
   - 检查设备IP配置是否正确
   - 确认设备已绑定到产线
   - 确认产线有正在进行的工单
   - 确认工单下有可用的预生产条码

2. **确认使用失败**
   - 检查条码ID是否正确
   - 确认条码状态未被重复使用
   - 检查设备与工序的绑定关系

### 注意事项

1. **接口调用顺序**: 必须先调用获取接口，再调用确认接口
2. **条码唯一性**: 每个条码只能使用一次，使用后状态变为USED
3. **工序绑定**: 确认使用时会自动完成对应工序的绑定
4. **错误重试**: 建议在网络异常时进行适当的重试机制
5. **日志记录**: 建议记录接口调用日志，便于问题排查

## 联系方式

如有技术问题，请联系MES系统开发团队。 