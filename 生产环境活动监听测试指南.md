# 生产环境活动监听测试指南

## 概述

本指南详细说明如何在生产环境中安全测试用户活动监听和定时过期功能，确保15分钟无活动自动退出功能正常工作。

## 测试工具介绍

系统提供了专门的生产环境测试工具 `window.productionActivityTest`，该工具在页面加载后自动可用。

### 主要特性

- ✅ **安全测试**：提供自动恢复机制，避免影响正常使用
- ✅ **多种方案**：支持快速测试、模拟测试、监控模式
- ✅ **详细日志**：提供完整的状态报告和测试日志
- ✅ **生产友好**：专为生产环境设计，最小化业务影响

## 测试方案

### 方案一：快速超时测试（推荐）

**适用场景**：需要快速验证过期功能，不想等待15分钟

**操作步骤**：

1. **打开浏览器控制台**（F12 → Console）

2. **检查当前状态**：
   ```javascript
   window.productionActivityTest.status()
   ```

3. **开始快速测试**（2分钟超时）：
   ```javascript
   window.productionActivityTest.quickTest(2)
   ```

4. **观察测试过程**：
   - 1分钟后：应显示警告提示
   - 2分钟后：应自动退出到登录页

5. **恢复原始配置**：
   ```javascript
   window.productionActivityTest.restore()
   ```

**预期结果**：
- ⏰ 1分钟时显示：`【测试模式】您已经1分钟没有操作了，系统将在1分钟后自动退出`
- 🚪 2分钟时自动跳转到登录页面
- 📝 控制台显示详细的测试日志

### 方案二：模拟长时间无活动

**适用场景**：测试系统对历史无活动状态的检测

**操作步骤**：

1. **模拟16分钟前的活动**：
   ```javascript
   window.productionActivityTest.simulate(16)
   ```

2. **观察系统反应**：
   - 系统应立即检测到会话过期
   - 应显示过期提示或自动退出

3. **重置活动时间**：
   ```javascript
   // 如果需要恢复正常状态
   window.productionActivityTest.simulate(16).reset()
   ```

### 方案三：监控模式

**适用场景**：长期观察系统状态，不修改配置

**操作步骤**：

1. **开始监控**（每30秒检查一次）：
   ```javascript
   window.productionActivityTest.monitor(30)
   ```

2. **观察监控日志**：
   - 系统会定期输出状态信息
   - 包括剩余时间、会话状态等

3. **停止监控**：
   ```javascript
   window.productionActivityTest.stopMonitor()
   ```

## 详细测试流程

### 完整测试流程

```javascript
// 1. 检查初始状态
console.log('=== 开始生产环境活动监听测试 ===')
window.productionActivityTest.status()

// 2. 开始快速测试（3分钟）
const testResult = window.productionActivityTest.quickTest(3)
console.log('测试配置:', testResult)

// 3. 等待测试完成后恢复
// 注意：测试会自动恢复，也可以手动恢复
// window.productionActivityTest.restore()

// 4. 验证恢复状态
setTimeout(() => {
  console.log('=== 测试完成，检查恢复状态 ===')
  window.productionActivityTest.status()
}, (3 + 1) * 60 * 1000) // 测试时间 + 1分钟缓冲
```

### 测试检查点

#### 1. 警告阶段检查
- **时间点**：警告时间到达时
- **预期行为**：显示警告弹窗或消息
- **检查方法**：观察页面是否出现警告提示

#### 2. 过期阶段检查
- **时间点**：会话超时时间到达时
- **预期行为**：自动跳转到登录页面
- **检查方法**：确认页面URL变为登录页

#### 3. 拦截功能检查
- **测试方法**：在会话过期后尝试访问其他页面
- **预期行为**：应被拦截并跳转到登录页
- **检查方法**：手动输入其他页面URL

## 常用测试命令

### 基础命令

```javascript
// 快速状态检查
window.productionActivityTest.status()

// 2分钟快速测试
window.productionActivityTest.quickTest(2)

// 模拟15分钟前活动
window.productionActivityTest.simulate(15)

// 开始监控（每60秒）
window.productionActivityTest.monitor(60)

// 恢复原始配置
window.productionActivityTest.restore()

// 清理所有测试状态
window.productionActivityTest.cleanup()
```

### 高级命令

```javascript
// 获取详细报告（不打印到控制台）
const report = window.productionActivityTest.report()
console.log(report)

// 自定义时间测试
window.productionActivityTest.quickTest(5) // 5分钟测试

// 高频监控
window.productionActivityTest.monitor(10) // 每10秒检查

// 模拟不同时间点
window.productionActivityTest.simulate(20) // 20分钟前
```

## 测试注意事项

### ⚠️ 重要提醒

1. **测试时机**：
   - 建议在业务低峰期进行测试
   - 避免在关键业务操作期间测试

2. **测试范围**：
   - 每次只在一个浏览器标签页测试
   - 不要同时在多个标签页进行测试

3. **恢复机制**：
   - 快速测试有自动恢复机制
   - 建议测试完成后手动执行恢复命令

4. **数据安全**：
   - 测试不会影响业务数据
   - 只修改前端配置，不涉及后端

### 🚨 故障排除

#### 问题1：测试工具不可用
```javascript
// 检查工具是否加载
if (typeof window.productionActivityTest === 'undefined') {
  console.error('测试工具未加载，请刷新页面重试')
} else {
  console.log('测试工具已就绪')
}
```

#### 问题2：测试没有按预期工作
```javascript
// 检查活动监听状态
window.productionActivityTest.status()

// 检查是否有其他活动重置了计时器
window.activityQuickTest?.monitorEvents(30000) // 监控30秒
```

#### 问题3：无法恢复原始配置
```javascript
// 强制清理并重新加载页面
window.productionActivityTest.cleanup()
location.reload()
```

## 测试结果判断

### ✅ 测试通过标准

1. **警告功能**：
   - 在设定的警告时间显示警告消息
   - 警告消息内容正确
   - 用户操作后警告消失

2. **过期功能**：
   - 在设定的超时时间自动退出
   - 跳转到登录页面
   - 清理用户会话状态

3. **拦截功能**：
   - 过期后拦截路由跳转
   - 过期后拦截API请求
   - 强制用户重新登录

4. **恢复功能**：
   - 用户操作后正常重置计时器
   - 页面刷新后正常恢复监听
   - 登录后正常启动监听

### ❌ 常见问题

1. **计时器被频繁重置**：
   - 检查是否有自动化脚本或插件在后台运行
   - 使用事件监控功能检查异常事件

2. **警告不显示**：
   - 检查弹窗是否被浏览器拦截
   - 检查控制台是否有错误信息

3. **不会自动退出**：
   - 检查路由拦截配置
   - 检查是否有其他代码阻止了跳转

## 生产环境部署检查

### 部署前检查

```javascript
// 确认配置正确
window.activityConfig?.get()

// 确认功能启用
window.activityConfig?.isEnabled()

// 确认测试工具可用
typeof window.productionActivityTest !== 'undefined'
```

### 部署后验证

1. **功能验证**：使用快速测试验证基本功能
2. **性能验证**：使用监控模式检查性能影响
3. **兼容性验证**：在不同浏览器中测试

## 总结

通过以上测试方案，您可以在生产环境中安全、快速地验证用户活动监听功能。建议：

1. **首次部署**：使用完整测试流程验证所有功能
2. **日常维护**：使用快速测试定期检查功能状态
3. **问题排查**：使用监控模式和状态报告定位问题

如有任何问题，请查看控制台日志或联系技术支持。
