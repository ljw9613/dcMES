# 德昌MES增量备份系统使用说明

## 系统概述

增量备份系统是专门为德昌MES系统设计的智能数据备份解决方案，主要用于定时备份当天产生的数据，实现数据的增量保护和快速恢复。

### 主要特性

- **智能分类备份**: 根据数据重要性和访问频率，将集合分为热点、核心、配置、分析四个类别
- **多种备份策略**: 支持小时级、6小时级、日级等多种备份频率
- **自动时间过滤**: 专门备份当天数据，避免重复备份历史数据
- **并行备份**: 支持多集合并行备份，提高备份效率
- **智能清理**: 自动清理过期备份文件，节省存储空间
- **健康监控**: 实时监控备份状态，及时发现和处理异常
- **跨平台支持**: 同时支持Windows和Linux操作系统

## 系统架构

### 备份策略分类

| 策略类别 | 备份频率 | 保留时间 | 适用集合 |
|---------|---------|---------|---------|
| 热点集合 | 每小时 | 72小时 | api_logs, system_log, scanrecords 等高频数据 |
| 核心集合 | 每6小时 | 7天 | 生产计划、扫码记录、产品初始化等业务核心数据 |
| 配置集合 | 每天 | 30天 | 用户管理、权限配置、字典数据等配置信息 |
| 分析集合 | 每天 | 15天 | 统计报表、历史记录等分析数据 |

### 目录结构

```
D:/incrementalBackups/
├── hot/                    # 热点集合备份
├── core/                   # 核心集合备份
├── config/                 # 配置集合备份
├── analytics/              # 分析集合备份
└── logs/                   # 系统日志
    ├── incremental_backup.log
    ├── alerts.log
    └── manager_state.json
```

## 安装和配置

### 系统要求

- Node.js 14+ 
- MongoDB 4.0+
- MongoDB Database Tools (mongodump)
- PM2 (可选，用于服务管理)

### 安装步骤

1. **检查MongoDB工具**
   ```bash
   mongodump --version
   ```
   如果没有安装，系统会自动尝试安装或提供安装指导。

2. **安装Node.js依赖**
   ```bash
   npm install node-schedule
   npm install archiver  # 用于压缩（可选）
   ```

3. **配置PM2服务管理（推荐）**
   ```bash
   npm install -g pm2
   ```

### 配置说明

主要配置在 `incremental_backup_manager.js` 文件中：

```javascript
// 数据库连接配置
this.config = {
  host: '47.115.19.76',       // 数据库地址
  port: '27017',              // 数据库端口
  database: 'dcMes',          // 数据库名
  username: 'dcMes',          // 用户名
  password: 'dcMes123.',      // 密码
  authDatabase: 'dcMes'       // 认证数据库
};

// 备份路径配置
backupPath: 'D:/incrementalBackups',  // 可通过环境变量修改
```

## 使用方法

### Windows环境（推荐）

使用提供的批处理脚本：

```bash
# 启动定时备份服务
start_incremental_backup.bat start

# 立即执行一次备份
start_incremental_backup.bat once

# 查看服务状态
start_incremental_backup.bat status

# 停止服务
start_incremental_backup.bat stop

# 显示配置信息
start_incremental_backup.bat config
```

### 直接使用Node.js

```bash
# 启动定时备份服务
node incremental_backup_manager.js --start

# 执行一次性备份
node incremental_backup_manager.js --once  

# 查看服务状态
node incremental_backup_manager.js --status

# 显示配置信息
node incremental_backup_manager.js --config
```

### 使用PM2管理（生产环境推荐）

```bash
# 启动服务
pm2 start ecosystem.incremental.config.js

# 查看服务状态
pm2 list incremental-backup

# 查看日志
pm2 logs incremental-backup

# 停止服务
pm2 stop incremental-backup

# 重启服务  
pm2 restart incremental-backup

# 监控界面
pm2 monit
```

## 备份策略详解

### 1. 热点集合策略 (每小时备份)

适用于高频变化的数据：

- **api_logs**: API访问日志
- **system_log**: 系统运行日志  
- **scanrecords**: 扫码记录
- **equipmentinformations**: 设备信息
- **chat**: 聊天记录

**调度**: `0 */1 * * *` (每小时整点)
**保留**: 72小时（3天）
**时间字段**: createdAt

### 2. 核心集合策略 (每6小时备份)

适用于业务核心数据：

- **sampling_inspection_flows**: 抽检流程
- **scan_code_bind_record**: 扫码绑定记录
- **product_initialize_logs**: 产品初始化日志
- **production_plan_work_orders**: 生产计划工单

**调度**: `0 */6 * * *` (每6小时)
**保留**: 168小时（7天）  
**时间字段**: createdAt

### 3. 配置集合策略 (每日备份)

适用于配置管理数据：

- **barcodesegmentrules**: 条码段规则
- **user_logins**: 用户登录信息
- **roles**: 角色权限
- **dicttypes**: 字典类型

**调度**: `0 2 * * *` (每天凌晨2点)
**保留**: 30天
**时间字段**: updatedAt

### 4. 分析集合策略 (每日深夜备份)

适用于统计分析数据：

- **k3_sal_saleorderexts**: K3销售订单扩展
- **material_palletizing_error_logs**: 托盘化错误日志
- **inspection_data**: 检测数据

**调度**: `0 3 * * *` (每天凌晨3点)  
**保留**: 15天
**时间字段**: createdAt

## 监控和维护

### 健康检查

系统每5分钟自动执行健康检查：

- 检查各集合的备份失败次数
- 验证最后备份时间是否正常
- 监控磁盘空间使用情况
- 自动生成告警信息

### 日志管理

- **主日志**: `logs/incremental_backup.log` - 记录所有操作
- **告警日志**: `logs/alerts.log` - 记录告警信息  
- **PM2日志**: `logs/incremental-backup-*.log` - PM2服务日志

### 状态信息

查看详细状态信息：

```bash
node incremental_backup_manager.js --status
```

输出示例：
```json
{
  "isRunning": true,
  "uptime": 3600,
  "activeJobs": 0,
  "statistics": {
    "totalBackups": 156,
    "successCount": 154,
    "failureCount": 2,
    "successRate": "98.72%",
    "totalSizeMB": "1234.56"
  }
}
```

## 故障排除

### 常见问题

1. **mongodump命令不可用**
   - 检查MongoDB Database Tools是否已安装
   - 确认PATH环境变量是否正确配置
   - 尝试使用本地Tools目录中的工具

2. **备份文件过大**
   - 检查时间过滤条件是否正确
   - 确认是否只备份当天数据
   - 考虑调整压缩参数

3. **定时任务未执行**
   - 检查系统时间是否正确
   - 验证cron表达式格式
   - 查看PM2服务状态

4. **权限问题**
   - 确保数据库用户有读权限
   - 检查备份目录的写权限
   - 验证文件系统权限

### 调试模式

启用详细日志：

```bash
# 设置环境变量
set NODE_ENV=development

# 运行备份
node incremental_backup_manager.js --once
```

## 性能优化

### 备份性能调优

1. **并行限制**: 默认3个并行任务，可根据服务器性能调整
2. **压缩策略**: 启用gzip压缩减少存储空间
3. **网络优化**: 使用本地数据库连接减少网络延迟
4. **时间窗口**: 合理设置备份时间避开业务高峰

### 存储空间管理

- 自动清理过期备份文件
- 按策略保留不同时长的备份
- 监控磁盘空间使用情况
- 支持备份文件压缩

## 扩展功能

### 自定义集合配置

可以根据业务需要修改集合分类：

```javascript
// 添加新的备份策略
customStrategy: {
  schedule: '0 */2 * * *',    // 每2小时
  collections: ['new_collection'],
  retentionHours: 48,
  compress: true,
  timeField: 'timestamp'
}
```

### 告警集成

支持集成多种告警方式：

- 邮件通知
- 钉钉机器人
- 微信企业号
- Slack通知

### 备份验证

定期验证备份文件完整性：

- 文件大小检查
- 归档完整性验证
- 数据采样验证

## 最佳实践

### 部署建议

1. **生产环境**: 使用PM2管理进程，配置自动重启
2. **监控告警**: 启用健康检查和告警功能
3. **磁盘空间**: 预留足够的备份存储空间
4. **网络连接**: 确保数据库连接稳定可靠

### 备份策略

1. **分类备份**: 根据数据重要性选择合适的备份频率
2. **时间窗口**: 避免在业务高峰期进行备份
3. **保留策略**: 合理设置数据保留期限
4. **定期测试**: 定期验证备份恢复功能

### 安全考虑

1. **权限控制**: 使用专用的备份账户，最小权限原则
2. **数据加密**: 考虑对敏感备份文件进行加密
3. **访问审计**: 记录所有备份操作的审计日志
4. **网络安全**: 确保备份传输过程的安全性

## 技术支持

如有问题或建议，请联系：

- **系统管理员**: 负责日常维护和故障处理
- **开发团队**: 负责功能扩展和性能优化

---

*最后更新时间: 2024年* 