# å¾·æ˜ŒMESå¢é‡å¤‡ä»½æœåŠ¡å™¨ - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨å°†å¢é‡å¤‡ä»½æœåŠ¡å™¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæˆ–ç‹¬ç«‹æœåŠ¡å™¨ä¸Šã€‚è¯¥å¤‡ä»½æœåŠ¡å™¨å¯ä»¥å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€ä¾èµ–ä¸»åº”ç”¨æœåŠ¡å™¨ã€‚

## ğŸ¯ éƒ¨ç½²æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šåŒæœåŠ¡å™¨éƒ¨ç½²
é€‚ç”¨äºèµ„æºå……è¶³çš„å•æœåŠ¡å™¨ç¯å¢ƒ
- ä¸ä¸»åº”ç”¨å…±äº«æœåŠ¡å™¨èµ„æº
- å‡å°‘ç½‘ç»œå»¶è¿Ÿ
- ç®€åŒ–ç»´æŠ¤ç®¡ç†

### æ–¹æ¡ˆäºŒï¼šç‹¬ç«‹æœåŠ¡å™¨éƒ¨ç½²  
é€‚ç”¨äºå¤§å‹ç”Ÿäº§ç¯å¢ƒ
- ç‹¬ç«‹çš„å¤‡ä»½æœåŠ¡å™¨
- èµ„æºéš”ç¦»ï¼Œäº’ä¸å½±å“
- å¯æ‰©å±•æ€§æ›´å¥½

### æ–¹æ¡ˆä¸‰ï¼šäº‘æœåŠ¡éƒ¨ç½²
é€‚ç”¨äºäº‘ç¯å¢ƒ
- å¼¹æ€§æ‰©å±•
- é«˜å¯ç”¨æ€§
- è‡ªåŠ¨å¤‡ä»½åˆ°äº‘å­˜å‚¨

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### åŸºç¡€ç¯å¢ƒè¦æ±‚

**æ“ä½œç³»ç»Ÿæ”¯æŒ**
- Windows Server 2012 R2+ 
- Ubuntu 18.04+
- CentOS 7+
- macOS 10.14+

**è½¯ä»¶è¦æ±‚**
- Node.js 14.0+ ï¼ˆæ¨è LTS ç‰ˆæœ¬ï¼‰
- MongoDB Database Tools
- PM2ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰
- è‡³å°‘10GBå¯ç”¨ç£ç›˜ç©ºé—´

**ç½‘ç»œè¦æ±‚**
- èƒ½å¤Ÿè®¿é—®MongoDBæœåŠ¡å™¨
- ç¨³å®šçš„ç½‘ç»œè¿æ¥
- é˜²ç«å¢™å·²æ­£ç¡®é…ç½®

### MongoDBå·¥å…·å®‰è£…

**Windowsç¯å¢ƒ**
```powershell
# æ–¹å¼ä¸€ï¼šä½¿ç”¨Chocolatey
choco install mongodb-database-tools

# æ–¹å¼äºŒï¼šæ‰‹åŠ¨ä¸‹è½½
# ä» https://www.mongodb.com/try/download/database-tools ä¸‹è½½
# è§£å‹åˆ° C:\mongodb\bin\
```

**Linuxç¯å¢ƒ**
```bash
# Ubuntu/Debian
wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
sudo apt-get update
sudo apt-get install mongodb-database-tools

# CentOS/RHEL
sudo yum install mongodb-database-tools
```

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šæ–‡ä»¶å‡†å¤‡

**è·å–éƒ¨ç½²æ–‡ä»¶**
```bash
# å°†æ•´ä¸ªbackupServerç›®å½•å¤åˆ¶åˆ°ç›®æ ‡ä½ç½®
cp -r /path/to/backupServer /opt/dcmes-backup/
cd /opt/dcmes-backup/
```

**è®¾ç½®æƒé™**
```bash
# Linuxç¯å¢ƒ
chmod +x *.sh
chown -R backup-user:backup-group /opt/dcmes-backup/

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /data/backups
chown backup-user:backup-group /data/backups
```

### æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–

**å®‰è£…Node.jsä¾èµ–**
```bash
cd /opt/dcmes-backup/
npm install

# å¦‚æœç½‘ç»œä¸å¥½ï¼Œå¯ä»¥ä½¿ç”¨å›½å†…é•œåƒ
npm install --registry=https://registry.npm.taobao.org
```

**å…¨å±€å®‰è£…PM2ï¼ˆæ¨èï¼‰**
```bash
npm install -g pm2

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### æ­¥éª¤3ï¼šé…ç½®æœåŠ¡

**ç¼–è¾‘é…ç½®æ–‡ä»¶**
```bash
vi config.js
```

å…³é”®é…ç½®é¡¹ï¼š
```javascript
module.exports = {
  // æ•°æ®åº“è¿æ¥é…ç½®
  database: {
    host: '192.168.1.100',        // MongoDBæœåŠ¡å™¨åœ°å€
    port: '27017',
    database: 'dcMes',
    username: 'backup_user',       // å»ºè®®ä½¿ç”¨ä¸“ç”¨å¤‡ä»½ç”¨æˆ·
    password: 'secure_password',
    authDatabase: 'dcMes'
  },

  // è·¯å¾„é…ç½®
  paths: {
    backupPath: '/data/backups',           // å¤‡ä»½å­˜å‚¨è·¯å¾„
    toolsPath: '../dcMes_server/Tools',    // MongoDBå·¥å…·è·¯å¾„
  }
}
```

**ç¯å¢ƒå˜é‡é…ç½®ï¼ˆå¯é€‰ï¼‰**
```bash
# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
cat > .env << EOF
NODE_ENV=production
MONGO_HOST=192.168.1.100
MONGO_PORT=27017
MONGO_DB=dcMes
MONGO_USERNAME=backup_user
MONGO_PASSWORD=secure_password
BACKUP_PATH=/data/backups
LOG_LEVEL=info
TZ=Asia/Shanghai
EOF
```

### æ­¥éª¤4ï¼šæµ‹è¯•é…ç½®

**è¿è¡Œç³»ç»Ÿæµ‹è¯•**
```bash
npm test
```

**æ‰‹åŠ¨æµ‹è¯•å¤‡ä»½**
```bash
npm run once
```

**æ£€æŸ¥æ—¥å¿—**
```bash
tail -f /data/backups/logs/incremental_backup.log
```

### æ­¥éª¤5ï¼šå¯åŠ¨æœåŠ¡

**ä½¿ç”¨PM2å¯åŠ¨ï¼ˆæ¨èï¼‰**
```bash
# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.incremental.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# ç›‘æ§ç•Œé¢
pm2 monit
```

**ç›´æ¥å¯åŠ¨ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰**
```bash
npm start
```

**ä½¿ç”¨systemdç®¡ç†ï¼ˆLinuxï¼‰**
```bash
# åˆ›å»ºæœåŠ¡æ–‡ä»¶
sudo tee /etc/systemd/system/dcmes-backup.service > /dev/null <<EOF
[Unit]
Description=DCMES Incremental Backup Service
After=network.target

[Service]
Type=forking
User=backup-user
WorkingDirectory=/opt/dcmes-backup
ExecStart=/usr/bin/pm2 start ecosystem.incremental.config.js
ExecReload=/usr/bin/pm2 restart incremental-backup
ExecStop=/usr/bin/pm2 stop incremental-backup
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
sudo systemctl enable dcmes-backup
sudo systemctl start dcmes-backup
sudo systemctl status dcmes-backup
```

## ğŸ” å®‰å…¨é…ç½®

### æ•°æ®åº“ç”¨æˆ·æƒé™

**åˆ›å»ºä¸“ç”¨å¤‡ä»½ç”¨æˆ·**
```javascript
// è¿æ¥åˆ°MongoDB
use dcMes

// åˆ›å»ºåªè¯»å¤‡ä»½ç”¨æˆ·
db.createUser({
  user: "backup_user",
  pwd: "secure_password",
  roles: [
    {
      role: "read",
      db: "dcMes"
    }
  ]
})
```

### æ–‡ä»¶ç³»ç»Ÿæƒé™

**Linuxæƒé™è®¾ç½®**
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·
sudo useradd -r -s /bin/false backup-user

# è®¾ç½®ç›®å½•æƒé™
sudo chown -R backup-user:backup-user /opt/dcmes-backup/
sudo chown -R backup-user:backup-user /data/backups/
sudo chmod 750 /opt/dcmes-backup/
sudo chmod 750 /data/backups/
```

### ç½‘ç»œå®‰å…¨

**é˜²ç«å¢™é…ç½®**
```bash
# åªå…è®¸MongoDBç«¯å£è®¿é—®
sudo ufw allow from <mongodb-server-ip> to any port 27017

# æˆ–è€…ä½¿ç”¨iptables
sudo iptables -A INPUT -s <mongodb-server-ip> -p tcp --dport 27017 -j ACCEPT
```

## ğŸ—‚ï¸ ç›®å½•ç»“æ„è§„åˆ’

### æ¨èç›®å½•ç»“æ„

```
/opt/dcmes-backup/                 # åº”ç”¨ç¨‹åºç›®å½•
â”œâ”€â”€ incremental_backup_manager.js  # ä¸»ç¨‹åº
â”œâ”€â”€ config.js                      # é…ç½®æ–‡ä»¶
â”œâ”€â”€ package.json                   # ä¾èµ–ä¿¡æ¯
â””â”€â”€ logs/                          # åº”ç”¨æ—¥å¿—

/data/backups/                     # å¤‡ä»½æ•°æ®ç›®å½•
â”œâ”€â”€ hot/                           # çƒ­ç‚¹æ•°æ®å¤‡ä»½
â”œâ”€â”€ core/                          # æ ¸å¿ƒæ•°æ®å¤‡ä»½
â”œâ”€â”€ config/                        # é…ç½®æ•°æ®å¤‡ä»½
â”œâ”€â”€ analytics/                     # åˆ†ææ•°æ®å¤‡ä»½
â””â”€â”€ logs/                          # å¤‡ä»½æ—¥å¿—
    â”œâ”€â”€ incremental_backup.log     # ä¸»æ—¥å¿—
    â”œâ”€â”€ alerts.log                 # å‘Šè­¦æ—¥å¿—
    â””â”€â”€ manager_state.json         # çŠ¶æ€æ–‡ä»¶

/var/log/dcmes-backup/             # ç³»ç»Ÿæ—¥å¿—ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ pm2/                           # PM2æ—¥å¿—
```

## ğŸ“Š ç›‘æ§é…ç½®

### æ—¥å¿—ç›‘æ§

**é…ç½®æ—¥å¿—è½®è½¬**
```bash
# åˆ›å»ºlogrotateé…ç½®
sudo tee /etc/logrotate.d/dcmes-backup > /dev/null <<EOF
/data/backups/logs/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 backup-user backup-user
    postrotate
        /usr/bin/pm2 reload incremental-backup > /dev/null 2>&1 || true
    endscript
}
EOF
```

### ç£ç›˜ç©ºé—´ç›‘æ§

**é…ç½®ç£ç›˜ç©ºé—´æ£€æŸ¥**
```bash
# åˆ›å»ºç£ç›˜ç©ºé—´æ£€æŸ¥è„šæœ¬
cat > /opt/dcmes-backup/check_disk_space.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/data/backups"
THRESHOLD=80

USAGE=$(df -h "$BACKUP_DIR" | awk 'NR==2 {print $5}' | sed 's/%//')

if [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "WARNING: Backup directory is ${USAGE}% full"
    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å‘Šè­¦é€šçŸ¥
fi
EOF

chmod +x /opt/dcmes-backup/check_disk_space.sh

# æ·»åŠ åˆ°crontab
(crontab -l 2>/dev/null; echo "0 */1 * * * /opt/dcmes-backup/check_disk_space.sh") | crontab -
```

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

**é…ç½®å¥åº·æ£€æŸ¥**
```javascript
// åœ¨config.jsä¸­æ·»åŠ å¥åº·æ£€æŸ¥é…ç½®
monitoring: {
  healthCheck: {
    enabled: true,
    port: 3001,  // å¥åº·æ£€æŸ¥ç«¯å£
    interval: 60000  // æ£€æŸ¥é—´éš”
  }
}
```

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### é…ç½®æ–‡ä»¶å¤‡ä»½

**å¤‡ä»½é‡è¦é…ç½®**
```bash
# åˆ›å»ºé…ç½®å¤‡ä»½è„šæœ¬
cat > /opt/dcmes-backup/backup_config.sh << 'EOF'
#!/bin/bash
CONFIG_BACKUP="/data/backups/config_backup"
mkdir -p "$CONFIG_BACKUP"

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp config.js "$CONFIG_BACKUP/config.js.$(date +%Y%m%d)"
cp ecosystem.incremental.config.js "$CONFIG_BACKUP/ecosystem.$(date +%Y%m%d).js"

# ä¿ç•™æœ€è¿‘30å¤©çš„é…ç½®å¤‡ä»½
find "$CONFIG_BACKUP" -name "*.$(date -d '30 days ago' +%Y%m%d)" -delete
EOF

chmod +x /opt/dcmes-backup/backup_config.sh
```

### æœåŠ¡æ¢å¤

**å¿«é€Ÿæ¢å¤è„šæœ¬**
```bash
cat > /opt/dcmes-backup/restore_service.sh << 'EOF'
#!/bin/bash
echo "å¼€å§‹æ¢å¤å¤‡ä»½æœåŠ¡..."

# åœæ­¢æœåŠ¡
pm2 stop incremental-backup

# é‡æ–°å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.incremental.config.js

# æ£€æŸ¥çŠ¶æ€
pm2 status incremental-backup

echo "æœåŠ¡æ¢å¤å®Œæˆ"
EOF

chmod +x /opt/dcmes-backup/restore_service.sh
```

## ğŸš€ æ€§èƒ½è°ƒä¼˜

### ç³»ç»Ÿå‚æ•°è°ƒä¼˜

**Linuxç³»ç»Ÿå‚æ•°**
```bash
# å¢åŠ æ–‡ä»¶æè¿°ç¬¦é™åˆ¶
echo "backup-user soft nofile 65536" >> /etc/security/limits.conf
echo "backup-user hard nofile 65536" >> /etc/security/limits.conf

# ä¼˜åŒ–ç½‘ç»œå‚æ•°
echo "net.core.somaxconn = 1024" >> /etc/sysctl.conf
echo "net.ipv4.tcp_max_syn_backlog = 1024" >> /etc/sysctl.conf
sysctl -p
```

### å¤‡ä»½æ€§èƒ½è°ƒä¼˜

**è°ƒæ•´å¹¶å‘å‚æ•°**
```javascript
// åœ¨config.jsä¸­è°ƒæ•´
backup: {
  parallelLimit: 5,        // æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è°ƒæ•´
  useArchiveMode: true,    // ä½¿ç”¨å½’æ¡£æ¨¡å¼æé«˜æ€§èƒ½
  globalCompress: true     // å¯ç”¨å‹ç¼©èŠ‚çœç©ºé—´
}
```

## ğŸ†˜ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜è¯Šæ–­

**æœåŠ¡æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
node -c config.js

# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep :27017

# æ£€æŸ¥æƒé™
ls -la /opt/dcmes-backup/
ls -la /data/backups/
```

**å¤‡ä»½å¤±è´¥**
```bash
# æ£€æŸ¥MongoDBè¿æ¥
mongo --host 192.168.1.100 --port 27017 -u backup_user -p

# æµ‹è¯•mongodumpå‘½ä»¤
mongodump --host 192.168.1.100:27017 --db dcMes --collection api_logs --query '{"createdAt":{"$gte":new Date()}}' --out /tmp/test
```

**ç£ç›˜ç©ºé—´é—®é¢˜**
```bash
# æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h /data/backups/

# æ¸…ç†è¿‡æœŸå¤‡ä»½
find /data/backups/ -name "*.archive.gz" -mtime +7 -delete
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### è”ç³»æ–¹å¼
- **ç³»ç»Ÿç®¡ç†å‘˜**: å†…éƒ¨æŠ€æœ¯æ”¯æŒ
- **æ–‡æ¡£å‚è€ƒ**: README.md, ä½¿ç”¨è¯´æ˜.md
- **æ—¥å¿—åˆ†æ**: /data/backups/logs/

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥
```bash
# æœåŠ¡ç®¡ç†
pm2 start/stop/restart incremental-backup
pm2 logs incremental-backup
pm2 monit

# æ‰‹åŠ¨å¤‡ä»½
cd /opt/dcmes-backup && npm run once

# æŸ¥çœ‹çŠ¶æ€
cd /opt/dcmes-backup && npm run status

# æµ‹è¯•ç³»ç»Ÿ
cd /opt/dcmes-backup && npm test
```

---

*âœ… éƒ¨ç½²å®Œæˆåï¼Œè¯·ç¡®ä¿æœåŠ¡æ­£å¸¸è¿è¡Œå¹¶å®šæœŸæ£€æŸ¥å¤‡ä»½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚* 