# 账号锁定功能说明

## 功能概述

实现了5次账号密码输入错误后锁定用户15分钟的安全功能，防止暴力破解攻击。

## 功能特性

### 1. 登录失败计数
- 密码错误时自动增加失败计数
- 显示剩余尝试次数提示
- 达到5次失败后自动锁定账号

### 2. 账号锁定机制
- 锁定时间：15分钟
- 锁定期间禁止登录
- 实时显示剩余锁定时间

### 3. 自动解锁
- 15分钟后自动解除锁定
- 登录成功后重置失败计数
- 锁定过期时自动清理状态

### 4. 管理员解锁
- 提供管理员解锁接口
- 可查询用户锁定状态
- 支持强制解锁功能

## 技术实现

### 后端修改

#### 1. 数据库模型更新
```javascript
// user_login.js - 添加字段
loginFailCount: { type: Number, default: 0 }, // 登录失败次数
lockedUntil: { type: Date }, // 账号锁定到期时间
```

#### 2. 登录接口逻辑
- 检查账号锁定状态
- 处理密码验证失败
- 实现失败计数和锁定逻辑
- 自动清理过期锁定

#### 3. 新增管理接口
- `POST /api/v1/user/unlock` - 解锁用户账号
- `POST /api/v1/user/lockStatus` - 查询锁定状态

### 前端修改

#### 1. 状态管理
```javascript
// 添加锁定相关状态
isAccountLocked: false, // 账号是否被锁定
lockRemainingTime: 0, // 锁定剩余时间（秒）
lockCountdownTimer: null, // 倒计时定时器
```

#### 2. UI显示
- 锁定状态提示组件
- 实时倒计时显示
- 禁用登录按钮状态
- 锁定警告样式

#### 3. 交互逻辑
- 处理锁定状态响应
- 实时倒计时更新
- 自动解锁处理
- 组件销毁清理

## 错误码说明

| 错误码 | 说明 | 处理方式 |
|--------|------|----------|
| 4022 | 密码错误（未锁定） | 显示剩余尝试次数 |
| 4023 | 账号已锁定 | 显示锁定时间和倒计时 |

## 安全特性

1. **防暴力破解**：限制连续失败尝试次数
2. **时间窗口**：15分钟锁定时间平衡安全和用户体验
3. **自动恢复**：避免永久锁定造成的用户困扰
4. **管理员干预**：提供紧急解锁机制

## 使用示例

### 正常登录流程
1. 用户输入用户名密码
2. 系统验证凭据
3. 登录成功，重置失败计数

### 密码错误流程
1. 用户输入错误密码
2. 系统增加失败计数
3. 显示"还可尝试X次"提示
4. 第5次失败后锁定账号15分钟

### 锁定状态显示
1. 显示锁定警告信息
2. 实时倒计时显示剩余时间
3. 禁用登录按钮
4. 时间到期自动解锁

### 管理员解锁
```javascript
// 解锁用户
POST /api/v1/user/unlock
{
  "userName": "test_user"
}

// 查询锁定状态
POST /api/v1/user/lockStatus
{
  "userName": "test_user"
}
```

## 配置参数

可在代码中调整的参数：

- `maxFailCount = 5` - 最大失败次数
- `lockTime = 15 * 60 * 1000` - 锁定时间（毫秒）
- 倒计时更新频率：1秒

## 注意事项

1. 确保数据库已更新字段结构
2. 前端需要正确处理错误码
3. 管理员解锁接口需要权限控制
4. 定时器需要在组件销毁时清理
5. 服务器重启不会影响锁定状态（存储在数据库）

## 测试建议

1. **功能测试**
   - 连续输入5次错误密码
   - 验证锁定状态和倒计时
   - 测试自动解锁功能

2. **边界测试**
   - 在锁定即将到期时登录
   - 锁定期间尝试登录
   - 管理员解锁功能

3. **异常测试**
   - 网络中断时的状态保持
   - 页面刷新后的状态恢复
   - 多标签页同时登录

## 后续优化建议

1. 可考虑IP级别的锁定机制
2. 添加邮件或短信通知功能
3. 提供锁定历史记录查询
4. 支持不同用户级别的锁定策略
