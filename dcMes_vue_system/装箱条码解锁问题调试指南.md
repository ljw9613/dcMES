# è£…ç®±æ¡ç è§£é”é—®é¢˜è°ƒè¯•æŒ‡å—

## ğŸ” é—®é¢˜è¯†åˆ«

å¦‚æœæ‚¨é‡åˆ°æ‰‹åŠ¨è§£é”è£…ç®±æ¡ç æ²¡æœ‰è§¦å‘çš„é—®é¢˜ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ’æŸ¥ï¼š

## ğŸ“‹ è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰ä»¥ä¸‹æ—¥å¿—ï¼š

#### æ­£å¸¸è§£é”æµç¨‹åº”è¯¥çœ‹åˆ°ï¼š
```
ğŸ”“ å¼€å§‹è§£é”å½“å‰æ¡ç ...
å½“å‰è£…ç®±æ¡ç çŠ¶æ€: { _id: "...", barcode: "...", ... }
è®¾å¤‡ä¿¡æ¯: { sessionId: "...", deviceIp: "..." }
ğŸ”“ å‘é€è§£é”è¯·æ±‚ï¼Œå‚æ•°: { barcodeId: "...", sessionId: "...", deviceIp: "..." }
ğŸ”“ è§£é”å“åº”: { success: true, message: "..." }
âœ… æ¡ç è§£é”æˆåŠŸ
```

#### å¦‚æœçœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼Œè¯´æ˜æ²¡æœ‰æ¡ç éœ€è¦è§£é”ï¼š
```
âš ï¸ æ²¡æœ‰éœ€è¦è§£é”çš„æ¡ç ä¿¡æ¯
```

#### å¦‚æœçœ‹åˆ°é”™è¯¯æ—¥å¿—ï¼š
```
âŒ è§£é”æ¡ç å¤±è´¥: [é”™è¯¯ä¿¡æ¯]
```

### 2. æ£€æŸ¥è£…ç®±æ¡ç çŠ¶æ€

åœ¨æ§åˆ¶å°è¾“å…¥ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥å½“å‰çŠ¶æ€ï¼š
```javascript
// æ£€æŸ¥è£…ç®±æ¡ç 
console.log('è£…ç®±æ¡ç :', this.packingBarcode);

// æ£€æŸ¥è®¾å¤‡ä¿¡æ¯
console.log('è®¾å¤‡ä¿¡æ¯:', this.deviceInfo);

// æ£€æŸ¥æœ¬åœ°å­˜å‚¨
console.log('æœ¬åœ°é”å®šä¿¡æ¯:', localStorage.getItem('lockedPackBarcode'));

// æ£€æŸ¥è®¾å¤‡ID
console.log('è®¾å¤‡ID:', localStorage.getItem('deviceId'));
```

### 3. ä½¿ç”¨æ‰‹åŠ¨è§£é”æŒ‰é’®

åœ¨é¡µé¢å³ä¸Šè§’ç‚¹å‡» **"æ‰‹åŠ¨è§£é”æ¡ç "** æŒ‰é’®ï¼Œè¯¥æŒ‰é’®ä¼šï¼š

1. **æ‰§è¡Œå…¨é¢æ¸…ç†**ï¼šæ¸…ç†å½“å‰æ¡ç é”å®š
2. **æ‰¹é‡æ¸…ç†**ï¼šæ¸…ç†è®¾å¤‡æ‰€æœ‰é”å®š
3. **é‡æ–°åˆå§‹åŒ–**ï¼šé‡æ–°ç”Ÿæˆè®¾å¤‡ä¿¡æ¯
4. **æ˜¾ç¤ºè¯¦ç»†æ—¥å¿—**ï¼šè¾“å‡ºå®Œæ•´çš„è§£é”è¿‡ç¨‹

### 4. æ£€æŸ¥åç«¯è§£é”æ¥å£

å¦‚æœå‰ç«¯æ—¥å¿—æ­£å¸¸ä½†è§£é”å¤±è´¥ï¼Œæ£€æŸ¥åç«¯æ˜¯å¦æ­£ç¡®å¤„ç†ï¼š

#### æ£€æŸ¥è§£é”å‚æ•°æ˜¯å¦åŒ¹é…ï¼š
- `barcodeId` æˆ– `barcode` å‚æ•°
- `deviceIp` æˆ– `sessionId` å‚æ•°
- é”å®šçŠ¶æ€å’Œæ—¶é—´

#### åç«¯è§£é”APIåœ°å€ï¼š
- å•ä¸ªè§£é”ï¼š`POST /api/v1/unlockPackBarcode`
- æ‰¹é‡è§£é”ï¼š`POST /api/v1/unlockAllPackBarcodes`

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šè®¾å¤‡ä¿¡æ¯ä¸åŒ¹é…

**ç—‡çŠ¶**ï¼šå‰ç«¯å‘é€è§£é”è¯·æ±‚ï¼Œä½†åç«¯è¿”å›"æœªæ‰¾åˆ°å¯è§£é”çš„æ¡ç "

**åŸå› **ï¼šè§£é”æ—¶çš„è®¾å¤‡ä¿¡æ¯ä¸é”å®šæ—¶ä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// 1. é‡æ–°åˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯
this.initDeviceInfo();

// 2. æˆ–è€…æ‰‹åŠ¨è®¾ç½®å·¥ä½ç¼–å·
localStorage.setItem('workstationId', 'LINE01_WS001');

// 3. ä½¿ç”¨æ‰¹é‡è§£é”æ¸…ç†æ‰€æœ‰é”å®š
await unlockAllPackBarcodes(this.deviceInfo);
```

### é—®é¢˜2ï¼šæ¡ç ä¿¡æ¯ç¼ºå¤±

**ç—‡çŠ¶**ï¼šæ§åˆ¶å°æ˜¾ç¤º"æ²¡æœ‰éœ€è¦è§£é”çš„æ¡ç ä¿¡æ¯"

**åŸå› **ï¼š`packingBarcode` å¯¹è±¡ç¼ºå°‘ `_id` æˆ– `barcode` å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ£€æŸ¥æ¡ç å¯¹è±¡ç»“æ„
console.log('æ¡ç å¯¹è±¡:', this.packingBarcode);

// å¦‚æœåªæœ‰éƒ¨åˆ†ä¿¡æ¯ï¼Œå¯ä»¥æ‰‹åŠ¨æ„é€ è§£é”å‚æ•°
const unlockParams = {
  barcode: this.packingBarcode.printBarcode || this.packingBarcode.barcode,
  ...this.deviceInfo
};
await unlockPackBarcode(unlockParams);
```

### é—®é¢˜3ï¼šç½‘ç»œè¯·æ±‚å¤±è´¥

**ç—‡çŠ¶**ï¼šè§£é”è¯·æ±‚å‘é€å¤±è´¥æˆ–è¶…æ—¶

**åŸå› **ï¼šç½‘ç»œè¿æ¥é—®é¢˜æˆ–åç«¯æœåŠ¡å¼‚å¸¸

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// 1. æ£€æŸ¥ç½‘ç»œè¿æ¥
// 2. æ£€æŸ¥APIåœ°å€æ˜¯å¦æ­£ç¡®
// 3. ä½¿ç”¨sendBeaconä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼ˆé¡µé¢å¸è½½æ—¶ï¼‰
navigator.sendBeacon('/api/v1/unlockPackBarcode', JSON.stringify(unlockData));
```

### é—®é¢˜4ï¼šé”å®šçŠ¶æ€ä¸ä¸€è‡´

**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤ºæœ‰é”å®šï¼Œä½†åç«¯æŸ¥è¯¢ä¸åˆ°

**åŸå› **ï¼šæ•°æ®åº“å’Œå‰ç«¯çŠ¶æ€ä¸åŒæ­¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// 1. å¼ºåˆ¶æ¸…ç†æœ¬åœ°çŠ¶æ€
localStorage.removeItem('lockedPackBarcode');
this.packingBarcode = {};

// 2. ä½¿ç”¨çŠ¶æ€æ£€æŸ¥APIéªŒè¯
const response = await checkPackBarcodeStatus({
  productionLineId: this.formData.productLine,
  materialNumber: this.boxMaterial.materialCode
});

// 3. é‡æ–°åˆå§‹åŒ–è£…ç®±æ¡ç 
this.initializePackingBarcode();
```

## ğŸ”§ è§£é”è§¦å‘æ—¶æœº

è§£é”æ“ä½œä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è§¦å‘ï¼š

1. **ç‰©æ–™åˆ‡æ¢æ—¶**ï¼šç›‘å¬ `mainMaterialId` å˜åŒ–
2. **é¡µé¢åˆ·æ–°æ—¶**ï¼š`created()` é’©å­è°ƒç”¨æ¸…ç†æ–¹æ³•
3. **é¡µé¢å¸è½½æ—¶**ï¼š`beforeunload` äº‹ä»¶ä½¿ç”¨ sendBeacon
4. **ç»„ä»¶é”€æ¯æ—¶**ï¼š`beforeDestroy()` é’©å­
5. **æ‰‹åŠ¨è§¦å‘æ—¶**ï¼šç‚¹å‡»"æ‰‹åŠ¨è§£é”æ¡ç "æŒ‰é’®

## ğŸ› ï¸ é«˜çº§è°ƒè¯•æŠ€å·§

### 1. ç›‘æ§è§£é”è¿‡ç¨‹

åœ¨æ§åˆ¶å°è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œç›‘æ§è§£é”è¿‡ç¨‹ï¼š
```javascript
// ç›‘æ§è§£é”APIè°ƒç”¨
const originalUnlock = unlockPackBarcode;
window.unlockPackBarcode = function(...args) {
  console.log('ğŸ” è§£é”APIè°ƒç”¨:', args);
  return originalUnlock.apply(this, args).then(result => {
    console.log('ğŸ” è§£é”APIå“åº”:', result);
    return result;
  });
};
```

### 2. å¼ºåˆ¶è§£é”æ‰€æœ‰æ¡ç 

å¦‚æœé‡åˆ°ä¸¥é‡çš„é”å®šé—®é¢˜ï¼Œå¯ä»¥å¼ºåˆ¶æ¸…ç†æ‰€æœ‰é”å®šï¼š
```javascript
// åœ¨æ§åˆ¶å°æ‰§è¡Œ
async function forceUnlockAll() {
  try {
    // æ¸…ç†æœ¬åœ°å­˜å‚¨
    localStorage.removeItem('lockedPackBarcode');
    localStorage.removeItem('deviceId');
    
    // é‡æ–°åˆå§‹åŒ–è®¾å¤‡ä¿¡æ¯
    this.initDeviceInfo();
    
    // æ‰¹é‡è§£é”
    const response = await unlockAllPackBarcodes(this.deviceInfo);
    console.log('å¼ºåˆ¶è§£é”ç»“æœ:', response);
    
    // é‡ç½®çŠ¶æ€
    this.packingBarcode = {};
    this.packingBarcodeRetryCount = 0;
    
    console.log('âœ… å¼ºåˆ¶è§£é”å®Œæˆ');
  } catch (error) {
    console.error('âŒ å¼ºåˆ¶è§£é”å¤±è´¥:', error);
  }
}

// æ‰§è¡Œå¼ºåˆ¶è§£é”
forceUnlockAll.call(this);
```

### 3. æŸ¥çœ‹æ•°æ®åº“é”å®šçŠ¶æ€

å¦‚æœæœ‰åç«¯è®¿é—®æƒé™ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¯¢æ•°æ®åº“ï¼š
```javascript
// MongoDBæŸ¥è¯¢é”å®šçš„æ¡ç 
db.packbarcodes.find({
  status: "LOCKED",
  lockExpireAt: { $gt: new Date() }
});

// æŸ¥çœ‹ç‰¹å®šè®¾å¤‡çš„é”å®š
db.packbarcodes.find({
  lockedBy: "ä½ çš„è®¾å¤‡ID"
});

// æ¸…ç†è¿‡æœŸé”å®š
db.packbarcodes.updateMany(
  {
    status: "LOCKED",
    lockExpireAt: { $lt: new Date() }
  },
  {
    $set: {
      status: "PENDING",
      lockedBy: null,
      lockedAt: null,
      lockExpireAt: null
    }
  }
);
```

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ä»æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **æµè§ˆå™¨æ§åˆ¶å°å®Œæ•´æ—¥å¿—**
2. **è£…ç®±æ¡ç å¯¹è±¡å†…å®¹**
3. **è®¾å¤‡ä¿¡æ¯å†…å®¹**
4. **æœ¬åœ°å­˜å‚¨ç›¸å…³æ•°æ®**
5. **åç«¯APIå“åº”å†…å®¹**
6. **å…·ä½“çš„æ“ä½œæ­¥éª¤**

å°†è¿™äº›ä¿¡æ¯å‘é€ç»™å¼€å‘å›¢é˜Ÿï¼Œæˆ‘ä»¬ä¼šååŠ©æ‚¨è§£å†³é—®é¢˜ã€‚

---

**æ›´æ–°æ—¶é—´**ï¼š2024å¹´12æœˆ  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šè£…ç®±æ¡ç å¹¶å‘å®‰å…¨ç‰ˆæœ¬ v2.0.0  
**ç»´æŠ¤å›¢é˜Ÿ**ï¼šç³»ç»Ÿå¼€å‘å›¢é˜Ÿ 