# ç™»å½•Token 401é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šç™»å½•ååˆ·æ–°é¡µé¢æ—¶ï¼Œè¯·æ±‚ `/user/info` æ¥å£ä¼šæç¤º `401 Unauthorized` é”™è¯¯ã€‚

## ğŸš¨ æ ¹æœ¬åŸå› åˆ†æ

ç»è¿‡è¯¦ç»†ä»£ç åˆ†æï¼Œå‘ç°ä»¥ä¸‹å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

### 1. åç«¯JWTä¸­é—´ä»¶è¢«ç¦ç”¨
- `dcMes_server/app.js` ä¸­çš„JWTéªŒè¯ä¸­é—´ä»¶è¢«å®Œå…¨æ³¨é‡Šæ‰
- å¯¼è‡´å…¨å±€tokenéªŒè¯å¤±æ•ˆï¼Œåªæœ‰éƒ¨åˆ†è·¯ç”±é€šè¿‡ `apiLogger` ä¸­é—´ä»¶è¿›è¡ŒéªŒè¯

### 2. å‰ç«¯tokenæºå¸¦æ ¼å¼ä¸ä¸€è‡´
- å‰ç«¯è¯·æ±‚æ‹¦æˆªå™¨ä¸­tokenå¤´æ ¼å¼ä¸è§„èŒƒ
- ç¼ºå°‘è°ƒè¯•ä¿¡æ¯ï¼Œéš¾ä»¥æ’æŸ¥é—®é¢˜

### 3. Cookieå­˜å‚¨é…ç½®ä¸å½“
- tokenå­˜å‚¨æ—¶æœªè®¾ç½®è¿‡æœŸæ—¶é—´
- ç¼ºå°‘å®‰å…¨é…ç½®é€‰é¡¹

### 4. VuexçŠ¶æ€ç®¡ç†ä»£ç é”™è¯¯
- `user.js` æ¨¡å—ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯
- å½±å“tokençŠ¶æ€çš„æ­£å¸¸ç®¡ç†

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. å¯ç”¨åç«¯JWTå…¨å±€éªŒè¯

**æ–‡ä»¶**: `dcMes_server/app.js`

```javascript
// JWTä»¤ç‰ŒéªŒè¯ä¸­é—´ä»¶ - å¯ç”¨å…¨å±€éªŒè¯
app.use(expressJwt({
  secret: config.secretOrPrivateKey,
  algorithms: ['HS256'] // æ˜ç¡®æŒ‡å®šç®—æ³•
}).unless({
  path: [
    // ç™»å½•ç›¸å…³æ¥å£
    /.*\/login.*/,
    /.*\/auth.*/,
    // å…¬å…±æ¥å£
    /.*\/public.*/,
    /.*\/health.*/,
    /.*\/ping.*/,
    // è®¾å¤‡å¯¹æ¥æ¥å£
    /.*\/machine-scan-components.*/,
    /.*\/initialize-machine-barcode.*/,
    /.*\/get-laser-print-barcode.*/,
    /.*\/confirm-laser-barcode-used.*/,
    // é™æ€èµ„æº
    /.*\/uploads.*/,
    /.*\/stylesheets.*/,
    // å¾®ä¿¡ç›¸å…³
    /sendMessage*/,
    /wxuser*/
  ]
}));

// JWTéªŒè¯å¤±è´¥æ—¶çš„å¤„ç†
app.use(function (err, req, res, next) {
  if (err.name === "UnauthorizedError") {
    res.status(401).json({
      message: "TokenéªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•",
      code: 401,
      success: false,
      error: err.message
    });
    return;
  }
  next(err);
});
```

### 2. ä¼˜åŒ–å‰ç«¯tokenæºå¸¦

**æ–‡ä»¶**: `dcMes_vue_system/src/utils/request.js`

- ç»Ÿä¸€ä½¿ç”¨ `Authorization` å¤´
- ç¡®ä¿Beareræ ¼å¼æ­£ç¡®
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### 3. æ”¹è¿›Cookieå­˜å‚¨é…ç½®

**æ–‡ä»¶**: `dcMes_vue_system/src/utils/auth.js`

```javascript
export function setToken(token) {
  return Cookies.set(TokenKey, token, { 
    expires: 30, // 30å¤©è¿‡æœŸ
    secure: false, // å¼€å‘ç¯å¢ƒè®¾ä¸ºfalseï¼Œç”Ÿäº§ç¯å¢ƒåº”è®¾ä¸ºtrue
    sameSite: 'lax' // é˜²æ­¢CSRFæ”»å‡»
  })
}
```

### 4. ä¿®å¤VuexçŠ¶æ€ç®¡ç†é”™è¯¯

**æ–‡ä»¶**: `dcMes_vue_system/src/store/modules/user.js`

- ä¿®å¤è¯­æ³•é”™è¯¯
- æ·»åŠ tokençŠ¶æ€è°ƒè¯•ä¿¡æ¯

## ğŸ§ª éªŒè¯æ­¥éª¤

1. **é‡å¯åç«¯æœåŠ¡**ï¼š
   ```bash
   cd dcMes_server
   npm restart
   ```

2. **é‡æ–°æ„å»ºå‰ç«¯**ï¼š
   ```bash
   cd dcMes_vue_system
   npm run serve
   ```

3. **æµ‹è¯•æµç¨‹**ï¼š
   - ç™»å½•ç³»ç»Ÿ
   - åˆ·æ–°é¡µé¢
   - è§‚å¯Ÿæ§åˆ¶å°æ˜¯å¦æœ‰tokenç›¸å…³é”™è¯¯
   - æ£€æŸ¥ `/user/info` æ¥å£æ˜¯å¦æ­£å¸¸è¿”å›

## ğŸ”§ è°ƒè¯•æŠ€å·§

### å‰ç«¯è°ƒè¯•
- æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- æŸ¥çœ‹ Network æ ‡ç­¾ä¸­çš„è¯·æ±‚å¤´
- ç¡®è®¤ `Authorization: Bearer <token>` æ ¼å¼æ­£ç¡®

### åç«¯è°ƒè¯•
- æŸ¥çœ‹æœåŠ¡å™¨æ§åˆ¶å°æ—¥å¿—
- ç¡®è®¤JWTéªŒè¯è¿‡ç¨‹çš„è¾“å‡ºä¿¡æ¯

## ğŸ“‹ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒé…ç½®**ï¼š
   - è®¾ç½® `secure: true` åœ¨Cookieé…ç½®ä¸­
   - ç¡®ä¿HTTPSç¯å¢ƒä¸‹ä½¿ç”¨

2. **Tokenè¿‡æœŸå¤„ç†**ï¼š
   - å‰ç«¯éœ€è¦å¤„ç†tokenè¿‡æœŸçš„æƒ…å†µ
   - è‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢

3. **å®‰å…¨è€ƒè™‘**ï¼š
   - å®šæœŸæ›´æ¢JWTå¯†é’¥
   - ç›‘æ§å¼‚å¸¸çš„è®¤è¯è¯·æ±‚

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®å¤å®Œæˆåï¼Œç”¨æˆ·åº”è¯¥èƒ½å¤Ÿï¼š
- æ­£å¸¸ç™»å½•ç³»ç»Ÿ
- åˆ·æ–°é¡µé¢ä¸ä¼šå‡ºç°401é”™è¯¯
- Tokenåœ¨æœ‰æ•ˆæœŸå†…æŒç»­æœ‰æ•ˆ
- ç³»ç»Ÿå®‰å…¨æ€§å¾—åˆ°ä¿éšœ

---

**ä¿®å¤æ—¥æœŸ**: 2024å¹´1æœˆ
**ä¿®å¤äººå‘˜**: AIåŠ©æ‰‹
**å½±å“èŒƒå›´**: å…¨ç³»ç»Ÿç”¨æˆ·è®¤è¯æµç¨‹ 