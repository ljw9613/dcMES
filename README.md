# 产品维修系统 - 部件更换审核验证功能

## 功能概述

本项目是一个生产制造执行系统(MES)中的产品维修模块，主要功能包括产品维修记录的创建、审核和管理。最新增加了部件更换维修单的审核验证功能。

## 项目结构

### 前端文件结构
- `dcMes_vue_system/src/views/productRepair/index.vue` - 产品维修主页面
- `dcMes_vue_system/src/views/productRepair/components/EditDialog.vue` - 维修记录编辑对话框
- `dcMes_vue_system/src/api/product/productRepair.js` - 产品维修API接口

### 后端文件结构
- `dcMes_server/routes/productRepair.js` - 产品维修路由和API实现
- `dcMes_server/model/project/productRepair.js` - 产品维修数据模型
- `dcMes_server/model/project/unbindRecord.js` - 解绑记录数据模型

## 核心功能

### 1. 维修记录管理
- **创建维修记录**：支持成品维修和组件维修两种类型
- **条码扫描**：通过扫描产品条码快速创建维修记录
- **处理方案**：支持多种处理方案，包括部件更换、报废等
- **审核流程**：待审核 → 已审核 → 已作废的状态流转

### 2. 部件更换审核验证功能（新增）

#### 功能描述
当维修单的处理方案选择为"部件更换"时，系统在审核阶段会自动检查是否存在相应的部件解绑记录。只有在确认完成部件更换操作后，维修单才能通过审核。

#### 实现逻辑

**后端验证逻辑**：
1. 在审核API中检查维修单的处理方案
2. 如果是部件更换方案，查询对应的解绑记录
3. 验证解绑记录的有效性（解绑时间必须在维修记录创建时间之后）
4. 如果没有有效的解绑记录，则拒绝审核并返回详细错误信息

**前端用户交互**：
1. 在维修记录编辑页面，选择部件更换方案时显示提示信息
2. 审核时如果验证失败，显示详细的错误对话框
3. 提供"查看产品详情"按钮，方便用户进行解绑操作
4. 支持单个审核和批量审核的验证

#### 技术实现

**数据模型关联**：
```javascript
// 维修记录与解绑记录的关联关系
UnbindRecord.find({
  flowRecordId: materialFlowRecord._id,  // 物料流程记录ID
  mainBarcode: repairRecord.barcode,     // 产品条码
})
```

**验证条件**：
- 解绑记录必须存在
- 解绑时间必须在维修记录创建时间之后
- 解绑记录必须关联到正确的物料流程

### 3. 用户界面优化

#### 筛选搜索功能
- 支持按产品条码、产品型号、处理方案等多种条件筛选
- 当选择部件更换方案时，显示原产品条码和新产品条码输入框

#### 列表展示
- 清晰展示维修记录的所有关键信息
- 状态标签使用不同颜色区分（待审核、已审核、已作废）
- 操作按钮根据用户权限和记录状态动态显示

#### 审核对话框
- 根据处理方案类型动态调整审核表单
- 报废方案不需要选择维修结果
- 部件更换方案显示特殊提示信息

### 4. 权限控制
- 新增成品维修：`产品维修新增成品维修`
- 新增组件维修：`产品维修新增组件维修`
- 修改维修记录：`产品维修修改`
- 审核维修记录：`产品维修审核`
- 批量审核：`产品维修批量审核`
- 批量作废：`产品维修批量作废`

### 5. 导出功能
- 支持根据筛选条件导出维修记录
- Excel格式导出，包含所有关键字段
- 带进度条的异步导出处理

## 使用说明

### 创建部件更换维修记录
1. 点击"新增成品维修"或"新增组件维修"按钮
2. 扫描产品条码，系统自动填充产品信息
3. 选择处理方案为"部件更换"
4. 填写不良现象、分析原因、维修描述等信息
5. 保存并提交维修记录

### 审核部件更换维修记录
1. 在维修记录列表中找到待审核的部件更换记录
2. 点击"查看产品详情"按钮，进入产品工艺流程页面
3. 在物料信息标签页中进行必要的部件解绑操作
4. 返回维修记录页面，点击"审核"按钮
5. 填写不利影响评价，提交审核

### 错误处理
如果审核时提示缺少解绑记录：
1. 检查产品是否已完成部件更换操作
2. 确认解绑时间在维修记录创建时间之后
3. 如需要，重新进行解绑操作
4. 重新提交审核

## 技术特性

- **响应式设计**：支持PC端操作，界面友好
- **实时验证**：前后端双重验证，确保数据准确性
- **权限控制**：基于角色的访问控制
- **操作日志**：记录所有关键操作，便于追溯
- **性能优化**：支持大批量数据的高效处理

## 开发环境

- **前端**：Vue.js 2.x + Element UI
- **后端**：Node.js + Express + MongoDB
- **数据库**：MongoDB with Mongoose ODM

## 部署说明

1. 确保MongoDB数据库中包含所需的数据模型
2. 后端API服务正常运行
3. 前端项目正确配置API接口地址
4. 用户具有相应的操作权限

---

*该文档描述了产品维修系统中部件更换审核验证功能的完整实现，包括前后端逻辑、用户界面和使用流程。*

# 出库单重复托盘问题修复说明

## 问题描述
在整托出库过程中，经常出现同一个托盘在同一个出库单中生成两条数据的问题，导致数据异常和出库数量计算错误。

## 问题原因分析
1. **并发操作**：多个用户或快速重复操作导致同时对同一托盘进行出库处理
2. **缺乏原子性**：出库操作没有使用数据库的原子操作，存在竞态条件
3. **重复检查不充分**：仅检查托盘是否存在，但没有防止并发情况下的重复添加
4. **前端防护不足**：用户可以快速重复扫码，没有加载状态保护

## 修复措施

### 1. 后端API修复 (`dcMes_server/routes/wareHouseOntry.js`)

#### 强化重复检查机制
- 添加重复托盘项检测，发现重复时立即报错并记录日志
- 在添加托盘前重新获取最新的出库单数据，防止基于过期数据的操作
- 实现多层检查：初检查 → 数据刷新 → 最终检查

#### 使用MongoDB原子操作
```javascript
// 使用原子操作确保不会重复添加
const updateResult = await wareHouseOntry.updateOne(
  { 
    _id: entry._id,
    "entryItems.palletCode": { $ne: palletCode } // 确保托盘不存在
  },
  { 
    $push: { entryItems: palletItem },
    $set: { updateAt: new Date() }
  }
);
```

#### 错误回滚机制
- 当添加托盘后发现超出应出库数量时，自动回滚操作
- 确保数据一致性

#### 详细日志记录
- 记录重复托盘发现的详细信息
- 便于问题追踪和调试

### 2. 前端防护 (`dcMes_vue_system/src/views/warehouseOntry/components/ScanDialog.vue`)

#### 重复扫码检查
- 在提交前检查托盘是否已在当前出库单中
- 检查产品条码是否已在出库单中存在

#### 加载状态管理
```javascript
// 防止快速重复操作
if (this.isScanning) {
  this.$message.warning("正在处理中，请稍候...");
  return;
}
```

#### 状态管理改进
- 添加 `isScanning`、`isProductScanning`、`isBoxProcessing` 状态
- 所有异步操作完成后正确重置状态
- 在对话框关闭时重置所有状态

### 3. 数据修复工具

#### 单个出库单重复项清理
```
POST /api/v1/warehouse_entry/clean_duplicate_pallets
```
- 检测并清理指定出库单的重复托盘项
- 合并重复项的条码信息
- 重新计算出库数量和进度

#### 批量清理工具
```
POST /api/v1/warehouse_entry/batch_clean_duplicates
```
- 批量处理所有出库单的重复问题
- 支持按状态筛选处理范围
- 提供详细的处理报告

## 防护机制总结

### 1. 多层检查防护
- **第一层**：前端重复检查 + 用户提示
- **第二层**：后端初始检查 + 重复项检测
- **第三层**：数据刷新 + 最终检查
- **第四层**：原子操作 + 约束检查

### 2. 状态管理
- **前端状态**：防止用户快速重复操作
- **后端状态**：确保数据一致性
- **错误恢复**：异常情况下的状态重置

### 3. 数据完整性
- **原子操作**：使用MongoDB的原子更新操作
- **事务性**：关键操作的原子性保证
- **回滚机制**：错误情况下的数据回滚

### 4. 监控和修复
- **重复检测**：实时检测重复数据
- **日志记录**：详细的操作日志
- **修复工具**：自动和手动修复工具

## 使用建议

### 1. 预防措施
- 培训操作人员避免快速重复扫码
- 等待系统响应后再进行下一步操作
- 注意观察界面提示信息

### 2. 问题处理
- 发现重复数据时，先使用清理工具修复
- 检查修复结果，确保数据正确性
- 必要时联系技术支持

### 3. 监控建议
- 定期检查出库单数据的完整性
- 监控系统日志中的重复项警告
- 及时处理发现的异常情况

## 技术细节

### 原子操作保证
使用MongoDB的 `$ne` 操作符确保托盘不存在时才添加：
```javascript
"entryItems.palletCode": { $ne: palletCode }
```

### 并发控制
通过前端状态锁和后端原子操作双重保护，防止并发问题。

### 数据一致性
在每次操作后重新计算出库数量、进度等关键指标，确保数据一致性。

---

此修复方案已经过充分测试，能够有效防止重复出库问题的发生，并提供了完善的数据修复机制。

