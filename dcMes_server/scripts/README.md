# 产出数量并发控制和检测工具

## 概述

这套工具用于解决产品条码产出数量重复增加的并发问题。包含了问题检测、修复实现和测试验证等完整的解决方案。

## 问题背景

在生产环境中发现，同一个产品条码的产出数量有时会突然增加2个而不是预期的1个，这是由于并发操作导致的数据重复统计问题。

## 工具组成

### 1. 重复数据检测脚本
**文件**: `scripts/duplicate-detection.js`
**功能**: 分析现有数据中的重复产出统计问题

#### 使用方法
```bash
# 在 dcMes_server 目录下运行
cd dcMes_server
node scripts/duplicate-detection.js
```

#### 检测内容
- 检测重复的产出记录（同一条码多次产出统计）
- 分析异常的产出量增长（短时间内异常增加）
- 统计产出量的时间分布
- 生成修复建议和报告

#### 输出示例
```
🚀 开始重复数据检测分析

🔌 正在连接数据库...
✅ 数据库连接成功

🔍 开始检测重复产出记录...
检查时间范围: 最近7天
重复阈值: 2次及以上

=== 检测结果 ===
发现 3 个重复记录组

1. 工单ID: 507f1f77bcf86cd799439011
   条码: PROD_20241201_001
   重复次数: 3 (多计 2 次)
   总计数量: 3
   记录详情:
     1) 2024-12-01T08:30:15.000Z - USER001 - 数量:1 - 扫描工序组件末道工序产出
     2) 2024-12-01T08:30:16.000Z - USER001 - 数量:1 - 扫描工序组件末道工序产出
     3) 2024-12-01T08:30:17.000Z - USER001 - 数量:1 - 扫描工序组件末道工序产出
```

### 2. 数据库索引配置
**文件**: `config/database-indexes.js`
**功能**: 创建优化查询性能的数据库索引

#### 使用方法
```bash
# 在 dcMes_server 目录下运行
cd dcMes_server
node config/database-indexes.js
```

#### 创建的索引
- 工单ID + 条码 + 变更类型 + 操作时间复合索引
- 操作唯一标识唯一性索引
- 工单ID + 变更类型 + 时间索引
- 主条码 + 更新时间索引

### 3. 并发测试脚本
**文件**: `test/concurrency-test.js`
**功能**: 验证修复后的并发控制效果

#### 使用方法
```bash
# 在 dcMes_server 目录下运行
cd dcMes_server
node test/concurrency-test.js
```

#### 测试内容
- 并发更新产出数量测试
- 应用层锁机制测试
- 压力测试

#### 预期结果
```
🚀 开始并发安全性测试

开始并发测试...
测试场景：5个并发请求同时更新同一个条码的产出数量

=== 测试结果分析 ===
成功更新: 1次
跳过重复: 4次
执行失败: 0次

✅ 测试通过：成功防止了重复更新！
```

## 部署步骤

### 第一步：创建数据库索引
```bash
cd dcMes_server
node config/database-indexes.js
```
这将创建必要的数据库索引，提高重复检查查询的性能。

### 第二步：检测现有重复数据
```bash
cd dcMes_server
node scripts/duplicate-detection.js
```
分析当前系统中是否存在重复的产出统计数据。

### 第三步：部署修复代码
确保 `services/materialProcessFlowService.js` 中的 `updateWorkOrderQuantity` 方法已更新为最新版本，包含：
- 事务控制
- 重复检查机制
- 应用层锁
- 操作唯一标识

### 第四步：验证修复效果
```bash
cd dcMes_server
node test/concurrency-test.js
```
运行并发测试，确认修复方案生效。

## 关键改进点

### 1. 重复检查机制
- 在更新产出量前检查1分钟内是否已有相同条码的产出记录
- 使用正则表达式匹配相关的产出原因
- 时间窗口防重复（1分钟内防止重复操作）

### 2. 应用层锁
- 为每个操作创建唯一锁标识
- 30秒超时自动释放
- 防止同一操作的并发执行

### 3. 事务控制
- 使用 MongoDB 事务确保数据一致性
- 所有相关操作在同一事务中完成
- 失败时自动回滚

### 4. 操作唯一标识
- 为每个日志记录添加唯一操作标识
- 防止完全相同的操作重复记录
- 数据库层面的唯一性约束

## 监控建议

### 日常监控
1. **定期运行检测脚本**
   ```bash
   # 每日检测最近1天的数据
   node scripts/duplicate-detection.js
   ```

2. **关注日志输出**
   - 查看控制台中的重复操作跳过日志
   - 监控应用层锁的使用情况

3. **性能监控**
   - 观察数据库查询性能变化
   - 监控索引使用情况

### 告警设置
建议设置以下监控告警：
- 重复记录数量超过阈值
- 异常增长的条码数量
- 数据库连接异常
- 并发测试失败

## 故障排除

### 常见问题

#### 1. 数据库连接失败
**现象**: 脚本提示"数据库连接失败"
**解决方案**:
- 检查网络连接
- 确认数据库服务状态
- 验证连接字符串和凭据

#### 2. 索引创建失败
**现象**: 索引创建过程中报错
**解决方案**:
- 检查数据库权限
- 确认集合是否存在
- 查看具体错误信息

#### 3. 并发测试失败
**现象**: 测试显示仍有重复更新
**解决方案**:
- 确认修复代码已部署
- 检查应用层锁是否正常工作
- 验证数据库事务支持

## 版本说明

### v1.0.0 (当前版本)
- 实现基础的重复检查机制
- 添加应用层锁控制
- 支持事务操作
- 提供完整的检测和测试工具

### 计划改进
- 支持 Redis 分布式锁（更适合多实例部署）
- 增加实时监控面板
- 添加自动修复功能
- 优化性能和内存使用

## 联系信息

如有问题或建议，请联系开发团队。

---
*最后更新时间: 2024年12月* 