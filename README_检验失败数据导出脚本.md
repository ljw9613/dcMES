# 检验失败数据导出脚本使用说明

## 功能概述

这个脚本用于导出指定工单中所有条码对应的检验失败数据。脚本会：

1. 根据工单ID从 `material_process_flow` 集合中查找所有相关条码
2. 根据条码从 `inspection_data` 集合中查找所有检验失败的记录（`error: true`）
3. 将失败的检验数据导出为Excel文件并压缩

## 安装依赖

在项目根目录下运行以下命令安装所需依赖：

```bash
npm install
```

或者手动安装：

```bash
npm install mongoose xlsx archiver
```

## 数据库配置

在使用脚本前，请根据您的数据库配置修改 `export_failed_inspection_data.js` 文件中的数据库连接配置：

```javascript
const DB_CONFIG = {
  host: 'localhost',        // 数据库主机地址
  port: 27017,             // 数据库端口
  database: 'dcmes',       // 数据库名称
  // 如果需要认证，请取消注释并填写用户名密码
  // username: 'your_username',
  // password: 'your_password'
};
```

## 使用方法

### 推荐使用简化版本（避免模型依赖问题）

```bash
node export_failed_inspection_simple.js <工单ID>
```

### 完整版本（包含设备和工序名称）

```bash
node export_failed_inspection_data.js <工单ID>
```

### 测试脚本

```bash
node test_export_script.js <工单ID>
```

### 使用npm脚本

```bash
npm run export-failed-inspection <工单ID>
```

### 示例

```bash
# 推荐：使用简化版本导出
node export_failed_inspection_simple.js 60f1b2c3d4e5f6789abcdef0

# 或使用完整版本（如果遇到模型注册问题，请使用简化版本）
node export_failed_inspection_data.js 60f1b2c3d4e5f6789abcdef0

# 先测试脚本功能
node test_export_script.js 60f1b2c3d4e5f6789abcdef0
```

## 输出说明

### 控制台输出

脚本运行时会显示详细的进度信息：

```
🚀 开始导出工单检验失败数据...
工单ID: 60f1b2c3d4e5f6789abcdef0

正在连接数据库...
✅ 数据库连接成功
🔍 正在查找工单 60f1b2c3d4e5f6789abcdef0 对应的条码...
✅ 找到 150 个条码
🔍 正在查找检验失败的记录...
正在处理第 1 批条码 (100 个)...
正在处理第 2 批条码 (50 个)...
✅ 找到 25 条失败的检验记录
📊 正在格式化检验数据...
📝 正在生成Excel文件...
✅ Excel文件已生成: 工单60f1b2c3d4e5f6789abcdef0_检验失败数据_2024-10-08T10-30-45.xlsx
🗜️  正在压缩文件...
✅ 文件已压缩: 工单60f1b2c3d4e5f6789abcdef0_检验失败数据_2024-10-08T10-30-45.zip (12345 bytes)

📊 ===== 统计报告 =====
工单ID: 60f1b2c3d4e5f6789abcdef0
总条码数量: 150
检验失败记录数: 25
有失败记录的条码数: 20

按设备统计失败次数:
  测试设备A: 15 次
  测试设备B: 10 次

按工序统计失败次数:
  电性能测试: 20 次
  外观检查: 5 次
========================

🎉 导出完成！压缩文件保存在: /path/to/output/工单60f1b2c3d4e5f6789abcdef0_检验失败数据_2024-10-08T10-30-45.zip
🔌 数据库连接已关闭
```

### 输出文件

- **位置**: `./output/` 目录下
- **格式**: 压缩的ZIP文件，包含Excel文件
- **命名**: `工单{工单ID}_检验失败数据_{时间戳}.zip`

### Excel文件内容

导出的Excel文件包含以下列：

| 列名 | 说明 |
|------|------|
| 条码 | 扫描的条码 |
| 物料编码 | 物料编码 |
| 物料名称 | 物料名称 |
| 设备名称 | 检测设备名称 |
| 设备IP | 设备IP地址 |
| 工序名称 | 工序名称 |
| 工序编码 | 工序编码 |
| 检测时间 | 检测时间 |
| 错误状态 | 失败/成功 |
| 数据上传状态 | 已上传/未上传 |
| 上传失败原因 | 上传失败的原因 |
| ... | 其他检验项目数据 |

## 特殊情况处理

### 1. 工单不存在或无条码

```
⚠️  未找到该工单对应的条码记录
⚠️  该工单没有对应的条码，无需导出
```

### 2. 所有检验都通过

```
🎉 该工单的所有条码检验都通过了，没有失败记录！
```

### 3. 无效的工单ID格式

```
❌ 无效的工单ID格式
```

## 性能优化

脚本采用了以下优化措施：

1. **分批查询**: 每批处理100个条码，避免单次查询过大
2. **索引优化**: 利用数据库索引提高查询效率
3. **内存管理**: 及时释放不需要的数据
4. **文件压缩**: 自动压缩输出文件，节省存储空间

## 错误处理

脚本包含完善的错误处理机制：

- 数据库连接失败
- 无效的工单ID
- 文件写入权限问题
- 内存不足等异常情况

所有错误都会在控制台显示详细的错误信息。

## 注意事项

1. **数据库权限**: 确保脚本有读取相关集合的权限
2. **磁盘空间**: 确保有足够的磁盘空间存储导出文件
3. **网络连接**: 确保数据库网络连接稳定
4. **工单ID格式**: 必须是有效的MongoDB ObjectId格式

## 故障排除

### 常见问题

1. **模型注册错误 (Schema hasn't been registered for model "machine")**
   - **解决方案**: 使用简化版本脚本 `export_failed_inspection_simple.js`
   - **原因**: 完整版本使用了populate功能，需要注册相关模型
   - **简化版本**: 不使用populate，直接显示ID而不是名称

2. **连接数据库失败**
   - 检查数据库配置是否正确
   - 确认数据库服务是否运行
   - 检查网络连接
   - 确认用户名和密码是否正确

3. **找不到工单数据**
   - 确认工单ID是否正确
   - 检查工单是否存在于数据库中
   - 确认数据库名称是否正确

4. **权限问题**
   - 确保脚本有读取数据库的权限
   - 检查输出目录的写入权限

5. **内存不足**
   - 对于大量数据，考虑增加系统内存
   - 或者分批处理更小的数据集

### 版本选择建议

- **推荐使用**: `export_failed_inspection_simple.js` - 稳定可靠，避免模型依赖问题
- **完整版本**: `export_failed_inspection_data.js` - 包含设备和工序名称，但可能遇到模型注册问题
- **测试版本**: `test_export_script.js` - 用于验证数据和连接，不生成文件

## 技术支持

如果遇到问题，请检查：

1. Node.js版本（建议14.0+）
2. 数据库版本兼容性
3. 依赖包版本
4. 系统资源使用情况

## 更新日志

### v1.0.0 (2024-10-08)
- 初始版本发布
- 支持工单检验失败数据导出
- 支持数据压缩和统计报告
- 完善的错误处理和进度显示
