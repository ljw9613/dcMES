# 缓存管理快速参考卡 🚀

## 📌 一句话总结

**只有条码规则需要清缓存，工艺工序调整实时生效！**

---

## ✅ 实时生效（不用管）

| 修改内容 | 是否实时 | 说明 |
|---------|---------|------|
| 工艺调整 | ✅ 实时 | Craft 表，直接查数据库 |
| 工序调整 | ✅ 实时 | ProcessStep 表，直接查数据库 |
| 工序物料 | ✅ 实时 | ProcessMaterials 表，直接查数据库 |
| 物料信息 | ✅ 实时 | Material 表，直接查数据库 |

---

## ⚠️ 需要清缓存（5分钟延迟）

| 修改内容 | 延迟时间 | 解决方案 |
|---------|---------|---------|
| 条码规则 | 最多5分钟 | 调用清除缓存API |
| 产品条码规则 | 最多5分钟 | 调用清除缓存API |

---

## 🔧 清除缓存 API（3种方式）

### 1️⃣ 清除单个物料

```javascript
const MaterialProcessFlowService = require('./services/materialProcessFlowService');

// 当修改某个产品的条码规则时
MaterialProcessFlowService.clearBarcodeRuleCache('物料ID');
```

### 2️⃣ 批量清除

```javascript
// 当批量修改多个产品的条码规则时
MaterialProcessFlowService.clearBarcodeRuleCache(['物料ID1', '物料ID2']);
```

### 3️⃣ 清除全部

```javascript
// 当修改全局条码规则时
MaterialProcessFlowService.clearBarcodeRuleCache();
```

---

## 💡 实际使用示例

### 场景1：修改全局条码规则

```javascript
// 1. 更新数据库
await BarcodeRule.updateOne({ _id: ruleId }, { $set: {...} });

// 2. 清除所有缓存 ⭐
MaterialProcessFlowService.clearBarcodeRuleCache();
```

### 场景2：修改产品条码规则

```javascript
// 1. 更新数据库
await ProductBarcodeRule.updateOne({ productId }, { $set: {...} });

// 2. 清除该产品缓存 ⭐
MaterialProcessFlowService.clearBarcodeRuleCache(productId);
```

### 场景3：修改工序（不需要清缓存）

```javascript
// 直接修改即可，立即生效 ✅
await ProcessStep.updateOne({ _id: stepId }, { $set: { sort: 5 } });
// 无需清除缓存！
```

---

## 📊 查看缓存状态

```javascript
const stats = MaterialProcessFlowService.getBarcodeRuleCacheStats();
console.log(stats);
// {
//   total: 15,          // 总数
//   active: 12,         // 有效的
//   expired: 3,         // 过期的
//   cacheTimeout: '300秒'
// }
```

---

## 🎯 记忆口诀

> **改规则清缓存，改工艺不用管！**
> 
> **清缓存在更新后，成功提交再执行！**

---

## ⚡ 性能数据

| 指标 | 有缓存 | 无缓存 | 提升 |
|------|--------|--------|------|
| 条码验证 | ~20ms | ~150ms | **87%** |
| 缓存命中率 | >90% | - | - |
| 规则查询 | 内存读取 | 数据库查询 | **10倍+** |

---

## 📞 快速帮助

### 忘记清缓存了怎么办？

不用担心！最多等 5 分钟缓存自动过期。

### PM2 多进程怎么办？

每个进程独立缓存，但都会自动过期。如需立即生效，可以：
1. 重启服务：`pm2 reload dcmes-server`
2. 或实现进程间通信（见详细文档）

### 如何确认缓存已清除？

查看日志输出：
```
🗑️ 已清除物料 xxx 的条码规则缓存
```

---

## 📚 详细文档

- [缓存管理最佳实践.md](./缓存管理最佳实践.md) - 完整指南
- [性能优化实施总结.md](./性能优化实施总结.md) - 优化详情
- [PM2部署指南.md](./PM2部署指南.md) - 部署说明

---

**最后更新:** 2025-10-31  
**版本:** v1.0

