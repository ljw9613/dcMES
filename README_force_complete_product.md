# 产品条码强制完成和解绑条码恢复脚本

## 脚本概述

`force_complete_product.js` 是一个独立的 Node.js 脚本，用于强制完成产品条码的工艺流程进度，并恢复解绑记录中的条码到对应的工艺节点和托盘中。

## 主要功能

### 1. 强制完成工艺流程
- 将指定产品条码的工艺流程状态设置为 `COMPLETED`
- 将流程进度设置为 100%
- 设置所有工艺节点状态为 `COMPLETED`
- 更新完成时间

### 2. 恢复解绑条码
- 查询产品的所有解绑记录
- 将解绑记录中的原始条码恢复到对应的工艺节点
- 只恢复当前为空的 `barcode` 字段

### 3. 托盘条码恢复
- 检测托盘工序（通过 `batchDocNumber` 字段）
- 将条码恢复到托盘的 `palletBarcodes` 数组中
- 增加托盘的 `barcodeCount` 计数

## 使用方法

### 基本语法
```bash
node force_complete_product.js [产品条码]
```

### 使用示例
```bash
# 处理单个产品条码
node force_complete_product.js ABC123456789

# 在dcMes项目根目录下执行
cd /path/to/dcmes/dechang-mes
node force_complete_product.js DEF987654321
```

node batch_force_complete_product.js --file sample_barcodes.txt

## 脚本执行流程

### 1. 初始化阶段
```
🚀 产品条码强制完成和解绑条码恢复脚本
==================================================
✅ 数据库连接成功
```

### 2. 产品信息查询
```
🔄 开始处理产品条码: ABC123456789
📋 找到工艺流程记录: 507f1f77bcf86cd799439011
   物料编码: 1108102001
   物料名称: 测试产品
   当前状态: IN_PROCESS
   当前进度: 75%
```

### 3. 解绑记录查询
```
🔍 查询解绑记录...
📝 找到 2 条解绑记录:
   1. 工序: 装配工序
      解绑时间: 2024-01-15T10:30:00.000Z
      解绑原因: 部件故障
      解绑物料数量: 1
         - MAT001: BAR456789
   2. 工序: 测试工序
      解绑时间: 2024-01-15T11:00:00.000Z
      解绑原因: 测试异常
      解绑物料数量: 1
         - MAT002: BAR987654
```

### 4. 条码恢复阶段
```
🔄 开始恢复解绑条码...
🔧 处理工序: 装配工序
   ✅ 恢复条码: BAR456789
   🗂️  检查托盘: PALLET001
   ✅ 条码 BAR456789 已恢复到托盘 PALLET001
   📊 托盘条码数量: 25
🔧 处理工序: 测试工序
   ✅ 恢复条码: BAR987654
✅ 条码恢复完成，已保存更新
```

### 5. 强制完成阶段
```
🚀 强制完成工艺流程...
   ✅ 主流程状态更新为: COMPLETED (100%)
   ✅ 节点 1 (上料工序) 状态更新为: COMPLETED
   ✅ 节点 2 (装配工序) 状态更新为: COMPLETED
   ✅ 节点 3 (测试工序) 状态更新为: COMPLETED
✅ 工艺流程强制完成成功
```

### 6. 完成阶段
```
✅ 产品条码 ABC123456789 处理完成
🎉 脚本执行成功！
✅ 数据库连接已关闭
```

## 数据库操作详情

### 1. MaterialProcessFlow 表更新
- `status`: 更新为 "COMPLETED"
- `progress`: 更新为 100
- `endTime`: 设置为当前时间
- `processNodes[].status`: 所有节点更新为 "COMPLETED"
- `processNodes[].barcode`: 恢复解绑的条码
- `processNodes[].scanTime`: 设置为当前时间
- `updateAt`: 更新为当前时间

### 2. MaterialPalletizing 表更新（如适用）
- `palletBarcodes`: 添加恢复的条码记录
- `barcodeCount`: 增加相应数量
- `updateAt`: 更新为当前时间

## 安全机制

### 1. 条码冲突检查
- 只恢复当前为空的 barcode 字段
- 避免覆盖已有的有效条码
- 检查托盘中是否已存在相同条码

### 2. 错误处理
- 数据库连接异常处理
- 未找到记录的友好提示
- 详细的错误日志记录

### 3. 数据一致性
- 使用事务保证数据完整性
- 异常时自动回滚操作

## 注意事项

### 1. 执行前准备
- 确保数据库连接正常
- 确认产品条码的正确性
- 建议先在测试环境验证

### 2. 执行时机
- 建议在非业务高峰期执行
- 避免与其他系统操作冲突
- 确保相关用户已停止操作

### 3. 执行后验证
- 检查工艺流程状态是否正确
- 验证托盘条码数量是否准确
- 确认解绑记录恢复是否完整

## 常见问题

### Q1: 脚本提示"未找到条码的工艺流程记录"
**A**: 请检查：
- 产品条码是否正确
- 该产品是否已创建工艺流程记录
- 数据库连接是否正常

### Q2: 条码恢复时提示"节点已有条码"
**A**: 这是正常行为，脚本会跳过已有条码的节点，避免覆盖有效数据。

### Q3: 托盘条码数量没有增加
**A**: 请检查：
- 工艺节点是否设置了 `batchDocNumber`
- 托盘记录是否存在
- 条码是否已在托盘中存在

### Q4: 脚本执行中断
**A**: 脚本具有异常处理机制，会自动回滚已执行的操作，可以安全重新执行。

## 技术支持

如遇到问题，请提供以下信息：
1. 完整的错误日志
2. 执行的产品条码
3. 数据库环境信息
4. 脚本执行时间

## 版本更新记录

### v1.0.0 (2024-01-15)
- 初始版本发布
- 支持产品条码强制完成
- 支持解绑条码恢复
- 支持托盘条码恢复 