(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-6d433d02"],{"14e1":function(e,t,a){e.exports=a.p+"static/media/cfbd.7c42ce8c.mp3"},"31b6":function(e,t,a){e.exports=a.p+"static/media/bdcg.762434df.mp3"},"33fd":function(e,t,a){e.exports=a.p+"static/media/tmyw.a5dd40df.mp3"},4907:function(e,t,a){},"69f4":function(e,t,a){"use strict";a("4907")},"77d2":function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"b",(function(){return s}));var r=a("b775");function n(e){return Object(r.a)({url:"/machine/progress",method:"get",params:e})}function s(e){return Object(r.a)({url:"/machine/refresh",method:"post",data:e})}},"940a":function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var r=a("b775");function n(e){return Object(r.a)({url:"/material-barcode/create",method:"post",data:e})}},bbfb:function(e,t,a){e.exports=a.p+"static/media/pcwlxz.d84138bb.mp3"},de6b:function(e,t,a){e.exports=a.p+"static/media/smcg.fe637541.mp3"},ed8c:function(e,t,a){"use strict";function r(e){new Audio(e).play().catch((function(e){console.warn("音频播放失败:",e)}))}a.d(t,"a",(function(){return r}))},ed91:function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"c",(function(){return s})),a.d(t,"d",(function(){return c})),a.d(t,"e",(function(){return i})),a.d(t,"b",(function(){return o}));var r=a("b775");function n(e){return Object(r.a)({url:"/create-flow",method:"post",data:e})}function s(e){return Object(r.a)({url:"/scan-components",method:"post",data:e})}function c(e){return Object(r.a)({url:"/unbind-components",method:"post",data:e})}function i(e){return Object(r.a)({url:"/update-flow-nodes",method:"post",data:e})}function o(e){return Object(r.a)({url:"/all-process-steps/".concat(e),method:"get"})}},efc1:function(e,t,a){e.exports=a.p+"static/media/cxwgd.275a0cbb.mp3"},f783:function(e,t,a){"use strict";a.r(t);var r=(a("f559"),a("456d"),a("8615"),a("6b54"),a("a481"),a("4917"),a("3b2b"),a("28a5"),a("7f7f"),a("b85c")),n=(a("6762"),a("2fdb"),a("7514"),a("ac6a"),a("2909")),s=a("c7eb"),c=(a("96cf"),a("1da1")),i=a("7e1e"),o=a("77d2"),l=a("ed91"),u=a("940a"),d=a("6ace"),p=a("ed8c"),m=a("de6b"),h=a.n(m),f=a("33fd"),b=a.n(f),v=a("31b6"),g=a.n(v),k=a("14e1"),I=a.n(k),x=a("bbfb"),w=a.n(x),S=a("efc1"),_=a.n(S),O=a("f341"),j={name:"ScanBarCode",components:{ZrSelect:d.a,TscPrinter:O.a},data:function(){return{autoInit:!0,formData:{productModel:"",productLine:"",processStep:"",componentName:"",productionPlanWorkOrderId:"",workProductionPlanWorkOrderNo:"",workProductionPlanWorkOrderId:""},productOptions:[],processStepOptions:[],materialOptions:[],materialLoading:!1,mainMaterialName:"",mainMaterialCode:"",workmainMaterialId:"",workmainMaterialCode:"",processMaterials:[],scanForm:{mainBarcode:"",barcodes:{}},productLineOptions:[{_id:"1",FNumber:"1",FName:"产线1"},{_id:"2",FNumber:"2",FName:"产线2"}],validateStatus:{mainBarcode:!1},loading:!1,unifiedScanInput:"",hasEditPermission:!1,scanTimer:null,batchMaterialCache:{},printDialogVisible:!1,currentBatchBarcode:"",autoPrint:!1,isCollapsed:!1,websocketConnected:!1,ws:null,heartbeatTimer:null,reconnectAttempts:0,maxReconnectAttempts:5,batchUsageCount:{},barcodeRules:[],materialBarcodeRules:[]}},computed:{mainMaterialId:{get:function(){return localStorage.getItem("mainMaterialId")||""},set:function(e){localStorage.setItem("mainMaterialId",e)}},processStepId:{get:function(){return localStorage.getItem("processStepId")||""},set:function(e){localStorage.setItem("processStepId",e)}},materialName:{get:function(){return localStorage.getItem("materialName")||""},set:function(e){localStorage.setItem("materialName",e)}},processName:{get:function(){return localStorage.getItem("processName")||""},set:function(e){localStorage.setItem("processName",e)}},workProductionPlanWorkOrderId:{get:function(){return localStorage.getItem("workProductionPlanWorkOrderId")||""},set:function(e){localStorage.setItem("workProductionPlanWorkOrderId",e)}},productLineId:{get:function(){return localStorage.getItem("productLineId")||""},set:function(e){localStorage.setItem("productLineId",e)}},productLineName:{get:function(){return localStorage.getItem("productLineName")||""},set:function(e){localStorage.setItem("productLineName",e)}},autoInitMode:{get:function(){return"true"===localStorage.getItem("autoInit")},set:function(e){localStorage.setItem("autoInit",e)}},workProductionPlanWorkOrderNo:{get:function(){return localStorage.getItem("workProductionPlanWorkOrderNo")||""},set:function(e){localStorage.setItem("workProductionPlanWorkOrderNo",e)}}},watch:{mainMaterialId:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=5;break}return e.next=3,this.getMainMaterialInfo();case 3:e.next=6;break;case 5:this.mainMaterialName="";case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),processStepId:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=6;break}return console.log(t,"newVal============="),e.next=4,this.getProcessMaterials();case 4:e.next=9;break;case 6:this.processMaterials=[],this.scanForm.barcodes={},this.validateStatus={mainBarcode:!1};case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),validateStatus:{handler:function(e){},deep:!0}},methods:{handleAutoInitChange:function(e){this.autoInit=e,this.autoInitMode=e,this.$message.success("已".concat(e?"开启":"关闭","自动初始化模式")),e&&window.location.reload()},getAutoInitConfig:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,r,n,c,i,l;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.processStepId="",e.next=4,Object(o.a)();case 4:if(t=e.sent,console.log("获取到的机器进度:",t.data),200!==t.code||!t.data){e.next=15;break}a=t.data,r=a.materialId,n=a.processStepId,c=a.lineId,i=a.productionPlanWorkOrderId,console.log("materialId:",r),console.log("processStepId:",n.processName),console.log("lineId:",c),console.log("workProductionPlanWorkOrderId:",i),r&&n?(console.log("materialId:",r),console.log("processStepId:",n.processName),console.log("lineId:",c),this.mainMaterialId=r._id,l=n._id,this.processStepId=l,this.formData.productModel=r._id,this.formData.processStep=n._id,this.formData.productLine=c&&c._id,this.formData.workProductionPlanWorkOrderId=i&&i._id,this.formData.workProductionPlanWorkOrderNo=i&&i.workOrderNo,this.workProductionPlanWorkOrderId=i&&i._id,this.workProductionPlanWorkOrderNo=i&&i.workOrderNo,this.materialName="".concat(r.FNumber," - ").concat(r.FName),this.processName=n.processName,c&&(this.productLineId=c._id,this.productLineName=c.lineName,this.formData.lineName=c.lineName),this.$message.success("自动初始化工序成功"),l!==this.processStepId&&this.handleSave()):this.$message.warning("未获取到机器进度配置"),e.next=16;break;case 15:throw new Error(t.message||"获取机器进度失败");case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(0),console.error("自动初始化失败:",e.t0),this.$message.error("自动初始化失败: "+e.t0.message);case 22:case"end":return e.stop()}}),e,this,[[0,18]])})));return function(){return e.apply(this,arguments)}}(),getProductBarcodeRules:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(i.b)("product_barcode_rule",{query:{productId:{$in:t}},populate:JSON.stringify([{path:"barcodeRule",match:{enabled:!0}}])});case 3:a=e.sent,this.materialBarcodeRules=[],a.data&&(this.materialBarcodeRules=a.data.map((function(e){return e.barcodeRule}))),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("获取条码规则失败:",e.t0),this.$message.error("获取条码规则失败");case 12:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(t){return e.apply(this,arguments)}}(),handlePrintBatch:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,r=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.$loading({lock:!0,text:"正在生成批次条码...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),e.prev=1,this.mainMaterialCode){e.next=4;break}throw new Error("未获取到物料编码信息");case 4:return e.next=6,Object(u.a)({materialCode:this.mainMaterialCode});case 6:if(200!==(a=e.sent).code||!a.data.batchId){e.next=27;break}return this.currentBatchBarcode=a.data.batchId,e.next=11,this.$nextTick();case 11:if(!this.autoPrint){e.next=23;break}if(!this.currentBatchBarcode||!this.mainMaterialCode){e.next=20;break}return e.next=15,this.$refs.tscPrinter.print();case 15:return this.unifiedScanInput=this.currentBatchBarcode,e.next=18,this.handleUnifiedScan(this.currentBatchBarcode);case 18:e.next=21;break;case 20:throw new Error("打印数据未准备就绪");case 21:e.next=24;break;case 23:this.$refs.tscPrinter.dialogVisible=!0;case 24:this.$nextTick((function(){r.$refs.scanInput.focus()})),e.next=28;break;case 27:throw new Error("批次条码生成失败");case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(1),this.$message.error(e.t0.message||"批次条码生成失败");case 33:return e.prev=33,t.close(),this.$nextTick((function(){r.$refs.scanInput.focus()})),e.finish(33);case 37:case"end":return e.stop()}}),e,this,[[1,30,33,37]])})));return function(){return e.apply(this,arguments)}}(),handleWorkOrderSelect:function(e){e&&(this.formData.workProductionPlanWorkOrderNo=e.workOrderNo,this.formData.workProductionPlanWorkOrderId=e._id,this.workProductionPlanWorkOrderNo=e.workOrderNo,this.workProductionPlanWorkOrderId=e._id)},handleProductionLineSelect:function(e){e&&(this.formData.lineName=e.lineName,this.formData.productLine=e._id,localStorage.setItem("productLineName",e.lineName),localStorage.setItem("productLineId",e._id))},getMaterialById:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.b)("k3_BD_MATERIAL",{query:{_id:t}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getCraftByMaterialId:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.b)("craft",{query:{materialId:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessStepById:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.b)("processStep",{query:{_id:t},sort:{sort:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getWorkProductionPlanWorkOrderById:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.b)("production_plan_work_order",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessMaterialById:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(i.b)("processMaterials",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getMaterialList:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===t){e.next=18;break}return this.materialLoading=!0,e.prev=2,e.next=5,Object(i.b)("k3_BD_MATERIAL",{query:{$or:[{FNumber:{$regex:t,$options:"i"}},{FName:{$regex:t,$options:"i"}}]},page:1,limit:20});case 5:a=e.sent,this.productOptions=a.data,e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("获取产品型号失败:",e.t0),this.$message.error("获取产品型号失败");case 13:return e.prev=13,this.materialLoading=!1,e.finish(13);case 16:e.next=19;break;case 18:this.productOptions=[];case 19:case"end":return e.stop()}}),e,this,[[2,9,13,16]])})));return function(t){return e.apply(this,arguments)}}(),handleProductChange:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a,r,n;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t._id,this.processStepOptions=[],this.formData.processStep="",this.mainMaterialId="",a){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,e.next=9,Object(l.b)(a);case 9:r=e.sent,n=r.data,console.log("获取到的工序:",n),this.processStepOptions=n,this.formData.productModel=a,e.next=20;break;case 16:e.prev=16,e.t0=e.catch(6),console.error("获取工序列表失败:",e.t0),this.$message.error("获取工序列表失败");case 20:case"end":return e.stop()}}),e,this,[[6,16]])})));return function(t){return e.apply(this,arguments)}}(),handleProcessChange:function(e){e?this.formData.processStep=e:this.processStepId=""},handleSave:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.formData.productModel&&this.formData.processStep&&this.formData.productLine){e.next=3;break}return this.$message.warning("请选择产品型号、工序和产线"),e.abrupt("return");case 3:return e.prev=3,t=this.$loading({lock:!0,text:"保存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),this.resetScanForm(),this.mainMaterialId=this.formData.productModel,this.processStepId=this.formData.processStep,this.productLineId=this.formData.productLine,e.next=11,this.getMaterialById(this.formData.productModel);case 11:return(a=e.sent)&&(this.materialName="".concat(a.FNumber," - ").concat(a.FName)),e.next=15,this.getProcessStepById(this.formData.processStep);case 15:(r=e.sent)&&(this.processName=r.processName),this.$message.success("保存成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(3),console.error("保存失败:",e.t0),this.$message.error("保存失败"),loading.close();case 26:case"end":return e.stop()}}),e,this,[[3,21]])})));return function(){return e.apply(this,arguments)}}(),getMainMaterialInfo:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取主物料信息，ID:",this.mainMaterialId),e.next=4,Object(i.b)("k3_BD_MATERIAL",{query:{_id:this.mainMaterialId},page:1,limit:1});case 4:(t=e.sent).data&&t.data[0]?(console.log("获取到的主物料信息:",t.data[0]),this.mainMaterialName=t.data[0].FName,this.mainMaterialCode=t.data[0].FNumber):(console.log("未找到主物料信息"),this.mainMaterialName="",this.mainMaterialCode=""),e.next=14;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("获取主物料信息失败:",e.t0),this.$message.error("获取主物料信息失败"),this.mainMaterialName="",this.mainMaterialCode="";case 14:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),getProcessMaterials:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,r,c,o,l,u,d=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取工序信息，ID:",this.processStepId),e.next=4,Object(i.b)("processStep",{query:{_id:this.processStepId},page:1,limit:1});case 4:if((t=e.sent).data&&0!==!t.data.length){e.next=7;break}throw new Error("未找到工序信息");case 7:return a=t.data[0],e.next=10,Object(i.b)("craft",{query:{_id:a.craftId},page:1,limit:1});case 10:if((r=e.sent).data&&0!==!r.data.length){e.next=13;break}throw new Error("未找到工艺信息");case 13:return c=r.data[0],e.next=16,this.getMaterialById(c.materialId);case 16:if(o=e.sent){e.next=19;break}throw new Error("未找到物料信息");case 19:return this.workmainMaterialId=o._id,this.workmainMaterialCode=o.FNumber,this.mainMaterialName=o.FName,this.mainMaterialCode=o.FNumber,e.prev=23,e.next=26,Object(i.b)("processMaterials",{query:{processStepId:this.processStepId}});case 26:if(!(l=e.sent).data){e.next=37;break}return this.processMaterials=l.data,u=[o._id].concat(Object(n.a)(this.processMaterials.map((function(e){return e.materialId})))),e.next=32,this.getProductBarcodeRules(u);case 32:this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={},this.processMaterials.forEach((function(e){d.validateStatus[e._id]=!1,d.$set(d.scanForm.barcodes,e._id,"")})),e.next=40;break;case 37:this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 40:e.next=49;break;case 42:e.prev=42,e.t0=e.catch(23),console.error("获取工序物料失败:",e.t0),this.$message.error("获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 49:e.next=58;break;case 51:e.prev=51,e.t1=e.catch(0),console.error("获取工序物料失败:",e.t1),this.$message.error(e.t1.message||"获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 58:case"end":return e.stop()}}),e,this,[[0,51],[23,42]])})));return function(){return e.apply(this,arguments)}}(),validateDICode:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a,r,c,o;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(i.b)("productDiNum",{query:{diNum:t},populate:JSON.stringify([{path:"productId",model:"k3_BD_MATERIAL"}])});case 3:if(0!==(a=e.sent).data.length){e.next=7;break}return this.$message.error("该DI编码不存在本系统"),e.abrupt("return",{isValid:!1});case 7:if(r=a.data.filter((function(e){return e.productId&&e.productId.FNumber})).map((function(e){return e.productId.FNumber})),0!==r.length){e.next=11;break}return this.$message.error("该DI编码未关联有效物料"),e.abrupt("return",{isValid:!1});case 11:if(c=[this.mainMaterialCode].concat(Object(n.a)(this.processMaterials.map((function(e){return e.materialCode})))),o=r.find((function(e){return c.includes(e)})),o){e.next=16;break}return this.$message.error("该DI编码对应的物料与当前工序不匹配"),e.abrupt("return",{isValid:!1});case 16:return e.abrupt("return",{isValid:!0,materialCode:o});case 19:return e.prev=19,e.t0=e.catch(0),console.error("DI码验证失败:",e.t0),this.$message.error("DI码验证失败"),e.abrupt("return",{isValid:!1});case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),validateBarcode:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a,n,c,i,o,l,u,d,p,m,h,f,b,v,g,k,I,x,w,S,_,O;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("validateBarcode",t),t){e.next=3;break}return e.abrupt("return",!1);case 3:e.prev=3,a=this.materialBarcodeRules,n=Object(r.a)(a),e.prev=6,n.s();case 8:if((c=n.n()).done){e.next=105;break}i=c.value,o=!0,l=null,u=null,d=t,p=Object(r.a)(i.validationRules),e.prev=15,p.s();case 17:if((m=p.n()).done){e.next=35;break}if((h=m.value).enabled){e.next=21;break}return e.abrupt("continue",33);case 21:e.t0=h.type,e.next="length"===e.t0?24:"substring"===e.t0?26:"regex"===e.t0?29:31;break;case 24:return d.length!==h.params.length&&(o=!1),e.abrupt("break",31);case 26:return d.substring(h.params.start,h.params.end)!==h.params.expectedValue&&(o=!1),e.abrupt("break",31);case 29:try{new RegExp(h.params.pattern).test(d)||(o=!1)}catch(e){console.error("正则表达式错误:",e),o=!1}return e.abrupt("break",31);case 31:if(o){e.next=33;break}return e.abrupt("break",35);case 33:e.next=17;break;case 35:e.next=40;break;case 37:e.prev=37,e.t1=e.catch(15),p.e(e.t1);case 40:return e.prev=40,p.f(),e.finish(40);case 43:if(!o){e.next=103;break}f=Object(r.a)(i.extractionConfigs),e.prev=45,f.s();case 47:if((b=f.n()).done){e.next=91;break}v=b.value,g=t,k=Object(r.a)(v.steps),e.prev=51,k.s();case 53:if((I=k.n()).done){e.next=69;break}if((x=I.value).enabled){e.next=57;break}return e.abrupt("continue",67);case 57:e.t2=x.type,e.next="split"===e.t2?60:"substring"===e.t2?63:"regex"===e.t2?65:67;break;case 60:return w=g.split(x.params.separator),g=w[x.params.index]||"",e.abrupt("break",67);case 63:return g=g.substring(x.params.start,x.params.end),e.abrupt("break",67);case 65:try{S=new RegExp(x.params.pattern),_=g.match(S),g=_&&_[x.params.group]?_[x.params.group]:""}catch(e){console.error("正则提取错误:",e),g=""}return e.abrupt("break",67);case 67:e.next=53;break;case 69:e.next=74;break;case 71:e.prev=71,e.t3=e.catch(51),k.e(e.t3);case 74:return e.prev=74,k.f(),e.finish(74);case 77:e.t4=v.target,e.next="materialCode"===e.t4?80:"DI"===e.t4?82:"relatedBill"===e.t4?87:89;break;case 80:return l=g,e.abrupt("break",89);case 82:return e.next=84,this.validateDICode(g);case 84:return(O=e.sent).isValid?l=O.materialCode:o=!1,e.abrupt("break",89);case 87:return u=g,e.abrupt("break",89);case 89:e.next=47;break;case 91:e.next=96;break;case 93:e.prev=93,e.t5=e.catch(45),f.e(e.t5);case 96:return e.prev=96,f.f(),e.finish(96);case 99:if(!o||!l){e.next=103;break}if(l!==this.mainMaterialCode){e.next=103;break}return console.log("条码匹配成功:",i.name),e.abrupt("return",{materialCode:l,isValid:!0,relatedBill:u,ruleName:i.name});case 103:e.next=8;break;case 105:e.next=110;break;case 107:e.prev=107,e.t6=e.catch(6),n.e(e.t6);case 110:return e.prev=110,n.f(),e.finish(110);case 113:return this.$message.error("该条码不符合任何已配置的规则或物料不匹配"),e.abrupt("return",{materialCode:null,isValid:!1});case 117:return e.prev=117,e.t7=e.catch(3),console.error("条码验证失败:",e.t7),this.$message.error("条码验证过程发生错误"),e.abrupt("return",{materialCode:null,isValid:!1});case 122:case"end":return e.stop()}}),e,this,[[3,117],[6,107,110,113],[15,37,40,43],[45,93,96,99],[51,71,74,77]])})));return function(t){return e.apply(this,arguments)}}(),handleMainBarcode:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(i.b)("material_process_flow",{query:{barcode:t}});case 3:if(!((a=e.sent).data&&a.data.length>0)){e.next=9;break}a.data[0],this.$message.success("扫描成功"),e.next=17;break;case 9:return e.next=11,Object(l.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:t,productLineId:this.productLineId,productLineName:this.productLineName});case 11:if(200!==(r=e.sent).code){e.next=16;break}this.$message.success("成品条码追溯记录创建成功"),e.next=17;break;case 16:throw new Error(r.msg||"创建成品条码追溯记录失败");case 17:e.next=24;break;case 19:throw e.prev=19,e.t0=e.catch(0),console.error("处理主条码失败:",e.t0),Object(p.a)(b.a),e.t0;case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),handleSubBarcode:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t,a){var r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=this.processMaterials.find((function(e){return e._id===t})),r){e.next=4;break}throw new Error("未找到对应的物料信息");case 4:if(r.materialCode===a){e.next=6;break}throw new Error("物料编码不一致");case 6:this.validateStatus[t]=!0,this.$message.success("扫码成功"),e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),console.error("处理子物料条码失败:",e.t0),Object(p.a)(b.a),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t,a){return e.apply(this,arguments)}}(),fillFormData:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.mainMaterialId&&this.materialName&&(this.formData.productName=this.materialName),this.processStepId&&this.processName&&(this.formData.processStep=this.processName),this.productLineId&&this.productLineName&&(this.formData.productLine=this.productLineId,this.formData.lineName=this.productLineName);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),resetScanForm:function(){var e=this;this.scanForm.mainBarcode="";var t={};this.processMaterials.forEach((function(a){if(a.isBatch){var r="batch_".concat(e.mainMaterialId,"_").concat(e.processStepId,"_").concat(a._id),n="".concat(r,"_usage"),s=localStorage.getItem(r),c=parseInt(localStorage.getItem(n)||"0");!a.batchQuantity||s&&c<a.batchQuantity?(t[a._id]=s,e.$set(e.validateStatus,a._id,!0)):(localStorage.removeItem(r),localStorage.removeItem(n),t[a._id]="",e.$set(e.validateStatus,a._id,!1))}else t[a._id]="",e.$set(e.validateStatus,a._id,!1)})),this.scanForm.barcodes=t,this.$set(this.validateStatus,"mainBarcode",!1),this.currentFlowId=null},handleUnifiedScan:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t){var a=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:this.scanTimer&&clearTimeout(this.scanTimer),this.scanTimer=setTimeout(Object(c.a)(Object(s.a)().mark((function e(){var n,c,i,o,l,u,d,m,f,v,g,k,I;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=t.trim().replace(/[\r\n]/g,"")){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,a.validateBarcode(n);case 6:if((c=e.sent).isValid){e.next=13;break}return setTimeout((function(){Object(p.a)(b.a)}),300),a.$notify({title:"条码验证失败",message:"条码格式不正确,未在系统中注册",type:"error",duration:3e3,position:"top-right"}),a.unifiedScanInput="",a.$refs.scanInput.focus(),e.abrupt("return");case 13:if(i=c.materialCode,o=!1,i!==a.mainMaterialCode){e.next=23;break}return a.scanForm.mainBarcode=t,a.validateStatus.mainBarcode=!0,e.next=20,a.handleMainBarcode(t);case 20:Object(p.a)(h.a),a.$notify({title:"主物料扫描成功",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>物料名称: '.concat(a.mainMaterialName,"</div>\n                                    <div>物料编码: ").concat(i,"</div>\n                                    <div>条码: ").concat(t,"</div>\n                                </div>\n                            "),type:"success",duration:3e3,position:"top-right"}),o=!0;case 23:if(o){e.next=74;break}l=Object(r.a)(a.processMaterials),e.prev=25,l.s();case 27:if((u=l.n()).done){e.next=66;break}if((d=u.value).materialCode!==i){e.next=64;break}if(!d.isBatch){e.next=56;break}if(m="batch_".concat(a.mainMaterialId,"_").concat(a.processStepId,"_").concat(d._id),f="".concat(m,"_usage"),localStorage.getItem(m)===t){e.next=47;break}return e.next=37,a.queryBatchUsageCount(t,d._id);case 37:if(v=e.sent,!(d.batchQuantity&&v>=d.batchQuantity)){e.next=42;break}return a.$message.warning("批次物料条码 ".concat(t," 已达到使用次数限制 ").concat(d.batchQuantity,"次")),Object(p.a)(w.a),e.abrupt("return");case 42:localStorage.setItem(m,t),localStorage.setItem(f,v.toString()),a.$set(a.batchUsageCount,d._id,v),e.next=56;break;case 47:if(g=parseInt(localStorage.getItem(f)||"0"),!(d.batchQuantity&&g>=d.batchQuantity)){e.next=56;break}return localStorage.removeItem(m),localStorage.removeItem(f),a.$set(a.scanForm.barcodes,d._id,""),a.$set(a.validateStatus,d._id,!1),a.$message.warning("批次物料条码 ".concat(t," 已达到使用次数限制 ").concat(d.batchQuantity,"次")),Object(p.a)(w.a),e.abrupt("return");case 56:return a.$set(a.scanForm.barcodes,d._id,t),a.$set(a.validateStatus,d._id,!0),e.next=60,a.handleSubBarcode(d._id,i);case 60:return Object(p.a)(h.a),a.$notify({title:"子物料扫描成功",dangerouslyUseHTMLString:!0,message:'\n                                        <div style="line-height: 1.5">\n                                            <div>物料名称: '.concat(d.materialName,"</div>\n                                            <div>物料编码: ").concat(d.materialCode,"</div>\n                                            <div>条码: ").concat(t,"</div>\n                                            ").concat(c.relatedBill?"<div>关联单号: ".concat(c.relatedBill,"</div>"):"","\n                                        </div>\n                                    "),type:"success",duration:3e3,position:"top-right"}),o=!0,e.abrupt("break",66);case 64:e.next=27;break;case 66:e.next=71;break;case 68:e.prev=68,e.t0=e.catch(25),l.e(e.t0);case 71:return e.prev=71,l.f(),e.finish(71);case 74:if(k=Object.values(a.validateStatus).every((function(e){return!0===e})),!k){e.next=81;break}return a.$notify({title:"扫描完成",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>所有物料已扫描完成</div>\n                                    <div style="color: #67C23A">正在发送确认提交...</div>\n                                </div>\n                            ',type:"success",duration:3e3,position:"top-right"}),e.next=79,a.handleConfirm();case 79:e.next=83;break;case 81:I=a.processMaterials.filter((function(e){return!a.validateStatus[e._id]})).map((function(e){return"".concat(e.materialName,"(").concat(e.materialCode,")")})).join("\n"),I&&a.$notify({title:"继续扫描",dangerouslyUseHTMLString:!0,message:'\n                                    <div style="line-height: 1.5">\n                                        <div>请继续扫描以下物料：</div>\n                                        <div style="color: #E6A23C; white-space: pre-line">'.concat(I,"</div>\n                                    </div>\n                                "),type:"info",duration:3e3,position:"top-right"});case 83:e.next=90;break;case 85:e.prev=85,e.t1=e.catch(0),console.error("扫描处理失败:",e.t1),setTimeout((function(){Object(p.a)(b.a)}),1e3),a.$notify({title:"扫描失败",message:e.t1.message||"扫描处理失败",type:"error",duration:3e3,position:"top-right"});case 90:return e.prev=90,a.unifiedScanInput="",a.$refs.scanInput.focus(),e.finish(90);case 94:case"end":return e.stop()}}),e,null,[[0,85,90,94],[25,68,71,74]])}))),1e3);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),focusInput:function(){this.$refs.scanInput.focus()},handleCancelSave:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认取消当前工序设置？这将清除所有批次物料的缓存数据。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"取消设置中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),localStorage.removeItem("mainMaterialId"),localStorage.removeItem("processStepId"),localStorage.removeItem("materialName"),localStorage.removeItem("processName"),a=this.formData.productLine,r=this.formData.lineName,this.formData={productModel:"",productLine:a,lineName:r,processStep:"",componentName:""},this.$message.success("已取消工序设置"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("取消设置失败:",e.t0),this.$message.error("取消设置失败"));case 20:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),getValidateIcon:function(e){return this.validateStatus[e]?"el-icon-check success-icon":"el-icon-close error-icon"},handleConfirm:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,n,c,o,u,d,m,h,f,v,k,x,S,O=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=Object.values(this.validateStatus).every((function(e){return!0===e})),t){e.next=5;break}return this.$message.warning("请完成所有条码扫描"),e.abrupt("return");case 5:return e.next=7,Object(i.b)("material_process_flow",{query:{barcode:this.scanForm.mainBarcode}});case 7:if((n=e.sent).data&&0!==n.data.length){e.next=23;break}return e.prev=9,e.next=12,Object(l.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:this.scanForm.mainBarcode,productLineId:this.productLineId,productLineName:this.productLineName});case 12:if(200===(c=e.sent).code){e.next=15;break}throw new Error("创建主流程记录失败");case 15:a=c.data,e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(9),new Error("创建流程记录失败: ".concat(e.t0.message));case 21:e.next=24;break;case 23:a=n.data[0];case 24:if(a){e.next=26;break}throw new Error("未能获取或创建有效的工艺流程记录");case 26:return o=[],this.processMaterials.forEach((function(e){o.push({materialId:e.materialId,barcode:O.scanForm.barcodes[e._id]})})),u={mainBarcode:this.scanForm.mainBarcode,processStepId:this.processStepId,componentScans:o,userId:this.$store.getters.id,lineId:this.formData.productLine},e.next=31,Object(l.c)(u);case 31:if(200===(d=e.sent).code){e.next=34;break}throw new Error(d.message||"扫码失败");case 34:if(200==d.code){m=Object(r.a)(this.processMaterials);try{for(m.s();!(h=m.n()).done;)(f=h.value).isBatch&&this.scanForm.barcodes[f._id]&&(v="batch_".concat(this.mainMaterialId,"_").concat(this.processStepId,"_").concat(f._id),k="".concat(v,"_usage"),x=parseInt(localStorage.getItem(k)||"0"),S=x+1,localStorage.setItem(k,S.toString()),this.$set(this.batchUsageCount,f._id,S),f.batchQuantity&&S>=f.batchQuantity&&(localStorage.removeItem(v),localStorage.removeItem(k),this.$set(this.scanForm.barcodes,f._id,""),this.$set(this.validateStatus,f._id,!1)))}catch(e){m.e(e)}finally{m.f()}setTimeout((function(){Object(p.a)(g.a)}),1e3)}this.resetScanForm(),e.next=43;break;case 38:e.prev=38,e.t1=e.catch(0),this.resetScanForm(),console.error("确认失败:",e.t1),e.t1.message.includes("批次物料条码")?(this.$message.warning(e.t1.message),setTimeout((function(){Object(p.a)(w.a),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),O.processMaterials.forEach((function(e){e.isBatch&&(O.$set(O.scanForm.barcodes,e._id,""),O.$set(O.validateStatus,e._id,!1))}))}),1e3)):e.t1.message.includes("该主物料条码对应工序节点已完成或处于异常状态")?(this.$message.warning(e.t1.message),setTimeout((function(){Object(p.a)(I.a)}),1e3)):"未查询到生产工单"==e.t1.message?(this.$message.error(e.t1.message),setTimeout((function(){Object(p.a)(_.a)}),1e3)):(this.$message.error("确认失败:"+e.t1.message),setTimeout((function(){Object(p.a)(b.a)}),1e3));case 43:case"end":return e.stop()}}),e,this,[[0,38],[9,18]])})));return function(){return e.apply(this,arguments)}}(),handlePrintSuccess:function(){this.$message.success("批次条码打印成功"),this.currentBatchBarcode=""},handlePrintError:function(e){this.$message.error("打印失败: ".concat(e)),this.currentBatchBarcode=""},handleDialogClose:function(){this.printDialogVisible=!1,this.currentBatchBarcode=""},handleAutoPrintChange:function(e){localStorage.setItem("autoPrint",e),this.$message.success("已".concat(e?"开启":"关闭","自动打印模式"))},handleClearCache:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认清除所有页面缓存数据？此操作不可恢复。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"清除缓存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&(localStorage.removeItem(e),localStorage.removeItem("".concat(e,"_usage")))})),this.$message.success("缓存清除成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("清除缓存失败:",e.t0),this.$message.error("清除缓存失败"));case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),toggleCollapse:function(){this.isCollapsed=!this.isCollapsed},initWebSocket:function(){var e=this;try{this.ws&&this.ws.close();var t="ws://192.168.6.250:2223";console.log(t,"VUE_APP_WS_ADDRESS"),this.ws=new WebSocket("".concat(t,"?token=").concat("DcMes_Server_Token")),console.log(this.ws,"this.ws"),this.ws.onopen=function(){e.websocketConnected=!0,e.$message.success("设备服务器连接成功"),e.startHeartbeat(),e.reconnectAttempts=0},this.ws.onclose=function(t){if(e.websocketConnected=!1,e.stopHeartbeat(),console.log("WebSocket连接关闭:",t),e.reconnectAttempts<e.maxReconnectAttempts){e.reconnectAttempts++;var a=Math.min(1e3*Math.pow(2,e.reconnectAttempts),1e4);e.$message.warning("设备连接已断开，".concat(a/1e3,"秒后尝试第").concat(e.reconnectAttempts,"次重连...")),setTimeout((function(){e.initWebSocket()}),a)}else e.$message.error("重连次数已达上限，请检查网络连接或刷新页面")},this.ws.onerror=function(t){e.websocketConnected=!1,console.error("WebSocket连接错误:",t),console.log("错误详情:",{readyState:e.ws.readyState,url:e.ws.url,protocol:e.ws.protocol,error:t})},this.ws.onmessage=function(t){try{var a=JSON.parse(t.data);console.log("收到消息:",a),e.handleWebSocketMessage(a)}catch(e){console.error("消息解析错误:",e)}}}catch(e){console.error("WebSocket初始化失败:",e),this.$message.error("设备连接初始化失败: ".concat(e.message))}},handleWebSocketMessage:function(e){switch(e.type){case"connected":console.log("连接成功，用户ID:",e.userId);break;case"command":"refresh"===e.action&&window.location.reload();break;default:console.log("未知消息类型:",e)}},startHeartbeat:function(){var e=this;this.heartbeatTimer=setInterval((function(){e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"heartbeat"}))}),1e4)},stopHeartbeat:function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)},sendWebSocketMessage:function(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):this.$message.warning("设备未连接")},getBatchUsageText:function(e){var t=this.processMaterials.find((function(t){return t._id===e}));if(!t||!t.isBatch)return"";var a=this.batchUsageCount[e]||0;return"".concat(a,"/").concat(t.batchQuantity)},queryBatchUsageCount:function(){var e=Object(c.a)(Object(s.a)().mark((function e(t,a){var r;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(i.b)("material_process_flow",{query:{processNodes:{$elemMatch:{barcode:t}}}});case 3:return r=e.sent,e.abrupt("return",r.data?r.data.length:0);case 7:return e.prev=7,e.t0=e.catch(0),console.error("查询批次使用记录失败:",e.t0),e.abrupt("return",0);case 11:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,a){return e.apply(this,arguments)}}()},created:function(){var e=Object(c.a)(Object(s.a)().mark((function e(){var t,a,n,c,i,o,l,u,d=this;return Object(s.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=localStorage.getItem("autoPrint"))&&(this.autoPrint="true"===t),this.initWebSocket(),a=localStorage.getItem("autoInit"),this.autoInit="true"===a,!this.autoInit){e.next=8;break}return e.next=8,this.getAutoInitConfig();case 8:if(!this.mainMaterialId){e.next=11;break}return e.next=11,this.getMainMaterialInfo();case 11:if(!this.processStepId){e.next=15;break}return e.next=14,this.getProcessMaterials();case 14:this.processMaterials.forEach((function(e){if(e.isBatch){var t="batch_".concat(d.mainMaterialId,"_").concat(d.processStepId,"_").concat(e._id),a=localStorage.getItem(t);a&&(d.$set(d.scanForm.barcodes,e._id,a),d.$set(d.validateStatus,e._id,!0))}}));case 15:return e.next=17,this.fillFormData();case 17:if(!this.processMaterials){e.next=42;break}n=Object(r.a)(this.processMaterials),e.prev=19,n.s();case 21:if((c=n.n()).done){e.next=34;break}if(!(i=c.value).isBatch){e.next=32;break}if(o="batch_".concat(this.mainMaterialId,"_").concat(this.processStepId,"_").concat(i._id),!(l=localStorage.getItem(o))){e.next=32;break}return e.next=29,this.queryBatchUsageCount(l,i.materialId);case 29:u=e.sent,console.log(u,"count"),u===i.batchQuantity?(this.$message.warning("批次条码使用次数已达到上限"),Object(p.a)(w.a),localStorage.removeItem(o),this.$set(this.scanForm.barcodes,i._id,""),this.$set(this.validateStatus,i._id,!1)):this.$set(this.batchUsageCount,i._id,u);case 32:e.next=21;break;case 34:e.next=39;break;case 36:e.prev=36,e.t0=e.catch(19),n.e(e.t0);case 39:return e.prev=39,n.f(),e.finish(39);case 42:case"end":return e.stop()}}),e,this,[[19,36,39,42]])})));return function(){return e.apply(this,arguments)}}(),mounted:function(){console.log("Complete roles data:",this.$store.getters.roles);var e=this.$store.getters.roles;if(!e||!e.buttonList)return!1;e.buttonList.includes("scan_edit_configuration")&&(this.hasEditPermission=!0),this.mainMaterialId&&this.processStepId&&this.$refs.scanInput.focus()},beforeDestroy:function(){this.scanTimer&&clearTimeout(this.scanTimer),this.ws&&this.ws.close(),this.stopHeartbeat()}},y=j,C=(a("69f4"),a("2877")),M=Object(C.a)(y,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"scan-container"},[a("div",{staticClass:"left-form",class:{collapsed:e.isCollapsed}},[a("el-card",{staticClass:"init-card"},[a("div",{staticClass:"card-header"},[a("span",[a("i",{staticClass:"el-icon-setting"}),e._v("\n                    工序设置")]),e._v(" "),a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"自动","inactive-text":"手动"},on:{change:e.handleAutoInitChange},model:{value:e.autoInit,callback:function(t){e.autoInit=t},expression:"autoInit"}})],1),e._v(" "),a("el-form",{attrs:{model:e.formData,"label-width":"100px"}},[a("div",{staticClass:"form-section"},[a("div",{staticClass:"section-header"},[a("el-tag",{attrs:{type:e.websocketConnected?"success":"danger"}},[a("i",{staticClass:"el-icon-goods"}),e._v("\n                            "+e._s(e.websocketConnected?"已连接":"未连接"))]),e._v(" "),a("span",[e._v("\n                            基础信息\n                        ")])],1),e._v(" "),a("el-form-item",{attrs:{label:"产品型号"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入物料编码/名称搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.productName,callback:function(t){e.$set(e.formData,"productName",t)},expression:"formData.productName"}}):a("zr-select",{attrs:{collection:"k3_BD_MATERIAL",disabled:!!e.mainMaterialId&&!!e.processStepId,"search-fields":["FNumber","FName"],"label-key":"FName","sub-key":"FMATERIALID",multiple:!1,placeholder:"请输入物料编码/名称搜索"},on:{select:e.handleProductChange},scopedSlots:e._u([{key:"option",fn:function(t){var r=t.item;return[a("div",{staticClass:"item-option"},[a("div",{staticClass:"item-info"},[a("span",[e._v(e._s(r.FNumber)+" - "+e._s(r.FName))]),e._v(" "),a("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(e._s(r.FMATERIALID)+" -"+e._s(r.FUseOrgId))])],1)])]}}],null,!1,1794309911),model:{value:e.formData.productModel,callback:function(t){e.$set(e.formData,"productModel",t)},expression:"formData.productModel"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"产品工序"}},[a("el-select",{staticClass:"custom-select",attrs:{placeholder:"请选择产品工序",disabled:!!e.mainMaterialId&&!!e.processStepId},on:{change:e.handleProcessChange},model:{value:e.formData.processStep,callback:function(t){e.$set(e.formData,"processStep",t)},expression:"formData.processStep"}},e._l(e.processStepOptions,(function(t){return a("el-option",{key:t._id,attrs:{label:t.processName,value:t._id}},[a("div",{staticClass:"option-content"},[a("span",{staticClass:"option-main"},[e._v(e._s(""+(t.levelPrefix||"")+t.sort+"."+t.processName))]),e._v(" "),a("span",{staticClass:"option-sub"},[e._v(e._s(t.processCode))])])])})),1)],1),e._v(" "),a("el-form-item",{attrs:{label:"产线编码"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入产线信息搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.lineName,callback:function(t){e.$set(e.formData,"lineName",t)},expression:"formData.lineName"}}):a("zr-select",{attrs:{disabled:!!e.mainMaterialId&&!!e.processStepId,collection:"production_line","search-fields":["lineCode","lineName"],"label-key":"lineName","tag-key":"lineCode","sub-key":"workshop",multiple:!1,placeholder:"请输入产线信息搜索"},on:{select:e.handleProductionLineSelect},model:{value:e.formData.productLine,callback:function(t){e.$set(e.formData,"productLine",t)},expression:"formData.productLine"}})],1)],1),e._v(" "),e.hasEditPermission?a("div",{staticClass:"button-group"},[e.mainMaterialId&&e.processStepId?a("el-button",{attrs:{type:"danger",icon:"el-icon-close"},on:{click:e.handleCancelSave}},[e._v("\n                        取消设置\n                    ")]):a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleSave}},[e._v("\n                        保存设置\n                    ")])],1):e._e()])],1)],1),e._v(" "),a("div",{staticClass:"right-content"},[e.mainMaterialId&&e.processStepId?[a("el-card",{staticClass:"scan-card"},[a("div",{staticClass:"card-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-scan"}),e._v(" "),a("span",[e._v("条码扫描")]),e._v(" "),a("el-button",{attrs:{type:"text"},on:{click:e.toggleCollapse}},[a("i",{class:e.isCollapsed?"el-icon-d-arrow-right":"el-icon-d-arrow-left"}),e._v("\n                            "+e._s(e.isCollapsed?"展开":"收起")+"\n                        ")])],1),e._v(" "),a("el-button",{attrs:{type:"text",icon:"el-icon-delete"},on:{click:e.handleClearCache}},[e._v("\n                        清除批次物料缓存\n                    ")])],1),e._v(" "),a("el-form",{ref:"scanForm",attrs:{model:e.scanForm,"label-width":"100%"}},[a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-camera"}),e._v(" "),a("span",[e._v("统一扫描区域")])]),e._v(" "),a("div",{staticClass:"scan-input-section"},[a("el-input",{ref:"scanInput",attrs:{placeholder:"请扫描条码",clearable:""},on:{input:e.handleUnifiedScan,clear:e.focusInput},model:{value:e.unifiedScanInput,callback:function(t){e.unifiedScanInput=t},expression:"unifiedScanInput"}})],1),e._v(" "),a("div",{staticClass:"section-header"},[a("div",{staticClass:"section-title"},[a("i",{staticClass:"el-icon-goods"}),e._v(" "),a("span",[e._v("主物料")])]),e._v(" "),a("div",{staticClass:"print-batch-btn"},[a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"自动","inactive-text":"手动"},on:{change:e.handleAutoPrintChange},model:{value:e.autoPrint,callback:function(t){e.autoPrint=t},expression:"autoPrint"}}),e._v(" "),a("el-button",{staticClass:"print-batch-btn",attrs:{type:"primary",size:"mini"},on:{click:e.handlePrintBatch}},[e._v("\n                                打印\n                            ")])],1)]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"编号："+e.mainMaterialCode+"  名称："+e.mainMaterialName,"label-width":"100%"}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus.mainBarcode},attrs:{placeholder:"请扫描主物料条码",readonly:""},model:{value:e.scanForm.mainBarcode,callback:function(t){e.$set(e.scanForm,"mainBarcode",t)},expression:"scanForm.mainBarcode"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})])],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus.mainBarcode}},[a("i",{class:e.getValidateIcon("mainBarcode")})])],1)])],1),e._v(" "),a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-box"}),e._v(" "),a("span",[e._v("子物料")])]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-row",{attrs:{gutter:20}},e._l(e.processMaterials,(function(t){return a("el-col",{key:t._id,attrs:{span:12}},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"编号："+t.materialCode+"  名称："+t.materialName+"  "}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus[t._id]},attrs:{placeholder:"请扫描子物料条码",readonly:""},model:{value:e.scanForm.barcodes[t._id],callback:function(a){e.$set(e.scanForm.barcodes,t._id,a)},expression:"scanForm.barcodes[material._id]"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})]),e._v(" "),t.isBatch?a("template",{slot:"suffix"},[t.batchQuantity?a("el-tag",{attrs:{type:"warning"}},[e._v("\n                                                    "+e._s(e.getBatchUsageText(t._id))+"\n                                                ")]):a("el-tag",{attrs:{type:"warning"}},[e._v("批次物料")])],1):e._e()],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus[t._id]}},[a("i",{class:e.getValidateIcon(t._id)})])],1)])],1)})),1)],1),e._v(" "),a("div",{staticClass:"button-group"},[a("el-button",{attrs:{plain:"",icon:"el-icon-refresh"},on:{click:e.resetScanForm}},[e._v("重置")]),e._v(" "),a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleConfirm}},[e._v("确认")])],1)])],1)]:[e._m(0)]],2),e._v(" "),a("tsc-printer",{ref:"tscPrinter",attrs:{materialCode:e.mainMaterialCode,barcode:e.currentBatchBarcode}})],1)}),[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"init-tip"},[a("div",{staticClass:"overlay"},[a("i",{staticClass:"el-icon-warning-outline pulse"}),e._v(" "),a("p",[e._v("请先初始化工序设置")])])])}],!1,null,"77440474",null);t.default=M.exports}}]);