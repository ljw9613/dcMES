# 关键物料条码并发安全优化方案

## 问题描述

在生产环境中，发现同一关键物料条码可能被并发绑定到两个不同的主条码中，且两个绑定的时间相差很短。这是因为：

1. **前端限制的局限性**：前端虽然有 `isSubmitting` 标志防止重复提交，但这只能防止同一用户在同一浏览器中的重复提交
2. **并发请求问题**：当两个不同的用户或两个不同的请求同时提交时，它们都会通过前端的检查
3. **数据库检查的竞态条件**：在后端，两个请求同时到达时，都会通过关键物料检查（因为此时都还没有绑定），然后都继续执行，最终都成功绑定了同一个关键物料

## 解决方案

使用 **Redis 分布式锁机制**，在检查关键物料之前先获取锁，防止同一关键物料条码被并发绑定到多个主条码。

### 技术实现

#### 1. 关键物料锁管理器 (`KeyMaterialLock`)

创建了一个专门的关键物料锁管理器类，使用 Redis `SETNX` 命令实现分布式锁：

- **锁键前缀**：`key_material_lock:`
- **锁的有效期**：3分钟（180秒），自动过期释放
- **锁的值**：包含主条码和时间戳，用于验证锁的持有者
- **降级处理**：当 Redis 不可用时，跳过锁机制，不阻塞业务流程

#### 2. 锁的获取和释放流程

**获取锁（在检查关键物料之前）**：
```javascript
// 批量获取多个关键物料条码锁
const lockResult = await this.keyMaterialLock.acquireLocks(
  keyMaterialBarcodes,
  mainBarcode
);

if (!lockResult.success) {
  throw new Error("关键物料条码正在被其他流程使用中，请稍后重试");
}
```

**释放锁（在保存成功后）**：
```javascript
// 保存成功后，释放关键物料条码锁
if (lockedKeyBarcodes.length > 0) {
  await this.keyMaterialLock.releaseLocks(
    lockedKeyBarcodes,
    mainBarcode
  );
}
```

**错误处理（在 catch 块中）**：
```javascript
// 发生错误时，也要释放关键物料条码锁
if (lockedKeyBarcodes && lockedKeyBarcodes.length > 0) {
  await this.keyMaterialLock.releaseLocks(
    lockedKeyBarcodes,
    mainBarcode
  );
}
```

### 核心特性

1. **分布式锁**：使用 Redis `SETNX` 命令，确保同一关键物料条码在同一时间只能被一个请求处理
2. **自动过期**：锁的有效期为3分钟，即使程序异常退出，锁也会自动释放
3. **批量操作**：支持批量获取和释放多个关键物料条码锁
4. **降级处理**：当 Redis 不可用时，跳过锁机制，不阻塞业务流程
5. **错误安全**：在 catch 块中也会释放锁，确保即使出错也能释放

### Redis 配置

- **Redis DB**：使用与条码规则缓存相同的 DB（DB 2）
- **连接配置**：复用现有的 Redis 连接配置
- **键命名规范**：`key_material_lock:{barcode}`

### 性能影响

- **最小化服务器负担**：只在关键物料条码检查时使用锁，不影响其他业务流程
- **快速释放**：锁在保存成功后立即释放，不会长时间占用
- **自动过期**：即使程序异常，锁也会在3分钟后自动过期

## 使用示例

### 正常流程

1. 请求A尝试绑定关键物料条码 `KEY-001` 到主条码 `MAIN-001`
2. 请求A获取锁成功，继续执行
3. 请求B尝试绑定关键物料条码 `KEY-001` 到主条码 `MAIN-002`
4. 请求B获取锁失败，返回错误："关键物料条码正在被其他流程使用中，请稍后重试"
5. 请求A保存成功后释放锁
6. 请求B可以重试

### 异常处理

1. 请求A获取锁成功，但在保存时发生错误
2. 在 catch 块中自动释放锁
3. 其他请求可以继续尝试获取锁

## 注意事项

1. **锁的有效期**：锁的有效期为3分钟，如果业务流程超过3分钟，锁会自动过期
2. **Redis 可用性**：当 Redis 不可用时，系统会降级处理，跳过锁机制
3. **锁的持有者验证**：释放锁时会验证锁的持有者，防止误删其他请求的锁

## 相关文件

- `dcMes_server/services/materialProcessFlowService.js`：主要实现文件
  - `KeyMaterialLock` 类：关键物料锁管理器
  - `scanProcessComponents` 方法：集成锁机制

## 测试建议

1. **并发测试**：模拟两个请求同时尝试绑定同一关键物料条码
2. **异常测试**：模拟获取锁后发生错误的情况
3. **Redis 故障测试**：模拟 Redis 不可用时的降级处理

## 更新日志

- **2026-01-26**：实现基于 Redis 的分布式锁机制，防止关键物料条码并发绑定问题
