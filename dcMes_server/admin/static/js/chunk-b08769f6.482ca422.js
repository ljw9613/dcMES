(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-b08769f6"],{"058e":function(e,t,a){},"05e4":function(e,t,a){"use strict";a("058e")},"14e1":function(e,t,a){e.exports=a.p+"static/media/cfbd.7c42ce8c.mp3"},"2cb9":function(e,t,a){},"31b6":function(e,t,a){e.exports=a.p+"static/media/bdcg.762434df.mp3"},"33fd":function(e,t,a){e.exports=a.p+"static/media/tmyw.a5dd40df.mp3"},"77d2":function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"b",(function(){return n}));var r=a("b775");function s(e){return Object(r.a)({url:"/machine/progress",method:"get",params:e})}function n(e){return Object(r.a)({url:"/machine/refresh",method:"post",data:e})}},"7da5":function(e,t){},bc54:function(e,t,a){"use strict";a("2cb9")},de6b:function(e,t,a){e.exports=a.p+"static/media/smcg.fe637541.mp3"},ed91:function(e,t,a){"use strict";a.d(t,"a",(function(){return s})),a.d(t,"b",(function(){return n})),a.d(t,"c",(function(){return i})),a.d(t,"d",(function(){return c}));var r=a("b775");function s(e){return Object(r.a)({url:"/create-flow",method:"post",data:e})}function n(e){return Object(r.a)({url:"/scan-components",method:"post",data:e})}function i(e){return Object(r.a)({url:"/unbind-components",method:"post",data:e})}function c(e){return Object(r.a)({url:"/update-flow-nodes",method:"post",data:e})}},f783:function(e,t,a){"use strict";a.r(t);var r=(a("f559"),a("456d"),a("8615"),a("a481"),a("28a5"),a("6762"),a("2fdb"),a("7514"),a("2909")),s=(a("1c4c"),a("14b9"),a("b85c")),n=(a("ac6a"),a("5df3"),a("4f7f"),a("c7eb")),i=(a("96cf"),a("1da1")),c=a("7e1e"),o=a("77d2"),l=a("ed91"),u=a("b775");function d(e){return Object(u.a)({url:"/material-barcode/create",method:"post",data:e})}var p=a("6ace");function h(e){new Audio(e).play().catch((function(e){console.warn("音频播放失败:",e)}))}var m=a("de6b"),f=a.n(m),b=a("33fd"),v=a.n(b),g=a("31b6"),k=a.n(g),x=a("14e1"),w=a.n(x),_=(a("7da5"),{name:"TscPrinter",props:{materialCode:{type:String,default:""},barcode:{type:String,default:""},visible:{type:Boolean,default:!1}},data:function(){return{usbChecked:!0,networkChecked:!1,driverChecked:!1,usbPrinters:[],selectedUsbPrinter:"",printerIP:"",printerPort:"9100",driverPrinters:[],selectedDriver:"",printing:!1,websocket:null,wsUrl:"ws://127.0.0.1:8888",dialogVisible:!1,checkingStatus:!1,wsConnected:!1}},watch:{visible:{handler:function(e){this.dialogVisible=e},immediate:!0}},mounted:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.initWebSocket();case 3:setTimeout((function(){t.getUsbPrinterList(),t.getDriverList()}),1e3),e.next=10;break;case 6:e.prev=6,e.t0=e.catch(0),console.error("打印服务连接失败:",e.t0),this.$message.error("打印服务连接失败，请确保TSC打印服务已启动");case 10:case"end":return e.stop()}}),e,this,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),methods:{initWebSocket:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{this.websocket=new WebSocket(this.wsUrl),this.websocket.onopen=this.handleWsOpen,this.websocket.onclose=this.handleWsClose,this.websocket.onmessage=this.handleWsMessage,this.websocket.onerror=this.handleWsError}catch(e){console.error("WebSocket连接失败:",e),this.$message.error("打印服务连接失败，请确保TSC打印服务已启动")}case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),handleWsOpen:function(){this.wsConnected=!0,this.reconnectAttempts=0,console.log("WebSocket连接成功"),this.$message.success("打印服务连接成功")},handleWsClose:function(e){this.wsConnected=!1;var t=this.getCloseReason(e.code);console.error("WebSocket连接关闭: ".concat(t)),this.$message.error("打印服务连接断开: ".concat(t))},getCloseReason:function(e){return{1001:"服务器关闭或浏览器离开页面",1002:"协议错误",1003:"接收到不支持的数据类型",1004:"保留状态码",1005:"没有收到状态码",1006:"连接异常关闭",1007:"接收到非UTF-8数据",1008:"违反策略",1009:"接收到过大的消息",1010:"客户端需要的扩展未协商",1011:"服务器遇到意外情况",1015:"TLS握手失败"}[e]||"未知原因"},handleWsMessage:function(e){console.log("收到服务器消息:",e.data);try{if("Finished"===e.data)return void this.$message.success("成功收到打印服务消息");var t=JSON.parse(e.data);t.usb_list&&(0===t.usb_list.length&&this.$message.warning("未找到USB打印机"),this.usbPrinters=t.usb_list,this.usbPrinters.length>0&&(this.selectedUsbPrinter=this.usbPrinters[0].USBPath)),t.driver_list&&(0===t.driver_list.length&&this.$message.warning("未找到驱动打印机"),this.driverPrinters=t.driver_list,this.driverPrinters.length),t.Function_Failed&&this.$message.error("操作失败: ".concat(t.Function_Failed)),t.printerstatus&&t.printerstatus.length>0&&this.$message.info("打印机状态:\n".concat(t.printerstatus.join("\n"))),t.printername&&this.$message.info("打印机名称: ".concat(t.printername)),t.printerserial&&this.$message.info("打印机序列号: ".concat(t.printerserial))}catch(e){console.error("消息解析错误:",e),this.$message.error("接收到无效数据")}},handleWsError:function(e){this.wsConnected=!1,console.error("WebSocket错误:",e),this.$message.error("打印服务连接错误，请确保TSC打印服务已启动")},sendWsMessage:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("sendWsMessage",t),this.wsConnected){e.next=3;break}throw new Error("打印服务未连接，请检查打印服务是否启动");case 3:if(this.websocket.readyState!==WebSocket.OPEN){e.next=7;break}this.websocket.send(JSON.stringify(t)),e.next=8;break;case 7:throw new Error("WebSocket连接未就绪");case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleUsbCheck:function(e){e&&(this.networkChecked=!1,this.driverChecked=!1)},handleNetworkCheck:function(e){e&&(this.usbChecked=!1,this.driverChecked=!1)},handleDriverCheck:function(e){e&&(this.usbChecked=!1,this.networkChecked=!1)},getUsbPrinterList:function(){this.sendWsMessage({usb_list:[]})},getDriverList:function(){this.sendWsMessage({driver_list:[]})},checkInterface:function(){if(this.usbChecked)return!(this.usbPrinters.length<=0||!this.selectedUsbPrinter)||(this.$message.error("请选择USB打印机"),!1);if(this.networkChecked){return/^(\d{1,3}\.){3}\d{1,3}$/.test(this.printerIP)?!!/^[1-9]\d*$/.test(this.printerPort)||(this.$message.error("无效的端口号"),!1):(this.$message.error("无效的IP地址"),!1)}return this.driverChecked?!(this.driverPrinters.length<=0||!this.selectedDriver)||(this.$message.error("请选择打印机驱动"),!1):(this.$message.error("请选择打印机连接方式"),!1)},printTemplate:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,this.printing=!0,t={functions_inorder:[{init:""},this.usbChecked?{openport_usb:this.selectedUsbPrinter}:this.networkChecked?{openport_net:"".concat(this.printerIP,",").concat(this.printerPort)}:{openport_driver:this.selectedDriver},{clearbuffer:""},{setup:"60,28,4,8,0,3,0"},{windowsfont:"40,40,".concat(28,",0,0,0,Arial,物料：").concat(this.materialCode)},{windowsfont:"40,120,".concat(28,",0,0,0,Arial,条码如下：")},{windowsfont:"40,200,".concat(28,",0,0,0,Arial,").concat(this.barcode)},{sendcommand_crlf:'QRCODE 440,24,H,8,A,0,M2,S5,"'.concat(this.barcode,'"')},{printlabel:"1,1"},{closeport:""}]},e.next=9,this.sendWsMessage(t);case 9:this.$emit("print-success"),this.$message.success("打印成功"),e.next=18;break;case 13:e.prev=13,e.t0=e.catch(2),console.error("打印失败:",e.t0),this.$emit("print-error",e.t0.message||"打印失败"),this.$message.error("打印失败: ".concat(e.t0.message||"未知错误"));case 18:return e.prev=18,this.printing=!1,e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[2,13,18,21]])})));return function(){return e.apply(this,arguments)}}(),printTestPage:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,t={functions_inorder:[{function:"init"},this.usbChecked?{function:"openport_usb",args:[this.selectedUsbPrinter]}:this.networkChecked?{function:"openport_net",args:[this.printerIP,this.printerPort]}:{function:"openport_driver",args:[this.selectedDriver]},{function:"sendcommand",args:["SELFTEST"]},{function:"closeport"}]},e.next=6,this.sendWsMessage(t);case 6:this.$message.success("测试页打印成功"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),this.$message.error("测试页打印失败: ".concat(e.t0.message||"未知错误"));case 12:case"end":return e.stop()}}),e,this,[[2,9]])})));return function(){return e.apply(this,arguments)}}(),checkPrinterStatus:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.checkInterface()){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,this.checkingStatus=!0,t={functions_inorder:[{function:"init"},this.usbChecked?{function:"openport_usb",args:[this.selectedUsbPrinter]}:this.networkChecked?{function:"openport_net",args:[this.printerIP,this.printerPort]}:{function:"openport_driver",args:[this.selectedDriver]},{function:"printerstatus"},{function:"printername"},{function:"printerserial"},{function:"closeport"}]},e.next=7,this.sendWsMessage(t);case 7:this.$message.success("打印机连接正常"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),console.error("检查打印机状态失败:",e.t0),this.$message.error("检查打印机状态失败: ".concat(e.t0.message||"未知错误"));case 14:return e.prev=14,this.checkingStatus=!1,e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[2,10,14,17]])})));return function(){return e.apply(this,arguments)}}(),handleClose:function(){this.dialogVisible=!1},confirmPrint:function(){var e=this;this.printTemplate().then((function(){e.handleClose()}))},print:function(){return this.printTemplate()}}}),I=_,C=(a("05e4"),a("2877")),S=Object(C.a)(I,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-dialog",{attrs:{title:"打印设置",visible:e.dialogVisible,width:"600px","before-close":e.handleClose,"close-on-click-modal":!1,"close-on-press-escape":!1},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("div",{staticClass:"tsc-printer"},[a("div",{staticClass:"param-display interface-block"},[a("div",{staticClass:"card-header"},[a("i",{staticClass:"el-icon-document"}),e._v(" "),a("span",[e._v("打印参数")])]),e._v(" "),a("div",{staticClass:"param-table"},[a("table",[a("tr",[a("th",[e._v("物料编码")]),e._v(" "),a("td",[e._v(e._s(e.materialCode))]),e._v(" "),a("th",[e._v("条码内容")]),e._v(" "),a("td",[e._v(e._s(e.barcode))])])])])]),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"card-header"},[a("i",{staticClass:"el-icon-printer"}),e._v(" "),a("span",[e._v("打印机连接")])]),e._v(" "),a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleUsbCheck},model:{value:e.usbChecked,callback:function(t){e.usbChecked=t},expression:"usbChecked"}},[e._v("USB连接")]),e._v(" "),a("i",{staticClass:"el-icon-usb"})],1),e._v(" "),e.usbChecked?a("div",{staticClass:"printer-select"},[a("span",[e._v("打印机名称：")]),e._v(" "),a("el-select",{model:{value:e.selectedUsbPrinter,callback:function(t){e.selectedUsbPrinter=t},expression:"selectedUsbPrinter"}},e._l(e.usbPrinters,(function(e){return a("el-option",{key:e.USBPath,attrs:{label:e.USBName,value:e.USBPath}})})),1)],1):e._e()]),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleNetworkCheck},model:{value:e.networkChecked,callback:function(t){e.networkChecked=t},expression:"networkChecked"}},[e._v("网络连接")]),e._v(" "),a("i",{staticClass:"el-icon-connection"})],1),e._v(" "),e.networkChecked?[a("div",{staticClass:"network-input"},[a("span",[e._v("打印机IP地址：")]),e._v(" "),a("el-input",{attrs:{placeholder:"请输入IP地址"},model:{value:e.printerIP,callback:function(t){e.printerIP=t},expression:"printerIP"}})],1),e._v(" "),a("div",{staticClass:"network-input"},[a("span",[e._v("端口号：")]),e._v(" "),a("el-input",{attrs:{placeholder:"9100"},model:{value:e.printerPort,callback:function(t){e.printerPort=t},expression:"printerPort"}})],1)]:e._e()],2),e._v(" "),a("div",{staticClass:"interface-block"},[a("div",{staticClass:"connection-type"},[a("el-checkbox",{on:{change:e.handleDriverCheck},model:{value:e.driverChecked,callback:function(t){e.driverChecked=t},expression:"driverChecked"}},[e._v("驱动连接")])],1),e._v(" "),e.driverChecked?a("div",{staticClass:"printer-select"},[a("span",[e._v("驱动名称：")]),e._v(" "),a("el-select",{model:{value:e.selectedDriver,callback:function(t){e.selectedDriver=t},expression:"selectedDriver"}},e._l(e.driverPrinters,(function(e){return a("el-option",{key:e.DriverName,attrs:{label:e.DriverName,value:e.DriverName}})})),1)],1):e._e()]),e._v(" "),a("div",{staticClass:"print-controls"},[a("el-button",{attrs:{type:"primary",loading:e.printing},on:{click:e.confirmPrint}},[e._v("\n                "+e._s(e.printing?"打印中...":"确认打印")+"\n            ")]),e._v(" "),a("el-button",{attrs:{type:"info",loading:e.checkingStatus},on:{click:e.checkPrinterStatus}},[e._v("\n                "+e._s(e.checkingStatus?"检查中...":"检查打印机")+"\n            ")]),e._v(" "),a("el-button",{on:{click:e.handleClose}},[e._v("取消")])],1)])])}),[],!1,null,"cd05dce0",null),O=S.exports,y={name:"ScanBarCode",components:{ZrSelect:p.a,TscPrinter:O},data:function(){return{autoInit:!0,formData:{productModel:"",productLine:"",processStep:"",componentName:""},productOptions:[],processStepOptions:[],materialOptions:[],materialLoading:!1,mainMaterialName:"",mainMaterialCode:"",workmainMaterialId:"",workmainMaterialCode:"",processMaterials:[],scanForm:{mainBarcode:"",barcodes:{}},productLineOptions:[{_id:"1",FNumber:"1",FName:"产线1"},{_id:"2",FNumber:"2",FName:"产线2"}],validateStatus:{mainBarcode:!1},loading:!1,unifiedScanInput:"",hasEditPermission:!1,scanTimer:null,batchMaterialCache:{},printDialogVisible:!1,currentBatchBarcode:"",autoPrint:!1,isCollapsed:!1,websocketConnected:!1,ws:null,heartbeatTimer:null,reconnectAttempts:0,maxReconnectAttempts:5}},computed:{mainMaterialId:{get:function(){return localStorage.getItem("mainMaterialId")||""},set:function(e){localStorage.setItem("mainMaterialId",e)}},processStepId:{get:function(){return localStorage.getItem("processStepId")||""},set:function(e){localStorage.setItem("processStepId",e)}},materialName:{get:function(){return localStorage.getItem("materialName")||""},set:function(e){localStorage.setItem("materialName",e)}},processName:{get:function(){return localStorage.getItem("processName")||""},set:function(e){localStorage.setItem("processName",e)}},productLineId:{get:function(){return localStorage.getItem("productLineId")||""},set:function(e){localStorage.setItem("productLineId",e)}},productLineName:{get:function(){return localStorage.getItem("productLineName")||""},set:function(e){localStorage.setItem("productLineName",e)}},autoInitMode:{get:function(){return"true"===localStorage.getItem("autoInit")},set:function(e){localStorage.setItem("autoInit",e)}}},watch:{mainMaterialId:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=5;break}return e.next=3,this.getMainMaterialInfo();case 3:e.next=6;break;case 5:this.mainMaterialName="";case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),processStepId:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=6;break}return console.log(t,"newVal============="),e.next=4,this.getProcessMaterials();case 4:e.next=9;break;case 6:this.processMaterials=[],this.scanForm.barcodes={},this.validateStatus={mainBarcode:!1};case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),validateStatus:{handler:function(e){},deep:!0}},methods:{handleAutoInitChange:function(e){this.autoInit=e,this.autoInitMode=e,this.$message.success("已".concat(e?"开启":"关闭","自动初始化模式")),e&&window.location.reload()},getAutoInitConfig:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r,s,i,c;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.processStepId="",e.next=4,Object(o.a)();case 4:if(t=e.sent,console.log("获取到的机器进度:",t.data),200!==t.code||!t.data){e.next=14;break}a=t.data,r=a.materialId,s=a.processStepId,i=a.lineId,console.log("materialId:",r),console.log("processStepId:",s.processName),console.log("lineId:",i),r&&s?(console.log("materialId:",r),console.log("processStepId:",s.processName),console.log("lineId:",i),this.mainMaterialId=r._id,c=s._id,this.processStepId=c,this.formData.productModel=r._id,this.formData.processStep=s._id,this.formData.productLine=i&&i._id,this.materialName="".concat(r.FNumber," - ").concat(r.FName),this.processName=s.processName,i&&(this.productLineName=i.lineName,this.formData.lineName=i.lineName),this.$message.success("自动初始化工序成功"),c!==this.processStepId&&this.handleSave()):this.$message.warning("未获取到机器进度配置"),e.next=15;break;case 14:throw new Error(t.message||"获取机器进度失败");case 15:e.next=21;break;case 17:e.prev=17,e.t0=e.catch(0),console.error("自动初始化失败:",e.t0),this.$message.error("自动初始化失败: "+e.t0.message);case 21:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),handlePrintBatch:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.$loading({lock:!0,text:"正在生成批次条码...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),e.prev=1,this.mainMaterialCode){e.next=4;break}throw new Error("未获取到物料编码信息");case 4:return e.next=6,d({materialCode:this.mainMaterialCode});case 6:if(200!==(a=e.sent).code||!a.data.batchId){e.next=27;break}return this.currentBatchBarcode=a.data.batchId,e.next=11,this.$nextTick();case 11:if(!this.autoPrint){e.next=23;break}if(!this.currentBatchBarcode||!this.mainMaterialCode){e.next=20;break}return e.next=15,this.$refs.tscPrinter.print();case 15:return this.unifiedScanInput=this.currentBatchBarcode,e.next=18,this.handleUnifiedScan(this.currentBatchBarcode);case 18:e.next=21;break;case 20:throw new Error("打印数据未准备就绪");case 21:e.next=24;break;case 23:this.$refs.tscPrinter.dialogVisible=!0;case 24:this.$nextTick((function(){r.$refs.scanInput.focus()})),e.next=28;break;case 27:throw new Error("批次条码生成失败");case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(1),this.$message.error(e.t0.message||"批次条码生成失败");case 33:return e.prev=33,t.close(),this.$nextTick((function(){r.$refs.scanInput.focus()})),e.finish(33);case 37:case"end":return e.stop()}}),e,this,[[1,30,33,37]])})));return function(){return e.apply(this,arguments)}}(),handleProductionLineSelect:function(e){e&&(this.formData.lineName=e.lineName,this.formData.productLine=e._id,localStorage.setItem("productLineName",e.lineName),localStorage.setItem("productLineId",e._id))},getMaterialById:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("k3_BD_MATERIAL",{query:{_id:t}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getCraftByMaterialId:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("craft",{query:{materialId:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessStepById:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("processStep",{query:{_id:t},sort:{sort:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessMaterialById:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(c.b)("processMaterials",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getMaterialList:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===t){e.next=18;break}return this.materialLoading=!0,e.prev=2,e.next=5,Object(c.b)("k3_BD_MATERIAL",{query:{$or:[{FNumber:{$regex:t,$options:"i"}},{FName:{$regex:t,$options:"i"}}]},page:1,limit:20});case 5:a=e.sent,this.productOptions=a.data,e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("获取产品型号失败:",e.t0),this.$message.error("获取产品型号失败");case 13:return e.prev=13,this.materialLoading=!1,e.finish(13);case 16:e.next=19;break;case 18:this.productOptions=[];case 19:case"end":return e.stop()}}),e,this,[[2,9,13,16]])})));return function(t){return e.apply(this,arguments)}}(),getAllProcessSteps:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a,r,i,o,l,u,d,p,h,m,f,b,v,g=arguments;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=g.length>1&&void 0!==g[1]?g[1]:new Set,r=g.length>2&&void 0!==g[2]?g[2]:new Set,i=g.length>3&&void 0!==g[3]?g[3]:0,e.prev=3,!r.has(t)){e.next=6;break}return e.abrupt("return",a);case 6:return r.add(t),e.next=9,Object(c.b)("craft",{query:{materialId:t},page:1,limit:1});case 9:if((o=e.sent).data&&0!==o.data.length){e.next=12;break}return e.abrupt("return",a);case 12:return l=o.data[0],e.next=15,Object(c.b)("processStep",{query:{craftId:l._id},sort:{sort:1}});case 15:if(!(u=e.sent).data){e.next=55;break}d=Object(s.a)(u.data),e.prev=18,d.s();case 20:if((p=d.n()).done){e.next=47;break}return(h=p.value).levelPrefix="┗".repeat(i),a.add(h),e.next=26,Object(c.b)("processMaterials",{query:{processStepId:h._id}});case 26:if(!(m=e.sent).data){e.next=45;break}f=Object(s.a)(m.data),e.prev=29,f.s();case 31:if((b=f.n()).done){e.next=37;break}return v=b.value,e.next=35,this.getAllProcessSteps(v.materialId,a,r,i+1);case 35:e.next=31;break;case 37:e.next=42;break;case 39:e.prev=39,e.t0=e.catch(29),f.e(e.t0);case 42:return e.prev=42,f.f(),e.finish(42);case 45:e.next=20;break;case 47:e.next=52;break;case 49:e.prev=49,e.t1=e.catch(18),d.e(e.t1);case 52:return e.prev=52,d.f(),e.finish(52);case 55:return e.abrupt("return",a);case 58:return e.prev=58,e.t2=e.catch(3),console.error("获取工序失败:",e.t2),e.abrupt("return",a);case 62:case"end":return e.stop()}}),e,this,[[3,58],[18,49,52,55],[29,39,42,45]])})));return function(t){return e.apply(this,arguments)}}(),handleProductChange:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t._id,this.processStepOptions=[],this.formData.processStep="",this.mainMaterialId="",a){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,e.next=9,this.getAllProcessSteps(a,new Set,new Set);case 9:r=e.sent,console.log("获取到的工序:",r),this.processStepOptions=Array.from(r),this.formData.productModel=a,e.next=19;break;case 15:e.prev=15,e.t0=e.catch(6),console.error("获取工序列表失败:",e.t0),this.$message.error("获取工序列表失败");case 19:case"end":return e.stop()}}),e,this,[[6,15]])})));return function(t){return e.apply(this,arguments)}}(),handleProcessChange:function(e){e?this.formData.processStep=e:this.processStepId=""},handleSave:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.formData.productModel&&this.formData.processStep&&this.formData.productLine){e.next=3;break}return this.$message.warning("请选择产品型号、工序和产线"),e.abrupt("return");case 3:return t=this.$loading({lock:!0,text:"保存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),e.prev=4,this.resetScanForm(),this.mainMaterialId=this.formData.productModel,this.processStepId=this.formData.processStep,this.productLineId=this.formData.productLine,e.next=11,this.getMaterialById(this.formData.productModel);case 11:return(a=e.sent)&&(this.materialName="".concat(a.FNumber," - ").concat(a.FName)),e.next=15,this.getProcessStepById(this.formData.processStep);case 15:(r=e.sent)&&(this.processName=r.processName),this.$message.success("保存成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(4),console.error("保存失败:",e.t0),this.$message.error("保存失败"),t.close();case 26:case"end":return e.stop()}}),e,this,[[4,21]])})));return function(){return e.apply(this,arguments)}}(),getMainMaterialInfo:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取主物料信息，ID:",this.mainMaterialId),e.next=4,Object(c.b)("k3_BD_MATERIAL",{query:{_id:this.mainMaterialId},page:1,limit:1});case 4:(t=e.sent).data&&t.data[0]?(console.log("获取到的主物料信息:",t.data[0]),this.mainMaterialName=t.data[0].FName,this.mainMaterialCode=t.data[0].FNumber):(console.log("未找到主物料信息"),this.mainMaterialName="",this.mainMaterialCode=""),e.next=14;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("获取主物料信息失败:",e.t0),this.$message.error("获取主物料信息失败"),this.mainMaterialName="",this.mainMaterialCode="";case 14:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),getProcessMaterials:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r,s,i,o,l=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取工序信息，ID:",this.processStepId),e.next=4,Object(c.b)("processStep",{query:{_id:this.processStepId},page:1,limit:1});case 4:if((t=e.sent).data&&0!==!t.data.length){e.next=7;break}throw new Error("未找到工序信息");case 7:return a=t.data[0],e.next=10,Object(c.b)("craft",{query:{_id:a.craftId},page:1,limit:1});case 10:if((r=e.sent).data&&0!==!r.data.length){e.next=13;break}throw new Error("未找到工艺信息");case 13:return s=r.data[0],e.next=16,this.getMaterialById(s.materialId);case 16:if(i=e.sent){e.next=19;break}throw new Error("未找到物料信息");case 19:return this.workmainMaterialId=i._id,this.workmainMaterialCode=i.FNumber,this.mainMaterialName=i.FName,this.mainMaterialCode=i.FNumber,console.log("processStep",a),e.prev=24,e.next=27,Object(c.b)("processMaterials",{query:{processStepId:this.processStepId}});case 27:(o=e.sent).data?(this.processMaterials=o.data,this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={},this.processMaterials.forEach((function(e){l.validateStatus[e._id]=!1,l.$set(l.scanForm.barcodes,e._id,"")}))):(this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={}),e.next=38;break;case 31:e.prev=31,e.t0=e.catch(24),console.error("获取工序物料失败:",e.t0),this.$message.error("获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 38:e.next=47;break;case 40:e.prev=40,e.t1=e.catch(0),console.error("获取工序物料失败:",e.t1),this.$message.error(e.t1.message||"获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 47:case"end":return e.stop()}}),e,this,[[0,40],[24,31]])})));return function(){return e.apply(this,arguments)}}(),validateDICode:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a,s,i,o;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(c.b)("productDiNum",{query:{diNum:t},populate:JSON.stringify([{path:"productId",model:"k3_BD_MATERIAL"}])});case 3:if(0!==(a=e.sent).data.length){e.next=7;break}return this.$message.error("该DI编码不存在本系统"),e.abrupt("return",{isValid:!1});case 7:if(s=a.data.filter((function(e){return e.productId&&e.productId.FNumber})).map((function(e){return e.productId.FNumber})),0!==s.length){e.next=11;break}return this.$message.error("该DI编码未关联有效物料"),e.abrupt("return",{isValid:!1});case 11:if(i=[this.mainMaterialCode].concat(Object(r.a)(this.processMaterials.map((function(e){return e.materialCode})))),o=s.find((function(e){return i.includes(e)})),o){e.next=16;break}return this.$message.error("该DI编码对应的物料与当前工序不匹配"),e.abrupt("return",{isValid:!1});case 16:return e.abrupt("return",{isValid:!0,materialCode:o});case 19:return e.prev=19,e.t0=e.catch(0),console.error("DI码验证失败:",e.t0),this.$message.error("DI码验证失败"),e.abrupt("return",{isValid:!1});case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),validateBarcode:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a,r,s,i,c,o,l,u,d,p,m,f,b,g,k,x,w,_,I;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("validateBarcode",t),t){e.next=3;break}return e.abrupt("return",!1);case 3:if(r="",s=!1,t.includes("#")&&(4===(i=t.split("#")).length&&(a=i[2],r=i[1],s=!0)),s||t.includes("-")&&34!=t.length&&35!=t.length&&(a=t.split("-")[0],r=t.split("-")[1],s=!0),s){e.next=18;break}if(!t.includes("(")){e.next=18;break}return c=t.substring(4,18),console.log("productDI",c),e.next=13,this.validateDICode(c);case 13:if((o=e.sent).isValid){e.next=16;break}return e.abrupt("return",!1);case 16:a=o.materialCode,s=!0;case 18:if(s){e.next=83;break}console.log("barcode",t.length),e.t0=t.length,e.next=35===e.t0?23:34===e.t0?33:48===e.t0?53:32===e.t0?62:20===e.t0?71:80;break;case 23:if(!t.includes("-")){e.next=32;break}return l=t.split("-")[1],console.log("middlePart",l),e.next=28,this.validateDICode(l);case 28:if((u=e.sent).isValid){e.next=31;break}return e.abrupt("return",!1);case 31:a=u.materialCode;case 32:return e.abrupt("break",83);case 33:if(!t.includes("-")){e.next=44;break}return d=t.substring(7,19),console.log("fanDI",d),e.next=38,this.validateDICode(d);case 38:if((p=e.sent).isValid){e.next=41;break}return e.abrupt("return",!1);case 41:a=p.materialCode,e.next=52;break;case 44:return m=t.substring(0,16),console.log("materialDI",m),e.next=48,this.validateDICode(m);case 48:if((f=e.sent).isValid){e.next=51;break}return e.abrupt("return",!1);case 51:a=f.materialCode;case 52:return e.abrupt("break",83);case 53:return b=t.substring(0,12),console.log("lightDI",b),e.next=57,this.validateDICode(b);case 57:if((g=e.sent).isValid){e.next=60;break}return e.abrupt("return",!1);case 60:return a=g.materialCode,e.abrupt("break",83);case 62:return k=t.substring(0,8),console.log("remoteDI",k),e.next=66,this.validateDICode(k);case 66:if((x=e.sent).isValid){e.next=69;break}return e.abrupt("return",!1);case 69:return a=x.materialCode,e.abrupt("break",83);case 71:return w=t.substring(0,11),console.log("batchDI",w),e.next=75,this.validateDICode(w);case 75:if((_=e.sent).isValid){e.next=78;break}return e.abrupt("return",!1);case 78:return a=_.materialCode,e.abrupt("break",83);case 80:return this.$message.error("条码格式不正确，应为：物料编号-序号"),h(v.a),e.abrupt("return",!1);case 83:if(a!==this.mainMaterialCode){e.next=85;break}return e.abrupt("return",{materialCode:a,isValid:!0,relatedBill:r});case 85:if(I=this.processMaterials.find((function(e){return e.materialCode===a})),!I){e.next=88;break}return e.abrupt("return",{materialCode:a,isValid:!0,relatedBill:r});case 88:return this.$message.error("该条码对应的物料与当前工序所需物料不匹配"),e.abrupt("return",{materialCode:a,isValid:!1});case 90:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleMainBarcode:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(c.b)("material_process_flow",{query:{barcode:t}});case 3:if(!((a=e.sent).data&&a.data.length>0)){e.next=9;break}a.data[0],this.$message.success("扫描成功"),e.next=17;break;case 9:return e.next=11,Object(l.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:t,productLineId:this.productLineId,productLineName:this.productLineName});case 11:if(200!==(r=e.sent).code){e.next=16;break}this.$message.success("成品条码追溯记录创建成功"),e.next=17;break;case 16:throw new Error(r.msg||"创建成品条码追溯记录失败");case 17:e.next=24;break;case 19:throw e.prev=19,e.t0=e.catch(0),console.error("处理主条码失败:",e.t0),h(v.a),e.t0;case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),handleSubBarcode:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t,a){var r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=this.processMaterials.find((function(e){return e._id===t})),r){e.next=4;break}throw new Error("未找到对应的物料信息");case 4:if(r.materialCode===a){e.next=6;break}throw new Error("物料编码不一致");case 6:this.validateStatus[t]=!0,this.$message.success("扫码成功"),e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),console.error("处理子物料条码失败:",e.t0),h(v.a),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t,a){return e.apply(this,arguments)}}(),fillFormData:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.mainMaterialId&&this.materialName&&(this.formData.productName=this.materialName),this.processStepId&&this.processName&&(this.formData.processStep=this.processName),this.productLineId&&this.productLineName&&(this.formData.productLine=this.productLineId,this.formData.lineName=this.productLineName);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),resetScanForm:function(){var e=this;this.scanForm.mainBarcode="";var t={};this.processMaterials.forEach((function(a){if(a.isBatch){var r="batch_".concat(e.mainMaterialId,"_").concat(e.processStepId,"_").concat(a._id),s=localStorage.getItem(r);s?(t[a._id]=s,e.$set(e.validateStatus,a._id,!0)):(t[a._id]="",e.$set(e.validateStatus,a._id,!1))}else t[a._id]="",e.$set(e.validateStatus,a._id,!1)})),this.scanForm.barcodes=t,this.$set(this.validateStatus,"mainBarcode",!1),this.currentFlowId=null},handleUnifiedScan:function(){var e=Object(i.a)(Object(n.a)().mark((function e(t){var a=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:this.scanTimer&&clearTimeout(this.scanTimer),this.scanTimer=setTimeout(Object(i.a)(Object(n.a)().mark((function e(){var r,i,c,o,l,u,d,p,m,b;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=t.trim().replace(/[\r\n]/g,"")){e.next=4;break}return e.abrupt("return");case 4:return e.next=6,a.validateBarcode(r);case 6:if((i=e.sent).isValid){e.next=13;break}return setTimeout((function(){h(v.a)}),300),a.$notify({title:"条码验证失败",message:"条码格式不正确,未在系统中注册",type:"error",duration:3e3,position:"top-right"}),a.unifiedScanInput="",a.$refs.scanInput.focus(),e.abrupt("return");case 13:if(c=i.materialCode,o=!1,c!==a.mainMaterialCode){e.next=23;break}return a.scanForm.mainBarcode=t,a.validateStatus.mainBarcode=!0,e.next=20,a.handleMainBarcode(t);case 20:h(f.a),a.$notify({title:"主物料扫描成功",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>物料名称: '.concat(a.mainMaterialName,"</div>\n                                    <div>物料编码: ").concat(c,"</div>\n                                    <div>条码: ").concat(t,"</div>\n                                </div>\n                            "),type:"success",duration:3e3,position:"top-right"}),o=!0;case 23:if(o){e.next=49;break}l=Object(s.a)(a.processMaterials),e.prev=25,l.s();case 27:if((u=l.n()).done){e.next=41;break}if((d=u.value).materialCode!==c){e.next=39;break}return a.$set(a.scanForm.barcodes,d._id,t),a.$set(a.validateStatus,d._id,!0),d.isBatch&&(p="batch_".concat(a.mainMaterialId,"_").concat(a.processStepId,"_").concat(d._id),localStorage.setItem(p,t)),e.next=35,a.handleSubBarcode(d._id,c);case 35:return h(f.a),a.$notify({title:"子物料扫描成功",dangerouslyUseHTMLString:!0,message:'\n                                        <div style="line-height: 1.5">\n                                            <div>物料名称: '.concat(d.materialName,"</div>\n                                            <div>物料编码: ").concat(d.materialCode,"</div>\n                                            <div>条码: ").concat(t,"</div>\n                                            ").concat(i.relatedBill?"<div>关联单号: ".concat(i.relatedBill,"</div>"):"","\n                                        </div>\n                                    "),type:"success",duration:3e3,position:"top-right"}),o=!0,e.abrupt("break",41);case 39:e.next=27;break;case 41:e.next=46;break;case 43:e.prev=43,e.t0=e.catch(25),l.e(e.t0);case 46:return e.prev=46,l.f(),e.finish(46);case 49:if(m=Object.values(a.validateStatus).every((function(e){return!0===e})),!m){e.next=56;break}return a.$notify({title:"扫描完成",dangerouslyUseHTMLString:!0,message:'\n                                <div style="line-height: 1.5">\n                                    <div>所有物料已扫描完成</div>\n                                    <div style="color: #67C23A">正在发送确认提交...</div>\n                                </div>\n                            ',type:"success",duration:3e3,position:"top-right"}),e.next=54,a.handleConfirm();case 54:e.next=58;break;case 56:b=a.processMaterials.filter((function(e){return!a.validateStatus[e._id]})).map((function(e){return"".concat(e.materialName,"(").concat(e.materialCode,")")})).join("\n"),b&&a.$notify({title:"继续扫描",dangerouslyUseHTMLString:!0,message:'\n                                    <div style="line-height: 1.5">\n                                        <div>请继续扫描以下物料：</div>\n                                        <div style="color: #E6A23C; white-space: pre-line">'.concat(b,"</div>\n                                    </div>\n                                "),type:"info",duration:3e3,position:"top-right"});case 58:e.next=65;break;case 60:e.prev=60,e.t1=e.catch(0),console.error("扫描处理失败:",e.t1),setTimeout((function(){h(v.a)}),1e3),a.$notify({title:"扫描失败",message:e.t1.message||"扫描处理失败",type:"error",duration:3e3,position:"top-right"});case 65:return e.prev=65,a.unifiedScanInput="",a.$refs.scanInput.focus(),e.finish(65);case 69:case"end":return e.stop()}}),e,null,[[0,60,65,69],[25,43,46,49]])}))),1e3);case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),focusInput:function(){this.$refs.scanInput.focus()},handleCancelSave:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认取消当前工序设置？这将清除所有批次物料的缓存数据。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"取消设置中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),localStorage.removeItem("mainMaterialId"),localStorage.removeItem("processStepId"),localStorage.removeItem("materialName"),localStorage.removeItem("processName"),a=this.formData.productLine,r=this.formData.lineName,this.formData={productModel:"",productLine:a,lineName:r,processStep:"",componentName:""},this.$message.success("已取消工序设置"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("取消设置失败:",e.t0),this.$message.error("取消设置失败"));case 20:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),getValidateIcon:function(e){return this.validateStatus[e]?"el-icon-check success-icon":"el-icon-close error-icon"},handleConfirm:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r,s,i,o,u,d=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=Object.values(this.validateStatus).every((function(e){return!0===e})),t){e.next=5;break}return this.$message.warning("请完成所有条码扫描"),e.abrupt("return");case 5:return e.next=7,Object(c.b)("material_process_flow",{query:{barcode:this.scanForm.mainBarcode}});case 7:if((r=e.sent).data&&0!==r.data.length){e.next=23;break}return e.prev=9,e.next=12,Object(l.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:this.scanForm.mainBarcode,productLineId:this.productLineId,productLineName:this.productLineName});case 12:if(200===(s=e.sent).code){e.next=15;break}throw new Error("创建主流程记录失败");case 15:a=s.data,e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(9),new Error("创建流程记录失败: ".concat(e.t0.message));case 21:e.next=24;break;case 23:a=r.data[0];case 24:if(a){e.next=26;break}throw new Error("未能获取或创建有效的工艺流程记录");case 26:return i=[],this.processMaterials.forEach((function(e){i.push({materialId:e.materialId,barcode:d.scanForm.barcodes[e._id]})})),o={mainBarcode:this.scanForm.mainBarcode,processStepId:this.processStepId,componentScans:i,userId:this.$store.getters.id},e.next=31,Object(l.b)(o);case 31:if(200===(u=e.sent).code){e.next=34;break}throw new Error(u.message||"扫码失败");case 34:200==u.code&&setTimeout((function(){h(k.a)}),1e3),this.resetScanForm(),e.next=43;break;case 38:e.prev=38,e.t1=e.catch(0),this.resetScanForm(),console.error("确认失败:",e.t1),e.t1.message.includes("该主物料条码对应工序节点已完成或处于异常状态")?(this.$message.warning(e.t1.message),setTimeout((function(){h(w.a)}),1e3)):(this.$message.error("确认失败:"+e.t1.message),setTimeout((function(){h(v.a)}),1e3));case 43:case"end":return e.stop()}}),e,this,[[0,38],[9,18]])})));return function(){return e.apply(this,arguments)}}(),handlePrintSuccess:function(){this.$message.success("批次条码打印成功"),this.currentBatchBarcode=""},handlePrintError:function(e){this.$message.error("打印失败: ".concat(e)),this.currentBatchBarcode=""},handleDialogClose:function(){this.printDialogVisible=!1,this.currentBatchBarcode=""},handleAutoPrintChange:function(e){localStorage.setItem("autoPrint",e),this.$message.success("已".concat(e?"开启":"关闭","自动打印模式"))},handleClearCache:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认清除所有页面缓存数据？此操作不可恢复。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"清除缓存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),this.$message.success("缓存清除成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("清除缓存失败:",e.t0),this.$message.error("清除缓存失败"));case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),toggleCollapse:function(){this.isCollapsed=!this.isCollapsed},initWebSocket:function(){var e=this;try{this.ws&&this.ws.close();var t="ws://192.168.6.250:2223";console.log(t,"VUE_APP_WS_ADDRESS"),this.ws=new WebSocket("".concat(t,"?token=").concat("DcMes_Server_Token")),console.log(this.ws,"this.ws"),this.ws.onopen=function(){e.websocketConnected=!0,e.$message.success("设备服务器连接成功"),e.startHeartbeat(),e.reconnectAttempts=0},this.ws.onclose=function(t){if(e.websocketConnected=!1,e.stopHeartbeat(),console.log("WebSocket连接关闭:",t),e.reconnectAttempts<e.maxReconnectAttempts){e.reconnectAttempts++;var a=Math.min(1e3*Math.pow(2,e.reconnectAttempts),1e4);e.$message.warning("设备连接已断开，".concat(a/1e3,"秒后尝试第").concat(e.reconnectAttempts,"次重连...")),setTimeout((function(){e.initWebSocket()}),a)}else e.$message.error("重连次数已达上限，请检查网络连接或刷新页面")},this.ws.onerror=function(t){e.websocketConnected=!1,console.error("WebSocket连接错误:",t),console.log("错误详情:",{readyState:e.ws.readyState,url:e.ws.url,protocol:e.ws.protocol,error:t})},this.ws.onmessage=function(t){try{var a=JSON.parse(t.data);console.log("收到消息:",a),e.handleWebSocketMessage(a)}catch(e){console.error("消息解析错误:",e)}}}catch(e){console.error("WebSocket初始化失败:",e),this.$message.error("设备连接初始化失败: ".concat(e.message))}},handleWebSocketMessage:function(e){switch(e.type){case"connected":console.log("连接成功，用户ID:",e.userId);break;case"command":"refresh"===e.action&&window.location.reload();break;default:console.log("未知消息类型:",e)}},startHeartbeat:function(){var e=this;this.heartbeatTimer=setInterval((function(){e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"heartbeat"}))}),1e4)},stopHeartbeat:function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)},sendWebSocketMessage:function(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):this.$message.warning("设备未连接")}},created:function(){var e=Object(i.a)(Object(n.a)().mark((function e(){var t,a,r=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=localStorage.getItem("autoPrint"))&&(this.autoPrint="true"===t),this.initWebSocket(),a=localStorage.getItem("autoInit"),this.autoInit="true"===a,!this.autoInit){e.next=8;break}return e.next=8,this.getAutoInitConfig();case 8:if(!this.mainMaterialId){e.next=11;break}return e.next=11,this.getMainMaterialInfo();case 11:if(!this.processStepId){e.next=15;break}return e.next=14,this.getProcessMaterials();case 14:this.processMaterials.forEach((function(e){if(e.isBatch){var t="batch_".concat(r.mainMaterialId,"_").concat(r.processStepId,"_").concat(e._id),a=localStorage.getItem(t);a&&(r.$set(r.scanForm.barcodes,e._id,a),r.$set(r.validateStatus,e._id,!0))}}));case 15:return e.next=17,this.fillFormData();case 17:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),mounted:function(){this.mainMaterialId&&this.processStepId&&this.$refs.scanInput.focus(),console.log("Complete roles data:",this.$store.getters.roles);var e=this.$store.getters.roles;if(!e||!e.buttonList)return!1;e.buttonList.includes("scan_edit_configuration")&&(this.hasEditPermission=!0)},beforeDestroy:function(){this.scanTimer&&clearTimeout(this.scanTimer),this.ws&&this.ws.close(),this.stopHeartbeat()}},M=y,j=(a("bc54"),Object(C.a)(M,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"scan-container"},[a("div",{staticClass:"left-form",class:{collapsed:e.isCollapsed}},[a("el-card",{staticClass:"init-card"},[a("div",{staticClass:"card-header"},[a("span",[a("i",{staticClass:"el-icon-setting"}),e._v("\n                    工序设置")]),e._v(" "),a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"自动","inactive-text":"手动"},on:{change:e.handleAutoInitChange},model:{value:e.autoInit,callback:function(t){e.autoInit=t},expression:"autoInit"}})],1),e._v(" "),a("el-form",{attrs:{model:e.formData,"label-width":"100px"}},[a("div",{staticClass:"form-section"},[a("div",{staticClass:"section-header"},[a("el-tag",{attrs:{type:e.websocketConnected?"success":"danger"}},[a("i",{staticClass:"el-icon-goods"}),e._v("\n                            "+e._s(e.websocketConnected?"已连接":"未连接"))]),e._v(" "),a("span",[e._v("\n                            基础信息\n                        ")])],1),e._v(" "),a("el-form-item",{attrs:{label:"产品型号"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入物料编码/名称搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.productName,callback:function(t){e.$set(e.formData,"productName",t)},expression:"formData.productName"}}):a("zr-select",{attrs:{collection:"k3_BD_MATERIAL",disabled:!!e.mainMaterialId&&!!e.processStepId,"search-fields":["FNumber","FName"],"label-key":"FName","sub-key":"FMATERIALID",multiple:!1,placeholder:"请输入物料编码/名称搜索"},on:{select:e.handleProductChange},scopedSlots:e._u([{key:"option",fn:function(t){var r=t.item;return[a("div",{staticClass:"item-option"},[a("div",{staticClass:"item-info"},[a("span",[e._v(e._s(r.FNumber)+" - "+e._s(r.FName))]),e._v(" "),a("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(e._s(r.FMATERIALID)+" -"+e._s(r.FUseOrgId))])],1)])]}}],null,!1,1794309911),model:{value:e.formData.productModel,callback:function(t){e.$set(e.formData,"productModel",t)},expression:"formData.productModel"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"产品工序"}},[a("el-select",{staticClass:"custom-select",attrs:{placeholder:"请选择产品工序",disabled:!!e.mainMaterialId&&!!e.processStepId},on:{change:e.handleProcessChange},model:{value:e.formData.processStep,callback:function(t){e.$set(e.formData,"processStep",t)},expression:"formData.processStep"}},e._l(e.processStepOptions,(function(t){return a("el-option",{key:t._id,attrs:{label:t.processName,value:t._id}},[a("div",{staticClass:"option-content"},[a("span",{staticClass:"option-main"},[e._v(e._s(""+(t.levelPrefix||"")+t.sort+"."+t.processName))]),e._v(" "),a("span",{staticClass:"option-sub"},[e._v(e._s(t.processCode))])])])})),1)],1),e._v(" "),a("el-form-item",{attrs:{label:"产线编码"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入产线信息搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.lineName,callback:function(t){e.$set(e.formData,"lineName",t)},expression:"formData.lineName"}}):a("zr-select",{attrs:{disabled:!!e.mainMaterialId&&!!e.processStepId,collection:"production_line","search-fields":["lineCode","lineName"],"label-key":"lineName","tag-key":"lineCode","sub-key":"workshop",multiple:!1,placeholder:"请输入产线信息搜索"},on:{select:e.handleProductionLineSelect},model:{value:e.formData.productLine,callback:function(t){e.$set(e.formData,"productLine",t)},expression:"formData.productLine"}})],1)],1),e._v(" "),e.hasEditPermission?a("div",{staticClass:"button-group"},[e.mainMaterialId&&e.processStepId?a("el-button",{attrs:{type:"danger",icon:"el-icon-close"},on:{click:e.handleCancelSave}},[e._v("\n                        取消设置\n                    ")]):a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleSave}},[e._v("\n                        保存设置\n                    ")])],1):e._e()])],1)],1),e._v(" "),a("div",{staticClass:"right-content"},[e.mainMaterialId&&e.processStepId?[a("el-card",{staticClass:"scan-card"},[a("div",{staticClass:"card-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-scan"}),e._v(" "),a("span",[e._v("条码扫描")]),e._v(" "),a("el-button",{attrs:{type:"text"},on:{click:e.toggleCollapse}},[a("i",{class:e.isCollapsed?"el-icon-d-arrow-right":"el-icon-d-arrow-left"}),e._v("\n                            "+e._s(e.isCollapsed?"展开":"收起")+"\n                        ")])],1),e._v(" "),a("el-button",{attrs:{type:"text",icon:"el-icon-delete"},on:{click:e.handleClearCache}},[e._v("\n                        清除批次物料缓存\n                    ")])],1),e._v(" "),a("el-form",{ref:"scanForm",attrs:{model:e.scanForm,"label-width":"100%"}},[a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-camera"}),e._v(" "),a("span",[e._v("统一扫描区域")])]),e._v(" "),a("div",{staticClass:"scan-input-section"},[a("el-input",{ref:"scanInput",attrs:{placeholder:"请扫描条码",clearable:""},on:{input:e.handleUnifiedScan,clear:e.focusInput},model:{value:e.unifiedScanInput,callback:function(t){e.unifiedScanInput=t},expression:"unifiedScanInput"}})],1),e._v(" "),a("div",{staticClass:"section-header"},[a("div",{staticClass:"section-title"},[a("i",{staticClass:"el-icon-goods"}),e._v(" "),a("span",[e._v("主物料")])]),e._v(" "),a("div",{staticClass:"print-batch-btn"},[a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"自动","inactive-text":"手动"},on:{change:e.handleAutoPrintChange},model:{value:e.autoPrint,callback:function(t){e.autoPrint=t},expression:"autoPrint"}}),e._v(" "),a("el-button",{staticClass:"print-batch-btn",attrs:{type:"primary",size:"mini"},on:{click:e.handlePrintBatch}},[e._v("\n                                打印\n                            ")])],1)]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"编号："+e.mainMaterialCode+"  名称："+e.mainMaterialName,"label-width":"100%"}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus.mainBarcode},attrs:{placeholder:"请扫描主物料条码",readonly:""},model:{value:e.scanForm.mainBarcode,callback:function(t){e.$set(e.scanForm,"mainBarcode",t)},expression:"scanForm.mainBarcode"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})])],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus.mainBarcode}},[a("i",{class:e.getValidateIcon("mainBarcode")})])],1)])],1),e._v(" "),a("div",{staticClass:"section-header"},[a("i",{staticClass:"el-icon-box"}),e._v(" "),a("span",[e._v("子物料")])]),e._v(" "),a("div",{staticClass:"material-section"},[a("el-row",{attrs:{gutter:20}},e._l(e.processMaterials,(function(t){return a("el-col",{key:t._id,attrs:{span:12}},[a("el-form-item",{staticClass:"vertical-form-item",attrs:{label:"编号："+t.materialCode+"  名称："+t.materialName+"  "}},[a("div",{staticClass:"input-with-status"},[a("el-input",{class:{"valid-input":e.validateStatus[t._id]},attrs:{placeholder:"请扫描子物料条码",readonly:""},model:{value:e.scanForm.barcodes[t._id],callback:function(a){e.$set(e.scanForm.barcodes,t._id,a)},expression:"scanForm.barcodes[material._id]"}},[a("template",{slot:"prefix"},[a("i",{staticClass:"el-icon-full-screen"})]),e._v(" "),t.isBatch?a("template",{slot:"suffix"},[a("el-tag",{attrs:{type:"warning"}},[e._v("批次物料")])],1):e._e()],2),e._v(" "),a("div",{staticClass:"status-indicator",class:{valid:e.validateStatus[t._id]}},[a("i",{class:e.getValidateIcon(t._id)})])],1)])],1)})),1)],1),e._v(" "),a("div",{staticClass:"button-group"},[a("el-button",{attrs:{plain:"",icon:"el-icon-refresh"},on:{click:e.resetScanForm}},[e._v("重置")]),e._v(" "),a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleConfirm}},[e._v("确认")])],1)])],1)]:[e._m(0)]],2),e._v(" "),a("tsc-printer",{ref:"tscPrinter",attrs:{materialCode:e.mainMaterialCode,barcode:e.currentBatchBarcode}})],1)}),[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"init-tip"},[a("div",{staticClass:"overlay"},[a("i",{staticClass:"el-icon-warning-outline pulse"}),e._v(" "),a("p",[e._v("请先初始化工序设置")])])])}],!1,null,"130fb735",null));t.default=j.exports}}]);