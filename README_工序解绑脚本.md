# 工序解绑脚本使用说明

## 功能概述

该脚本用于解绑指定工单中**刚好做到特定工序**的条码，保留之前的工序数据。

### 主要功能

1. **查询工单信息**：根据工单号查询工单详细信息
2. **精确查找目标条码**：找出**刚好做到**指定工序的所有条码
3. **严格过滤**：**只处理刚好做到目标工序的条码**，如果后续工序已完成，将不允许解绑
4. **安全解绑**：调用系统解绑方法，确保数据一致性
5. **预览模式**：支持预览模式，先查看将要解绑的条码，再决定是否执行

### ⚠️ 重要说明

**只有刚好做到目标工序的条码才能解绑！**

例如：如果设置 `targetProcessSort: 2`（解绑第二道工序）
- ✅ **允许解绑**：条码刚好做到第二道工序（第二道完成，第三道及后续未完成）
- ❌ **不允许解绑**：条码已经做到第三道或更后的工序

## 使用场景

- 当某批产品做到第二道工序后发现问题，需要退回重新执行该工序
- 工序数据录入错误，需要清除后重新录入
- 工艺流程调整，需要重新执行某道工序

## 配置说明

打开 `unbind_second_process.js` 文件，找到配置区域：

```javascript
// 配置参数
const CONFIG = {
  // 工单号（必填）
  workOrderNo: "P202508231755932375363",
  
  // 目标工序序号（需要解绑的工序，必填）
  // 例如：2 表示第二道工序
  targetProcessSort: 2,
  
  // 解绑原因（可选，建议填写）
  unbindReason: "手动解绑第二道工序",
  
  // 操作用户ID（可选，默认为 SYSTEM）
  userId: "SYSTEM",
  
  // 是否真实执行（重要！）
  // true: 预览模式，仅查看将要解绑的条码，不实际执行
  // false: 真实执行模式，会实际解绑
  dryRun: true,
};

// 数据库连接配置
const DB_CONFIG = {
  host: "localhost",
  port: 27017,
  database: "dcMes",
  // 如果有用户名密码，请取消下面的注释并填写
  // username: "your_username",
  // password: "your_password",
};
```

### 配置参数说明

| 参数 | 说明 | 示例 | 必填 |
|------|------|------|------|
| workOrderNo | 工单号 | "P202508231755932375363" | ✅ |
| targetProcessSort | 要解绑的工序序号 | 2（第二道工序） | ✅ |
| unbindReason | 解绑原因 | "工序数据错误" | ⚠️ 建议填写 |
| userId | 操作用户ID | "SYSTEM" 或用户ObjectId | ❌ |
| dryRun | 是否预览模式 | true（预览）/ false（执行） | ✅ |

## 使用步骤

### 第一步：预览模式（推荐）

首先在预览模式下运行，查看将要解绑的条码：

1. 修改配置，设置 `dryRun: true`
2. 修改 `workOrderNo` 和 `targetProcessSort`
3. 运行脚本：

```bash
cd /Users/laijiwei/Documents/项目/德昌项目/dcmes/dechang-mes
node unbind_second_process.js
```

### 第二步：查看预览结果

脚本会显示以下信息：

```
========================================
   工序解绑脚本
========================================
配置信息:
  - 工单号: P202508231755932375363
  - 目标工序: 第 2 道
  - 解绑原因: 手动解绑第二道工序
  - 执行模式: 预览模式（不会实际执行）
========================================

✅ 数据库连接成功

🔍 正在查询工单: P202508231755932375363
✅ 找到工单:
   - 工单号: P202508231755932375363
   - 物料编码: 1108301018
   - 物料名称: 追觅P10 UNI宽电压高速吹风机
   - 产线: 德昌追觅C线包装
   - 状态: IN_PROGRESS
   - 计划数量: 1000
   - 投入数量: 500
   - 产出数量: 0

🔍 正在查找刚好做到第 2 道工序的条码...
   ⚠️  注意: 只有刚好做到第 2 道工序的条码才会被处理
   ⚠️  如果后续工序已完成，将不允许解绑
   - 该工单下共有 500 条流程记录
✅ 找到 120 个刚好做到第 2 道工序的条码（符合解绑条件）
   ⚠️  过滤掉 50 个条码（已做到第 3 道或更后的工序，不允许解绑）

[1/120] 处理条码: P2306O594AU1428126
   - 物料: 1108301018 追觅P10 UNI宽电压高速吹风机
   - 工序: 扫主产品绑定天地合 (A_G_0002_4)
   - 完成时间: 2025-09-14 15:29:35
   - 当前进度: 28%
   ✅ [预览] 该条码符合解绑条件，将被解绑

...

========================================
📊 预览结果
========================================
✅ 成功: 120 个
❌ 失败: 0 个
========================================

✅ 符合解绑条件的条码:
   1. P2306O594AU1428126
   2. P2306O594AU1428127
   ...

💡 提示: 当前为预览模式，未实际执行解绑操作
   如需真实执行，请将 CONFIG.dryRun 设置为 false
```

### 第三步：真实执行

确认预览结果无误后，执行真实解绑：

1. 修改配置，设置 `dryRun: false`
2. 再次运行脚本：

```bash
node unbind_second_process.js
```

## 安全机制

### 严格的条码过滤

脚本在查询阶段就会严格过滤条码：

1. **只选择刚好做到目标工序的条码**：目标工序状态为 COMPLETED，且后续工序都未完成
2. **自动过滤掉不符合条件的条码**：如果条码的后续工序已完成，将在查询阶段就被过滤掉，不会进入解绑流程

### 过滤逻辑示例

假设设置 `targetProcessSort: 2`（解绑第二道工序）：

| 条码 | 第一道 | 第二道 | 第三道 | 第四道 | 是否处理 | 说明 |
|------|-------|-------|-------|-------|---------|------|
| A001 | ✅ 完成 | ✅ 完成 | ⏸ 未开始 | ⏸ 未开始 | ✅ **处理** | 刚好做到第二道 |
| A002 | ✅ 完成 | ✅ 完成 | ✅ 完成 | ⏸ 未开始 | ❌ **过滤** | 已做到第三道 |
| A003 | ✅ 完成 | ✅ 完成 | ✅ 完成 | ✅ 完成 | ❌ **过滤** | 已做到第四道 |
| A004 | ✅ 完成 | ⏸ 未开始 | ⏸ 未开始 | ⏸ 未开始 | ❌ **不符合** | 第二道未完成 |

### 错误处理

- 单个条码解绑失败不会影响其他条码的处理
- 每个条码的处理结果都会记录
- 最后会汇总显示成功、失败的数量
- 被过滤掉的条码数量会在查询阶段显示

## 工序顺序说明

从 cs.json 示例可以看到工序结构：

| processSort | 工序名称 | processCode | 说明 |
|-------------|----------|-------------|------|
| 1 | SN码扫码验证 | A_C_0001_4 | 第一道工序 |
| 2 | 扫主产品绑定天地合 | A_G_0002_4 | 第二道工序 |
| 3 | 天地合一配一打印 | A_G_0003_4 | 第三道工序 |
| 4 | 电子称称重 | A_C_0004_4 | 第四道工序 |
| 5 | 扫主产品装箱 | A_E_0005_4 | 第五道工序 |
| 6 | 托盘打印 | A_F_0006_4 | 第六道工序 |

## 示例场景

### 场景1：解绑第二道工序

```javascript
const CONFIG = {
  workOrderNo: "P202508231755932375363",
  targetProcessSort: 2,  // 第二道工序
  unbindReason: "第二道工序数据错误，需要重新绑定",
  userId: "67d792c54f31c06c540915cf",
  dryRun: true,  // 先预览
};
```

### 场景2：解绑第三道工序

```javascript
const CONFIG = {
  workOrderNo: "P202508231755932375363",
  targetProcessSort: 3,  // 第三道工序
  unbindReason: "打印标签错误，需要重新打印",
  userId: "67d792c54f31c06c540915cf",
  dryRun: true,
};
```

## 输出结果说明

### 查询阶段输出

```
🔍 正在查找刚好做到第 2 道工序的条码...
   ⚠️  注意: 只有刚好做到第 2 道工序的条码才会被处理
   ⚠️  如果后续工序已完成，将不允许解绑
   - 该工单下共有 500 条流程记录
✅ 找到 120 个刚好做到第 2 道工序的条码（符合解绑条件）
   ⚠️  过滤掉 50 个条码（已做到第 3 道或更后的工序，不允许解绑）
```

**说明**：
- 符合条件的条码（120个）：刚好做到第二道工序，第三道及后续未完成
- 被过滤的条码（50个）：已经做到第三道或更后的工序，不允许解绑

### 成功输出

**预览模式**：
```
✅ 符合解绑条件的条码:
   1. P2306O594AU1428126
   2. P2306O594AU1428127
   3. P2306O594AU1428128
   ...
```

**执行模式**：
```
✅ 成功解绑的条码:
   1. P2306O594AU1428126
   2. P2306O594AU1428127
   3. P2306O594AU1428128
   ...
```

### 失败输出

```
❌ 解绑失败的条码:
   1. P2306O594AU1428200 - 未找到对应的工序节点
   2. P2306O594AU1428201 - 该工序未完成，无需解绑
```

## 注意事项

⚠️ **重要提示**

1. **严格的条码筛选**：只处理**刚好做到目标工序**的条码，后续工序已完成的条码将被自动过滤
2. **先预览，再执行**：务必先在预览模式下运行，确认无误后再真实执行
3. **备份数据**：执行前建议备份数据库
4. **业务高峰避让**：建议在业务低峰期执行，避免影响生产
5. **确认工序序号**：确保 `targetProcessSort` 设置正确
6. **查看过滤数量**：注意查询结果中显示的"过滤掉"的条码数量
7. **记录执行日志**：保存脚本的输出日志，便于后续追溯

### 典型场景说明

**场景1：正常解绑**
- 条码状态：第一道✅ → 第二道✅ → 第三道⏸
- 设置：`targetProcessSort: 2`
- 结果：✅ 允许解绑第二道工序

**场景2：不允许解绑**
- 条码状态：第一道✅ → 第二道✅ → 第三道✅ → 第四道⏸
- 设置：`targetProcessSort: 2`
- 结果：❌ 自动过滤，不允许解绑（第三道已完成）

**场景3：条码不符合**
- 条码状态：第一道✅ → 第二道⏸ → 第三道⏸
- 设置：`targetProcessSort: 2`
- 结果：❌ 不会被查询到（第二道未完成）

## 故障排查

### 问题1：数据库连接失败

**症状**：显示 "❌ 数据库连接失败"

**解决方案**：
- 检查 MongoDB 是否运行
- 检查 DB_CONFIG 配置是否正确
- 检查数据库用户名密码（如果有）

### 问题2：未找到工单

**症状**：显示 "未找到工单号为 xxx 的工单"

**解决方案**：
- 检查工单号是否正确
- 确认工单在数据库中存在

### 问题3：未找到需要解绑的条码

**症状**：显示 "未找到需要解绑的条码"

**可能原因**：
- 该工单下没有条码做到目标工序
- targetProcessSort 设置错误
- 目标工序的状态不是 COMPLETED

### 问题4：解绑失败

**症状**：某些条码显示解绑失败

**常见原因**：
- "该工序未完成，无需解绑"：工序状态不是 COMPLETED
- "未找到对应的工序节点"：流程数据异常
- 数据库锁冲突：重试机制会自动处理

## 技术说明

### 调用的服务方法

```javascript
MaterialProcessFlowService.unbindProcessComponents(
  mainBarcode,        // 主条码
  processStepId,      // 工序ID
  userId,             // 用户ID
  reason,             // 解绑原因
  false,              // unbindSubsequent: 不解绑后续工序
  false               // fromPalletUnbind: 不是来自托盘解绑
);
```

### 数据模型

- **MaterialProcessFlow**：物料工艺流程记录
- **ProductionPlanWorkOrder**：生产计划工单
- **processNodes**：工序节点数组，包含工序状态和顺序信息

### 查询逻辑

1. 根据 `workOrderNo` 查询工单获取 `_id`
2. 根据 `productionPlanWorkOrderId` 查询所有流程记录
3. 遍历每条记录的 `processNodes` 数组
4. 筛选 `nodeType === "PROCESS_STEP"` 且 `processSort === targetProcessSort` 且 `status === "COMPLETED"` 的节点
5. 检查是否有 `processSort > targetProcessSort` 且 `status === "COMPLETED"` 的后续工序

## 修改建议

如需解绑其他工序，只需修改 `CONFIG.targetProcessSort`：

- 解绑第一道工序：`targetProcessSort: 1`
- 解绑第二道工序：`targetProcessSort: 2`
- 解绑第三道工序：`targetProcessSort: 3`
- 以此类推...

## 联系支持

如果遇到问题，请联系技术支持，并提供：
1. 完整的错误日志
2. 工单号
3. 目标工序序号
4. 执行时间

---

**版本**：1.0.0  
**创建日期**：2024-10-24  
**最后更新**：2024-10-24

