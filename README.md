# -MES-（德昌MES系统）

## 项目概述

德昌MES（制造执行系统）是一个完整的生产管理解决方案，包含前端Vue系统和后端Node.js服务。

### 项目架构
- **dcMes_vue_system**: Vue.js前端系统
- **dcMes_server**: 主要后端服务
- **dcMes_server_system**: 系统管理服务
- **dcMes_server_ws**: WebSocket服务

## 最近修复记录

### 2024-09-22 用户15分钟无活动自动退出功能

**功能描述：**
实现了用户登录后15分钟无活动自动退出的安全功能，包含前端活动监听和后端token验证。

**实现特性：**

1. **前端活动监听**
   - 监听用户鼠标、键盘、滚动等活动
   - 15分钟无活动自动退出
   - 14分钟时显示警告提示
   - 页面刷新时检查活动超时

2. **后端token增强**
   - JWT token包含登录时间和最后活动时间
   - 中间件自动检查活动超时
   - 自动更新token中的活动时间
   - 接近超时时在响应头中发送警告

3. **核心文件修改**
   - `dcMes_vue_system/src/utils/userActivity.js` - 用户活动监听工具
   - `dcMes_vue_system/src/App.vue` - 集成活动监听
   - `dcMes_vue_system/src/store/modules/user.js` - 登录退出时启停监听
   - `dcMes_vue_system/src/utils/request.js` - 处理服务器返回的新token
   - `dcMes_server/middleware/activityCheck.js` - 活动检查中间件
   - `dcMes_server/routes/managerlogin.js` - 增强token生成
   - `dcMes_server/app.js` - 集成活动检查中间件

4. **测试页面**
   - `dcMes_vue_system/src/views/test/AutoLogoutTest.vue` - 功能测试页面

**使用说明：**
- 用户登录后自动启动活动监听
- 任何用户操作都会重置15分钟计时器
- 第14分钟显示"1分钟后将自动退出"警告
- 15分钟后自动清除用户状态并跳转到登录页
- 页面刷新时会检查上次活动时间，超时立即退出

**安全特性：**
- 防止用户长时间离开后被他人操作
- 服务器端双重验证，确保token时效性
- 优雅的用户体验，提前警告避免数据丢失

### 2024年扫码页面防重复提交修复

**问题描述：**
在 `dcMes_vue_system/src/views/scanBarCode/index.vue` 页面中发现严重的防重复提交问题：

1. **确认按钮缺乏保护**：没有loading状态或disabled属性，用户可以重复点击
2. **扫码枪重复触发**：在提交过程中，扫码枪可能继续扫码并触发新的提交请求
3. **双重加载状态**：扫码处理和确认提交各自创建加载状态，造成用户体验问题

**修复方案：**

1. **添加防重复提交标志位**
```javascript
   data() {
     return {
       // 添加防重复提交标志位
       isSubmitting: false,
       // ... 其他数据
  }
}
```

2. **优化确认按钮**
   ```vue
   <el-button
     type="primary"
     @click="handleConfirm"
     icon="el-icon-check"
     :loading="isSubmitting"
     :disabled="isSubmitting"
   >{{ isSubmitting ? '提交中...' : $t('scanBarCode.buttons.confirm') }}</el-button>
   ```

3. **增强 handleConfirm 方法**
   - 添加提交状态检查
   - 在 finally 块中重置状态
   - 确保状态正确管理

4. **优化扫码自动提交逻辑**
   - 在自动调用 handleConfirm 前检查提交状态
   - 避免重复提交请求

**技术要点：**
- 使用 `isSubmitting` 标志位控制提交状态
- 按钮显示loading状态和禁用状态
- 在异步操作的 finally 块中重置状态
- 确保用户体验和数据一致性

**修复效果：**
- ✅ 防止确认按钮重复点击
- ✅ 防止扫码枪频繁扫码导致的重复提交
- ✅ 改善用户界面反馈
- ✅ 确保数据提交的原子性和一致性

### 2024年扫码转换页面防重复提交修复

**问题描述：**
`dcMes_vue_system/src/views/scanBarCodeConver/index.vue` 页面存在与主扫码页面相同的防重复提交问题。

**修复方案：**
采用与主扫码页面相同的修复策略：
- 添加 `isSubmitting` 防重复提交标志位
- 确认按钮增加loading状态和禁用状态  
- 扫码输入框在提交期间禁用
- 自动提交前检查提交状态
- 在finally块中重置状态

**修复效果：**
- ✅ 防止条码转换页面的重复提交问题
- ✅ 统一了所有扫码页面的安全防护机制
- ✅ 保证了条码转换功能的可靠性

### 2024年包装扫码页面防重复提交修复

**问题描述：**
`dcMes_vue_system/src/views/scanBarCodePack/index.vue` 页面存在与其他扫码页面相同的防重复提交问题。

**修复方案：**
采用统一的防重复提交策略：
- 添加 `isSubmitting` 防重复提交标志位
- 确认按钮增加loading状态和禁用状态  
- 扫码输入框在提交期间禁用
- 自动提交前检查提交状态
- 在finally块中重置状态

**修复效果：**
- ✅ 防止包装扫码页面的重复提交问题
- ✅ 完善了生产流程中的安全防护机制
- ✅ 保证了包装验证过程的数据一致性

### 2024年检测数据页面历史导出功能新增

**需求描述：**
在现有检测数据导出功能基础上，新增历史检验数据导出功能，支持批量导出和单一条码导出。

**实现方案：**

1. **新增批量导出历史数据功能**
   - 基于当前筛选条件获取相关条码
   - 分批查询历史检验数据避免查询过大
   - 支持进度显示和动态文件名生成

2. **新增单一条码导出历史功能**
   - 在数据列表每行添加"导出历史"链接
   - 导出该条码的所有历史检验记录
   - 按时间倒序排列

3. **优化导出进度显示**
   - 统一导出进度对话框
   - 根据导出类型显示不同的进度文本
   - 支持历史数据导出进度追踪

**技术实现：**
```javascript
// 批量导出历史数据
async handleExportBatchHistory() {
  // 1. 获取筛选条件对应的条码
  // 2. 分批查询InspectionData集合
  // 3. 合并所有历史数据并导出
}

// 单一条码导出历史数据  
async handleExportSingleHistory(row) {
  // 1. 基于scanCode查询该条码所有历史数据
  // 2. 按时间倒序排列
  // 3. 导出Excel文件
}
```

**功能特性：**
- ✅ 支持基于筛选条件的批量历史数据导出
- ✅ 支持单个条码的历史检验记录导出
- ✅ 分批查询机制，提高大数据量查询性能
- ✅ 统一的进度显示和用户反馈
- ✅ 动态文件名生成，包含筛选条件信息
- ✅ 复用现有筛选逻辑，保持功能一致性

**数据源说明：**
- 最新检测数据：`InspectionLastData` 集合
- 历史检验数据：`InspectionData` 集合  
- 支持设备和工序信息的关联查询（populate）

## 页面功能说明

### 扫码页面 (scanBarCode)
- **主要功能**：生产过程中的物料条码扫描和验证
- **核心流程**：
  1. 初始化工序和物料信息
  2. 扫描主物料条码
  3. 扫描子物料条码
  4. 验证所有必要条码后提交
- **安全特性**：防重复提交、条码验证、批次管理

### 扫码转换页面 (scanBarCodeConver)
- **主要功能**：支持条码转换功能的扫码页面
- **核心流程**：
  1. 初始化工序和物料信息
  2. 扫描主物料条码
  3. 自动填充子物料条码（支持条码转换）
  4. 自动提交验证
- **安全特性**：防重复提交、条码转换、自动填充

### 包装扫码页面 (scanBarCodePack)
- **主要功能**：包装过程中的条码扫描和验证
- **核心流程**：
  1. 初始化工序和物料信息
  2. 扫描主物料条码
  3. 扫描子物料条码
  4. 验证所有必要条码后提交
- **安全特性**：防重复提交、批次管理、包装验证

### 检测数据页面 (detectedData)
- **主要功能**：检测数据的查询、查看和导出
- **核心流程**：
  1. 多条件筛选检测数据（扫描码、设备、工序、时间范围、物料编码、销售订单、流程状态）
  2. 分页展示检测数据列表
  3. 查看检测详情和历史记录
  4. 导出检测数据和历史检验数据
- **导出功能**：
  - **导出数据**：导出当前筛选条件下的最新检测数据
  - **按物料导出**：基于物料编码等条件导出最新检测数据
  - **批量导出历史数据**：基于当前筛选条件导出所有相关条码的历史检验记录
  - **单一导出历史**：导出单个条码的所有历史检验记录
- **数据源**：
  - 最新检测数据来自 `InspectionLastData` 集合
  - 历史检验数据来自 `InspectionData` 集合
- **特色功能**：支持物料编码和销售订单的关联查询，自动匹配工单和流程条码

## 版本管理系统

### 2024年9月新增版本管理功能

**功能概述：**
为德昌MES系统新增了完整的前端版本管理功能，支持版本号显示、版本信息查看和多语言支持。

**核心文件：**
- `dcMes_vue_system/src/config/version.js` - 版本配置文件
- `dcMes_vue_system/src/layout/components/Navbar.vue` - 导航栏组件（新增版本显示）

**版本配置结构：**
```javascript
{
  major: 4,                    // 主版本号  
  minor: 2,                    // 次版本号
  patch: 1,                    // 修订版本号
  build: '20240919',           // 构建日期
  status: 'stable',            // 版本状态
  releaseDate: '2024-09-19',   // 发布日期
  codeName: 'Phoenix',         // 版本代号
  environment: 'development',  // 运行环境
  description: '德昌MES制造执行系统 - 生产管理一体化解决方案'
}
```

**功能特性：**
- ✅ **版本号显示**：在导航栏右侧显示当前系统版本号
- ✅ **详细信息**：点击版本号可查看完整版本信息
- ✅ **多语言支持**：支持中文、英文、越南语三种语言界面
- ✅ **环境标识**：自动识别开发/生产环境
- ✅ **状态管理**：支持dev、beta、rc、stable四种版本状态
- ✅ **视觉反馈**：不同版本状态显示不同的颜色标识

**版本更新流程：**
1. 修改 `src/config/version.js` 中的版本号和相关信息
2. 更新构建日期和发布日期
3. 根据版本类型选择合适的状态标识
4. 版本信息将自动在导航栏中更新显示

**多语言支持：**
版本相关文本已添加到以下语言文件：
- `src/lang/zh-CN.js` - 中文简体
- `src/lang/en-US.js` - 英文
- `src/lang/vi-VN.js` - 越南语

**使用示例：**
```javascript
import { getVersion, getVersionInfo, getVersionColor } from '@/config/version'

// 获取版本号：v4.2.1
const version = getVersion()

// 获取完整版本信息
const versionInfo = getVersionInfo()

// 获取版本状态颜色
const color = getVersionColor()
```

## 开发规范

### 前端开发
- 使用Vue.js + Element UI
- 遵循组件化开发
- 实现响应式设计
- 添加详细的中文注释

### 后端开发
- 使用Node.js + Express
- RESTful API设计
- 完善的错误处理
- 详细的API文档

### 安全考虑
- 防重复提交保护
- 输入验证和清理
- 状态管理和同步
- 错误处理和用户反馈

## 部署结构
- 生产环境部署在专用服务器
- 支持多环境配置
- 完整的日志系统
- 自动化备份机制
