# è£…ç®±æ¡ç åºåˆ—å·å”¯ä¸€æ€§æµ‹è¯•éªŒè¯æ–¹æ¡ˆ

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯è£…ç®±æ¡ç åºåˆ—å·æŒ‰æ¡ç è§„åˆ™å…¨å±€å”¯ä¸€çš„ä¿®æ”¹æ˜¯å¦æ­£ç¡®å·¥ä½œï¼Œç¡®ä¿ä¸åŒç‰©æ–™ä½¿ç”¨ç›¸åŒæ¡ç è§„åˆ™æ—¶ä¸ä¼šäº§ç”Ÿé‡å¤æ¡ç ã€‚

## ğŸ“‹ æµ‹è¯•å‡†å¤‡

### 1. æµ‹è¯•ç¯å¢ƒ
- ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- æ•°æ®åº“è¿æ¥æ­£å¸¸
- è‡³å°‘æœ‰ä¸¤ä¸ªä¸åŒç‰©æ–™ç»‘å®šç›¸åŒçš„æ¡ç è§„åˆ™

### 2. æµ‹è¯•æ•°æ®å‡†å¤‡

#### æ¡ç è§„åˆ™ç¤ºä¾‹ï¼š
```javascript
// åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„æ¡ç è§„åˆ™ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
{
  "_id": "rule123456",
  "name": "æµ‹è¯•è£…ç®±æ¡ç è§„åˆ™",
  "code": "TEST_PACK_RULE",
  "segments": [
    { "type": "fixed", "value": "TP" },
    { "type": "date", "format": "YYYY" },
    { "type": "date", "format": "MM" },
    { "type": "serial", "length": 4, "startFrom": 1 }
  ]
}
```

#### ç‰©æ–™ç»‘å®šç¤ºä¾‹ï¼š
```javascript
// ç‰©æ–™Aç»‘å®šæµ‹è¯•è§„åˆ™
{
  "materialId": "material_A_001",
  "ruleId": "rule123456",
  "enabled": true
}

// ç‰©æ–™Bç»‘å®šåŒæ ·çš„æµ‹è¯•è§„åˆ™  
{
  "materialId": "material_B_002", 
  "ruleId": "rule123456",
  "enabled": true
}
```

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•ç”¨ä¾‹1ï¼šåŸºç¡€åºåˆ—å·å”¯ä¸€æ€§éªŒè¯

#### æµ‹è¯•æ­¥éª¤ï¼š

**1. ä¸ºç‰©æ–™Aåˆ›å»ºè£…ç®±æ¡ç ï¼š**
```bash
curl -X POST http://localhost:3000/api/v1/getOrCreatePackBarcode \
  -H "Content-Type: application/json" \
  -d '{
    "productionLineId": "line001",
    "materialNumber": "MAT-A-001",
    "materialId": "material_A_001",
    "materialName": "æµ‹è¯•ç‰©æ–™A",
    "sessionId": "test_session_1",
    "deviceIp": "test_device_1"
  }'
```

**æœŸæœ›ç»“æœï¼š**
```json
{
  "success": true,
  "data": {
    "serialNumber": 1,
    "barcode": "TP20241201",
    "ruleId": "rule123456",
    "materialNumber": "MAT-A-001"
  },
  "message": "åˆ›å»ºæ–°çš„è£…ç®±æ¡ç æˆåŠŸï¼Œå·²é”å®š"
}
```

**2. ä¸ºç‰©æ–™Båˆ›å»ºè£…ç®±æ¡ç ï¼š**
```bash
curl -X POST http://localhost:3000/api/v1/getOrCreatePackBarcode \
  -H "Content-Type: application/json" \
  -d '{
    "productionLineId": "line001",
    "materialNumber": "MAT-B-002", 
    "materialId": "material_B_002",
    "materialName": "æµ‹è¯•ç‰©æ–™B",
    "sessionId": "test_session_2",
    "deviceIp": "test_device_2"
  }'
```

**æœŸæœ›ç»“æœï¼š**
```json
{
  "success": true,
  "data": {
    "serialNumber": 2,  // âœ… å…³é”®ï¼šåºåˆ—å·åº”è¯¥æ˜¯2ï¼Œä¸æ˜¯1
    "barcode": "TP20241202",  // âœ… å…³é”®ï¼šæ¡ç åº”è¯¥ä¸åŒ
    "ruleId": "rule123456",
    "materialNumber": "MAT-B-002"
  },
  "message": "åˆ›å»ºæ–°çš„è£…ç®±æ¡ç æˆåŠŸï¼Œå·²é”å®š"
}
```

#### éªŒè¯ç‚¹ï¼š
- âœ… ä¸¤ä¸ªæ¡ç çš„åºåˆ—å·åº”è¯¥è¿ç»­ï¼š1 å’Œ 2
- âœ… ä¸¤ä¸ªæ¡ç çš„å†…å®¹åº”è¯¥ä¸åŒï¼šTP20241201 å’Œ TP20241202
- âœ… ä¸¤ä¸ªæ¡ç çš„ ruleId åº”è¯¥ç›¸åŒï¼šrule123456
- âœ… materialNumber åº”è¯¥ä¸åŒï¼šMAT-A-001 å’Œ MAT-B-002

### æµ‹è¯•ç”¨ä¾‹2ï¼šçŠ¶æ€æ£€æŸ¥APIéªŒè¯

**æŸ¥è¯¢ç‰©æ–™Açš„çŠ¶æ€ï¼š**
```bash
curl -X GET "http://localhost:3000/api/v1/checkPackBarcodeStatus?productionLineId=line001&materialNumber=MAT-A-001&materialId=material_A_001"
```

**æœŸæœ›ç»“æœï¼š**
```json
{
  "success": true,
  "data": {
    "statusCounts": [
      {"_id": "LOCKED", "count": 2}
    ],
    "nextSerialNumber": 3,  // âœ… ä¸‹ä¸€ä¸ªåºåˆ—å·åº”è¯¥æ˜¯3ï¼ˆå…¨å±€è§†è§’ï¼‰
    "ruleId": "rule123456",  // âœ… è¿”å›è§„åˆ™ID
    "isGlobalSequence": true,  // âœ… æ ‡è¯†ä½¿ç”¨å…¨å±€åºåˆ—å·
    "monthRange": {
      "start": "2024-12-01T00:00:00.000Z",
      "end": "2025-01-01T00:00:00.000Z"
    }
  }
}
```

### æµ‹è¯•ç”¨ä¾‹3ï¼šå¹¶å‘åˆ›å»ºæµ‹è¯•

**æ¨¡æ‹Ÿå¹¶å‘æƒ…å†µï¼š**
```bash
# åŒæ—¶å‘é€å¤šä¸ªè¯·æ±‚
for i in {1..5}; do
  curl -X POST http://localhost:3000/api/v1/getOrCreatePackBarcode \
    -H "Content-Type: application/json" \
    -d "{
      \"productionLineId\": \"line001\",
      \"materialNumber\": \"MAT-C-${i}\",
      \"materialId\": \"material_C_${i}\",
      \"materialName\": \"æµ‹è¯•ç‰©æ–™C${i}\",
      \"sessionId\": \"test_session_${i}\",
      \"deviceIp\": \"test_device_${i}\"
    }" &
done
wait
```

**æœŸæœ›ç»“æœï¼š**
- æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æˆåŠŸ
- åºåˆ—å·åº”è¯¥è¿ç»­ä¸”ä¸é‡å¤ï¼š3, 4, 5, 6, 7ï¼ˆæ¥ç»­ä¹‹å‰çš„åºåˆ—å·ï¼‰
- æ‰€æœ‰æ¡ç å†…å®¹éƒ½åº”è¯¥å”¯ä¸€

### æµ‹è¯•ç”¨ä¾‹4ï¼šé”™è¯¯æƒ…å†µå¤„ç†

**æµ‹è¯•æ— æ¡ç è§„åˆ™çš„ç‰©æ–™ï¼š**
```bash
curl -X POST http://localhost:3000/api/v1/getOrCreatePackBarcode \
  -H "Content-Type: application/json" \
  -d '{
    "productionLineId": "line001",
    "materialNumber": "MAT-NO-RULE",
    "materialId": "material_no_rule",
    "materialName": "æ— è§„åˆ™ç‰©æ–™",
    "sessionId": "test_session_error",
    "deviceIp": "test_device_error"
  }'
```

**æœŸæœ›ç»“æœï¼š**
```json
{
  "success": false,
  "message": "ç‰©æ–™æœªç»‘å®šæ¡ç è§„åˆ™"
}
```

## ğŸ” éªŒè¯æ£€æŸ¥æ¸…å•

### æ•°æ®åº“éªŒè¯

**1. æ£€æŸ¥PackBarcodeé›†åˆï¼š**
```javascript
// åœ¨MongoDBä¸­æ‰§è¡Œ
db.packbarcodes.find({
  ruleId: "rule123456",
  createAt: {
    $gte: new Date("2024-12-01"),
    $lt: new Date("2025-01-01")
  }
}).sort({serialNumber: 1});
```

**æœŸæœ›ç»“æœï¼š**
- æ‰€æœ‰è®°å½•çš„ ruleId ç›¸åŒ
- serialNumber è¿ç»­é€’å¢ï¼š1, 2, 3, 4, 5...
- barcode å†…å®¹éƒ½ä¸åŒ
- materialNumber ä¸åŒä½†ä½¿ç”¨ç›¸åŒè§„åˆ™

**2. æ£€æŸ¥åºåˆ—å·å”¯ä¸€æ€§ï¼š**
```javascript
// æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„åºåˆ—å·
db.packbarcodes.aggregate([
  {
    $match: {
      ruleId: "rule123456",
      createAt: {
        $gte: new Date("2024-12-01"),
        $lt: new Date("2025-01-01")
      }
    }
  },
  {
    $group: {
      _id: "$serialNumber",
      count: { $sum: 1 },
      docs: { $push: "$$ROOT" }
    }
  },
  {
    $match: { count: { $gt: 1 } }
  }
]);
```

**æœŸæœ›ç»“æœï¼š**
- åº”è¯¥è¿”å›ç©ºç»“æœï¼ˆæ²¡æœ‰é‡å¤çš„åºåˆ—å·ï¼‰

### æ—¥å¿—éªŒè¯

**æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œåº”è¯¥åŒ…å«ï¼š**
```
æ¡ç è§„åˆ™ rule123456 æ‰¾åˆ°å¯ç”¨åºåˆ—å·: 1
æ¡ç è§„åˆ™ rule123456 æ‰¾åˆ°å¯ç”¨åºåˆ—å·: 2
æ¡ç è§„åˆ™ rule123456 æ‰¾åˆ°å¯ç”¨åºåˆ—å·: 3
...
```

**ä¸åº”è¯¥å‡ºç°ï¼š**
```
ç‰©æ–™ MAT-A-001 æ‰¾åˆ°å¯ç”¨åºåˆ—å·: 1  âŒ æ—§é€»è¾‘
ç‰©æ–™ MAT-B-002 æ‰¾åˆ°å¯ç”¨åºåˆ—å·: 1  âŒ æ—§é€»è¾‘ï¼ˆä¼šå¯¼è‡´é‡å¤ï¼‰
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

**1. åºåˆ—å·ä»ç„¶é‡å¤**
- æ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®éƒ¨ç½²
- ç¡®è®¤ `findNextAvailableSerialNumber` ä½¿ç”¨çš„æ˜¯ `ruleId` å‚æ•°
- æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ¡ä»¶

**2. ç‰©æ–™æ— æ³•åˆ›å»ºæ¡ç **
- ç¡®è®¤ç‰©æ–™å·²æ­£ç¡®ç»‘å®šæ¡ç è§„åˆ™
- æ£€æŸ¥ `BarcodeSegmentRuleMaterial` é›†åˆä¸­çš„ç»‘å®šå…³ç³»

**3. APIè¿”å›é”™è¯¯**
- æ£€æŸ¥å¿…éœ€å‚æ•°æ˜¯å¦é½å…¨ï¼š`materialId`ã€`productionLineId`ã€`materialNumber`
- ç¡®è®¤æ¡ç è§„åˆ™å­˜åœ¨ä¸”å¯ç”¨

## ğŸ“Š æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

### æµ‹è¯•ç»“æœè®°å½•

| æµ‹è¯•ç”¨ä¾‹ | ç‰©æ–™ | é¢„æœŸåºåˆ—å· | å®é™…åºåˆ—å· | é¢„æœŸæ¡ç  | å®é™…æ¡ç  | ç»“æœ |
|---------|------|------------|------------|----------|----------|------|
| ç”¨ä¾‹1-1 | MAT-A-001 | 1 | \_\_\_ | TP20241201 | \_\_\_ | âœ…/âŒ |
| ç”¨ä¾‹1-2 | MAT-B-002 | 2 | \_\_\_ | TP20241202 | \_\_\_ | âœ…/âŒ |
| ç”¨ä¾‹3-1 | MAT-C-1 | 3 | \_\_\_ | TP20241203 | \_\_\_ | âœ…/âŒ |
| ç”¨ä¾‹3-2 | MAT-C-2 | 4 | \_\_\_ | TP20241204 | \_\_\_ | âœ…/âŒ |

### éªŒè¯æ€»ç»“

- [ ] åŸºç¡€åºåˆ—å·å”¯ä¸€æ€§ï¼šé€šè¿‡/å¤±è´¥
- [ ] çŠ¶æ€æ£€æŸ¥APIï¼šé€šè¿‡/å¤±è´¥  
- [ ] å¹¶å‘å¤„ç†ï¼šé€šè¿‡/å¤±è´¥
- [ ] é”™è¯¯å¤„ç†ï¼šé€šè¿‡/å¤±è´¥
- [ ] æ•°æ®åº“ä¸€è‡´æ€§ï¼šé€šè¿‡/å¤±è´¥

**æ•´ä½“è¯„ä¼°ï¼š**
- âœ… ä¿®æ”¹æˆåŠŸï¼Œåºåˆ—å·æŒ‰è§„åˆ™å…¨å±€å”¯ä¸€
- âŒ å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•

---

**æµ‹è¯•æ‰§è¡Œè€…**ï¼š\_\_\_\_\_\_\_\_\_\_  
**æµ‹è¯•æ—¶é—´**ï¼š\_\_\_\_å¹´\_\_æœˆ\_\_æ—¥  
**æµ‹è¯•ç¯å¢ƒ**ï¼š\_\_\_\_\_\_\_\_\_\_  
**æµ‹è¯•ç»“æœ**ï¼šâœ…é€šè¿‡ / âŒå¤±è´¥ 