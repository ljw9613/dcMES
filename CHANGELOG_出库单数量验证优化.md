# 出库单数量验证优化 - 更新日志

## 修改时间
2025年11月13日

## 问题描述
在之前的代码中，创建出库单时没有先验证托盘中可出库的产品数量与应出库数量的关系，直接创建了出库单。这导致在整托出库时，如果托盘中的产品数量超过应出库数量，系统不会在创建阶段就提示错误，而是在实际扫码出库时才发现问题。

## 修改内容

### 1. 新增托盘可用数量计算逻辑
在扫码出库接口 `/api/v1/warehouse_entry/scan_on` 中，在创建出库单之前添加了以下逻辑：

```javascript
// 计算托盘中可以出库的产品数量
const availableBarcodes = pallet.palletBarcodes.filter(
  (item) => item.outWarehouseStatus !== "COMPLETED"
);
const availableQuantity = availableBarcodes.length;
```

### 2. 整托出库模式下的数量验证
当满足以下任一条件时，系统会进行数量验证：
- `entryInfo.outboundMode === "PALLET"` （托盘出库模式）
- `palletFinished === true` （整托出库标志）

验证逻辑：
```javascript
if (entryInfo.outboundMode === "PALLET" || palletFinished === true) {
  // 检查1：托盘可用数量是否超过应出库数量
  if (availableQuantity > entryInfo.outboundQuantity) {
    return res.status(200).json({
      code: 404,
      message: `整托出库失败：托盘可出库数量(${availableQuantity})超过应出库数量(${entryInfo.outboundQuantity})。建议：1. 增加应出库数量至${availableQuantity}；2. 使用单品出库模式`,
    });
  }
  
  // 检查2：托盘中是否有可出库的产品
  if (availableQuantity === 0) {
    return res.status(200).json({
      code: 404,
      message: "托盘中没有可出库的产品",
    });
  }
}
```

## 影响范围
- **文件**：`dcMes_server/routes/wareHouseOntry.js`
- **接口**：`POST /api/v1/warehouse_entry/scan_on`
- **影响功能**：整托出库、托盘扫码出库

## 优点

### 1. 提前发现问题
在创建出库单之前就能发现数量不匹配的问题，避免创建无效的出库单。

### 2. 友好的错误提示
当托盘可出库数量超过应出库数量时，系统会明确提示：
- 当前托盘可出库数量
- 应出库数量
- 两种解决方案：增加应出库数量 或 使用单品出库模式

### 3. 防止数据不一致
避免出现出库单创建后无法完成的情况，减少后续的数据清理工作。

## 测试建议

### 测试场景1：托盘数量超过应出库数量
1. 准备一个托盘，包含20个可出库产品
2. 创建出库单，应出库数量设置为15
3. 扫描该托盘进行整托出库
4. **预期结果**：系统提示"整托出库失败：托盘可出库数量(20)超过应出库数量(15)"

### 测试场景2：托盘数量等于应出库数量
1. 准备一个托盘，包含15个可出库产品
2. 创建出库单，应出库数量设置为15
3. 扫描该托盘进行整托出库
4. **预期结果**：正常创建出库单并完成出库

### 测试场景3：托盘数量小于应出库数量
1. 准备一个托盘，包含10个可出库产品
2. 创建出库单，应出库数量设置为15
3. 扫描该托盘进行整托出库
4. **预期结果**：正常创建出库单，出库进度为10/15

### 测试场景4：托盘中无可出库产品
1. 准备一个托盘，所有产品都已出库
2. 扫描该托盘进行整托出库
3. **预期结果**：系统提示"托盘中没有可出库的产品"

### 测试场景5：单品出库模式不受影响
1. 准备一个托盘，包含20个可出库产品
2. 创建出库单，应出库数量设置为15，出库模式为"单品出库"
3. 扫描产品条码进行单品出库
4. **预期结果**：可以正常逐个扫描产品出库，扫描到第15个时完成出库

## 后续改进建议

1. **智能推荐应出库数量**：当用户扫描托盘时，系统可以自动推荐应出库数量为托盘的可用数量。

2. **批量托盘出库优化**：当需要出库多个托盘时，可以提供批量扫描功能，自动计算总数量并创建出库单。

3. **出库单拆分功能**：当一个托盘数量过多时，支持将出库单拆分为多个小单据。

## 注意事项

1. 此修改只影响整托出库模式，单品出库模式不受影响。
2. 已经存在的出库单不受影响，只有新创建的出库单才会执行这个验证。
3. 如果遇到托盘数量超过应出库数量的情况，建议根据实际需求选择合适的解决方案。

