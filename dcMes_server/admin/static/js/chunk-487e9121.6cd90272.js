(window.webpackJsonp=window.webpackJsonp||[]).push([["chunk-487e9121"],{"126d":function(e,t,a){"use strict";a.r(t);var r=(a("f559"),a("456d"),a("a481"),a("28a5"),a("6762"),a("2fdb"),a("7514"),a("2909")),n=(a("ac6a"),a("c7eb")),s=(a("96cf"),a("1da1")),i=a("668b"),o=a("7e1e"),c=a("77d2"),l=a("ed91"),d=(a("940a"),a("22a8")),u=a("6ace"),p=a("ed8c"),h=a("de6b"),m=a.n(h),f=a("33fd"),b=a.n(f),v=a("efc1"),g=a.n(v),I=a("14e1"),k=a.n(I),O=a("aad8"),S={name:"ScanBarCode",components:{ZrSelect:u.a,hirInput:O.a},data:function(){return{autoInit:!0,formData:{productModel:"",productLine:"",processStep:"",componentName:"",productionPlanWorkOrderId:"",workProductionPlanWorkOrderNo:"",workProductionPlanWorkOrderId:""},productOptions:[],processStepOptions:[],materialOptions:[],materialLoading:!1,mainMaterialName:"",mainMaterialCode:"",mainMaterialSpec:"",workmainMaterialId:"",workmainMaterialCode:"",processMaterials:[],scanForm:{mainBarcode:"",barcodes:{}},productLineOptions:[{_id:"1",FNumber:"1",FName:"产线1"},{_id:"2",FNumber:"2",FName:"产线2"}],validateStatus:{mainBarcode:!1},loading:!1,unifiedScanInput:"",hasEditPermission:!1,scanTimer:null,batchMaterialCache:{},printDialogVisible:!1,currentBatchBarcode:"",autoPrint:!1,isCollapsed:!1,websocketConnected:!1,ws:null,heartbeatTimer:null,reconnectAttempts:0,maxReconnectAttempts:5,batchForm:{batchSize:10},batchSizeLocked:!1,scannedList:[],boxList:[],palletForm:{palletCode:"",saleOrderId:"",saleOrderNo:"",productionOrderId:"",workOrderNo:"",totalQuantity:0},salesOrderOptions:[],currentPalletId:"",currentPalletCode:"",processStepData:{},printData:{}}},computed:{mainMaterialId:{get:function(){return localStorage.getItem("mainMaterialId")||""},set:function(e){localStorage.setItem("mainMaterialId",e)}},processStepId:{get:function(){return localStorage.getItem("processStepId")||""},set:function(e){localStorage.setItem("processStepId",e)}},materialName:{get:function(){return localStorage.getItem("materialName")||""},set:function(e){localStorage.setItem("materialName",e)}},processName:{get:function(){return localStorage.getItem("processName")||""},set:function(e){localStorage.setItem("processName",e)}},workProductionPlanWorkOrderId:{get:function(){return localStorage.getItem("workProductionPlanWorkOrderId")||""},set:function(e){localStorage.setItem("workProductionPlanWorkOrderId",e)}},productLineId:{get:function(){return localStorage.getItem("productLineId")||""},set:function(e){localStorage.setItem("productLineId",e)}},productLineName:{get:function(){return localStorage.getItem("productLineName")||""},set:function(e){localStorage.setItem("productLineName",e)}},autoInitMode:{get:function(){return"true"===localStorage.getItem("autoInit")},set:function(e){localStorage.setItem("autoInit",e)}},workProductionPlanWorkOrderNo:{get:function(){return localStorage.getItem("workProductionPlanWorkOrderNo")||""},set:function(e){localStorage.setItem("workProductionPlanWorkOrderNo",e)}},progressPercentage:function(){return parseInt(Math.min(100,this.scannedList.length/this.batchForm.batchSize*100))},savedBatchSize:{get:function(){return localStorage.getItem("batchSize_".concat(this.mainMaterialId,"_").concat(this.processStepId))||10},set:function(e){localStorage.setItem("batchSize_".concat(this.mainMaterialId,"_").concat(this.processStepId),e)}}},watch:{mainMaterialId:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=5;break}return e.next=3,this.getMainMaterialInfo();case 3:e.next=6;break;case 5:this.mainMaterialName="";case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),processStepId:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=6;break}return console.log(t,"newVal============="),e.next=4,this.getProcessMaterials();case 4:e.next=9;break;case 6:this.processMaterials=[],this.scanForm.barcodes={},this.validateStatus={mainBarcode:!1};case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),validateStatus:{handler:function(e){},deep:!0},productLineId:{handler:function(e){e&&this.getSalesOrders()},immediate:!0}},methods:{handleAutoInitChange:function(e){this.autoInit=e,this.autoInitMode=e,this.$message.success("已".concat(e?"开启":"关闭","自动初始化模式")),e&&window.location.reload()},getAutoInitConfig:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r,s,i,o,l;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.processStepId="",e.next=4,Object(c.a)();case 4:if(t=e.sent,console.log("获取到的机器进度:",t.data),200!==t.code||!t.data){e.next=15;break}a=t.data,r=a.materialId,s=a.processStepId,i=a.lineId,o=a.productionPlanWorkOrderId,console.log("materialId:",r),console.log("processStepId:",s.processName),console.log("lineId:",i),console.log("workProductionPlanWorkOrderId:",o),r&&s?(console.log("materialId:",r),console.log("processStepId:",s.processName),console.log("lineId:",i),this.mainMaterialId=r._id,l=s._id,this.processStepId=l,this.processStepData=s,this.formData.productModel=r._id,this.formData.processStep=s._id,this.formData.productLine=i&&i._id,this.formData.workProductionPlanWorkOrderId=o&&o._id,this.formData.workProductionPlanWorkOrderNo=o&&o.workOrderNo,this.workProductionPlanWorkOrderId=o&&o._id,this.workProductionPlanWorkOrderNo=o&&o.workOrderNo,this.materialName="".concat(r.FNumber," - ").concat(r.FName),this.processName=s.processName,i&&(this.productLineId=i._id,this.productLineName=i.lineName,this.formData.lineName=i.lineName),this.$message.success("自动初始化工序成功"),l!==this.processStepId&&this.handleSave()):this.$message.warning("未获取到机器进度配置"),e.next=16;break;case 15:throw new Error(t.message||"获取机器进度失败");case 16:e.next=22;break;case 18:e.prev=18,e.t0=e.catch(0),console.error("自动初始化失败:",e.t0),this.$message.error("自动初始化失败: "+e.t0.message);case 22:case"end":return e.stop()}}),e,this,[[0,18]])})));return function(){return e.apply(this,arguments)}}(),handleWorkOrderSelect:function(e){e&&(this.formData.workProductionPlanWorkOrderNo=e.workOrderNo,this.formData.workProductionPlanWorkOrderId=e._id,this.workProductionPlanWorkOrderNo=e.workOrderNo,this.workProductionPlanWorkOrderId=e._id)},handleProductionLineSelect:function(e){e&&(this.formData.lineName=e.lineName,this.formData.productLine=e._id,localStorage.setItem("productLineName",e.lineName),localStorage.setItem("productLineId",e._id))},getMaterialById:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.b)("k3_BD_MATERIAL",{query:{_id:t}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getCraftByMaterialId:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.b)("craft",{query:{materialId:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessStepById:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.b)("processStep",{query:{_id:t},sort:{sort:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getWorkProductionPlanWorkOrderById:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.b)("production_plan_work_order",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getProcessMaterialById:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Object(o.b)("processMaterials",{query:{_id:t},sort:{_id:1}});case 2:return a=e.sent,e.abrupt("return",a.data[0]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),getMaterialList:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===t){e.next=18;break}return this.materialLoading=!0,e.prev=2,e.next=5,Object(o.b)("k3_BD_MATERIAL",{query:{$or:[{FNumber:{$regex:t,$options:"i"}},{FName:{$regex:t,$options:"i"}}]},page:1,limit:20});case 5:a=e.sent,this.productOptions=a.data,e.next=13;break;case 9:e.prev=9,e.t0=e.catch(2),console.error("获取产品型号失败:",e.t0),this.$message.error("获取产品型号失败");case 13:return e.prev=13,this.materialLoading=!1,e.finish(13);case 16:e.next=19;break;case 18:this.productOptions=[];case 19:case"end":return e.stop()}}),e,this,[[2,9,13,16]])})));return function(t){return e.apply(this,arguments)}}(),handleProductChange:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a,r,s;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t._id,this.processStepOptions=[],this.formData.processStep="",this.mainMaterialId="",a){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,e.next=9,Object(l.b)(a);case 9:r=e.sent,s=r.data,console.log("获取到的工序:",s),this.processStepOptions=s,this.formData.productModel=a,e.next=20;break;case 16:e.prev=16,e.t0=e.catch(6),console.error("获取工序列表失败:",e.t0),this.$message.error("获取工序列表失败");case 20:case"end":return e.stop()}}),e,this,[[6,16]])})));return function(t){return e.apply(this,arguments)}}(),handleProcessChange:function(e){e?(this.formData.processStep=e,this.processStepData=e):this.processStepId=""},handleSave:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.formData.productModel&&this.formData.processStep&&this.formData.productLine){e.next=3;break}return this.$message.warning("请选择产品型号、工序和产线"),e.abrupt("return");case 3:return e.prev=3,t=this.$loading({lock:!0,text:"保存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),this.resetScanForm(),this.mainMaterialId=this.formData.productModel,this.processStepId=this.formData.processStep,this.productLineId=this.formData.productLine,e.next=11,this.getMaterialById(this.formData.productModel);case 11:return(a=e.sent)&&(this.materialName="".concat(a.FNumber," - ").concat(a.FName)),e.next=15,this.getProcessStepById(this.formData.processStep);case 15:(r=e.sent)&&(this.processStepData=r,this.processName=r.processName),this.$message.success("保存成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(3),console.error("保存失败:",e.t0),this.$message.error("保存失败"),loading.close();case 26:case"end":return e.stop()}}),e,this,[[3,21]])})));return function(){return e.apply(this,arguments)}}(),getMainMaterialInfo:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取主物料信息，ID:",this.mainMaterialId),e.next=4,Object(o.b)("k3_BD_MATERIAL",{query:{_id:this.mainMaterialId},page:1,limit:1});case 4:(t=e.sent).data&&t.data[0]?(console.log("获取到的主物料信息:",t.data[0]),this.mainMaterialName=t.data[0].FName,this.mainMaterialCode=t.data[0].FNumber,this.mainMaterialSpec=t.data[0].FSpecification):(console.log("未找到主物料信息"),this.mainMaterialName="",this.mainMaterialCode="",this.mainMaterialSpec=""),e.next=15;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("获取主物料信息失败:",e.t0),this.$message.error("获取主物料信息失败"),this.mainMaterialName="",this.mainMaterialCode="",this.mainMaterialSpec="";case 15:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),getProcessMaterials:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r,s,i,c,l=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("正在获取工序信息，ID:",this.processStepId),e.next=4,Object(o.b)("processStep",{query:{_id:this.processStepId},page:1,limit:1});case 4:if((t=e.sent).data&&0!==!t.data.length){e.next=7;break}throw new Error("未找到工序信息");case 7:return a=t.data[0],this.processStepData=a,e.next=11,Object(o.b)("craft",{query:{_id:a.craftId},page:1,limit:1});case 11:if((r=e.sent).data&&0!==!r.data.length){e.next=14;break}throw new Error("未找到工艺信息");case 14:return s=r.data[0],e.next=17,this.getMaterialById(s.materialId);case 17:if(i=e.sent){e.next=20;break}throw new Error("未找到物料信息");case 20:return this.workmainMaterialId=i._id,this.workmainMaterialCode=i.FNumber,this.mainMaterialName=i.FName,this.mainMaterialCode=i.FNumber,this.mainMaterialSpec=i.FSpecification,console.log("processStep",a),e.prev=26,e.next=29,Object(o.b)("processMaterials",{query:{processStepId:this.processStepId}});case 29:(c=e.sent).data?(this.processMaterials=c.data,this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={},this.processMaterials.forEach((function(e){l.validateStatus[e._id]=!1,l.$set(l.scanForm.barcodes,e._id,"")}))):(this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={}),e.next=40;break;case 33:e.prev=33,e.t0=e.catch(26),console.error("获取工序物料失败:",e.t0),this.$message.error("获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 40:e.next=49;break;case 42:e.prev=42,e.t1=e.catch(0),console.error("获取工序物料失败:",e.t1),this.$message.error(e.t1.message||"获取工序物料失败"),this.processMaterials=[],this.validateStatus={mainBarcode:!1},this.scanForm.barcodes={};case 49:case"end":return e.stop()}}),e,this,[[0,42],[26,33]])})));return function(){return e.apply(this,arguments)}}(),validateDICode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a,s,i,c;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(o.b)("productDiNum",{query:{diNum:t},populate:JSON.stringify([{path:"productId",model:"k3_BD_MATERIAL"}])});case 3:if(0!==(a=e.sent).data.length){e.next=7;break}return this.$message.error("该DI编码不存在本系统"),e.abrupt("return",{isValid:!1});case 7:if(s=a.data.filter((function(e){return e.productId&&e.productId.FNumber})).map((function(e){return e.productId.FNumber})),0!==s.length){e.next=11;break}return this.$message.error("该DI编码未关联有效物料"),e.abrupt("return",{isValid:!1});case 11:if(i=[this.mainMaterialCode].concat(Object(r.a)(this.processMaterials.map((function(e){return e.materialCode})))),c=s.find((function(e){return i.includes(e)})),c){e.next=16;break}return this.$message.error("该DI编码对应的物料与当前工序不匹配"),e.abrupt("return",{isValid:!1});case 16:return e.abrupt("return",{isValid:!0,materialCode:c});case 19:return e.prev=19,e.t0=e.catch(0),console.error("DI码验证失败:",e.t0),this.$message.error("DI码验证失败"),e.abrupt("return",{isValid:!1});case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),validateBarcode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a,r,s,i,o,c,l,d,u,p,h,m,f,b,v,g,I,k;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("validateBarcode",t),t){e.next=3;break}return e.abrupt("return",!1);case 3:if(r="",s=!1,t.includes("#")&&(4===(i=t.split("#")).length&&(a=i[2],r=i[1],s=!0)),s||t.includes("-")&&34!=t.length&&35!=t.length&&(a=t.split("-")[0],r=t.split("-")[1],s=!0),s){e.next=18;break}if(!t.includes("(")){e.next=18;break}return o=t.substring(4,18),console.log("productDI",o),e.next=13,this.validateDICode(o);case 13:if((c=e.sent).isValid){e.next=16;break}return e.abrupt("return",!1);case 16:a=c.materialCode,s=!0;case 18:if(s){e.next=82;break}console.log("barcode",t.length),e.t0=t.length,e.next=35===e.t0?23:34===e.t0?33:48===e.t0?53:32===e.t0?62:20===e.t0?71:80;break;case 23:if(!t.includes("-")){e.next=32;break}return l=t.split("-")[1],console.log("middlePart",l),e.next=28,this.validateDICode(l);case 28:if((d=e.sent).isValid){e.next=31;break}return e.abrupt("return",!1);case 31:a=d.materialCode;case 32:return e.abrupt("break",82);case 33:if(!t.includes("-")){e.next=44;break}return u=t.substring(7,19),console.log("fanDI",u),e.next=38,this.validateDICode(u);case 38:if((p=e.sent).isValid){e.next=41;break}return e.abrupt("return",!1);case 41:a=p.materialCode,e.next=52;break;case 44:return h=t.substring(0,16),console.log("materialDI",h),e.next=48,this.validateDICode(h);case 48:if((m=e.sent).isValid){e.next=51;break}return e.abrupt("return",!1);case 51:a=m.materialCode;case 52:return e.abrupt("break",82);case 53:return f=t.substring(0,12),console.log("lightDI",f),e.next=57,this.validateDICode(f);case 57:if((b=e.sent).isValid){e.next=60;break}return e.abrupt("return",!1);case 60:return a=b.materialCode,e.abrupt("break",82);case 62:return v=t.substring(0,8),console.log("remoteDI",v),e.next=66,this.validateDICode(v);case 66:if((g=e.sent).isValid){e.next=69;break}return e.abrupt("return",!1);case 69:return a=g.materialCode,e.abrupt("break",82);case 71:return I=t.substring(0,11),console.log("batchDI",I),e.next=75,this.validateDICode(I);case 75:if((k=e.sent).isValid){e.next=78;break}return e.abrupt("return",!1);case 78:return a=k.materialCode,e.abrupt("break",82);case 80:return this.$message.error("条码格式不正确，应为：物料编号-序号"),e.abrupt("return",!1);case 82:if(a!==this.mainMaterialCode){e.next=84;break}return e.abrupt("return",{materialCode:a,isValid:!0,relatedBill:r});case 84:return this.$message.error("该条码对应的物料与当前工序所需物料不匹配"),e.abrupt("return",{materialCode:a,isValid:!1});case 86:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleMainBarcode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(o.b)("material_process_flow",{query:{barcode:t}});case 3:if(!((a=e.sent).data&&a.data.length>0)){e.next=9;break}a.data[0],this.$message.success("扫描成功"),e.next=17;break;case 9:return e.next=11,Object(l.a)({mainMaterialId:this.workmainMaterialId,materialCode:this.workmainMaterialCode,barcode:t,productLineId:this.productLineId,productLineName:this.productLineName});case 11:if(200!==(r=e.sent).code){e.next=16;break}this.$message.success("成品条码追溯记录创建成功"),e.next=17;break;case 16:throw new Error(r.msg||"创建成品条码追溯记录失败");case 17:e.next=24;break;case 19:throw e.prev=19,e.t0=e.catch(0),console.error("处理主条码失败:",e.t0),Object(p.a)(b.a),e.t0;case 24:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(t){return e.apply(this,arguments)}}(),handleSubBarcode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t,a){var r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=this.processMaterials.find((function(e){return e._id===t})),r){e.next=4;break}throw new Error("未找到对应的物料信息");case 4:if(r.materialCode===a){e.next=6;break}throw new Error("物料编码不一致");case 6:this.validateStatus[t]=!0,this.$message.success("扫码成功"),e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),console.error("处理子物料条码失败:",e.t0),Object(p.a)(b.a),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(t,a){return e.apply(this,arguments)}}(),fillFormData:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.mainMaterialId&&this.materialName&&(this.formData.productName=this.materialName),this.processStepId&&this.processName&&(this.formData.processStep=this.processName),this.productLineId&&this.productLineName&&(this.formData.productLine=this.productLineId,this.formData.lineName=this.productLineName);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),resetScanForm:function(){var e=this;this.scanForm.mainBarcode="";var t={};this.processMaterials.forEach((function(a){if(a.isBatch){var r="batch_".concat(e.mainMaterialId,"_").concat(e.processStepId,"_").concat(a._id),n=localStorage.getItem(r);n?(t[a._id]=n,e.$set(e.validateStatus,a._id,!0)):(t[a._id]="",e.$set(e.validateStatus,a._id,!1))}else t[a._id]="",e.$set(e.validateStatus,a._id,!1)})),this.scanForm.barcodes=t,this.$set(this.validateStatus,"mainBarcode",!1),this.currentFlowId=null},handleUnifiedScan:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:if(this.scanTimer&&clearTimeout(this.scanTimer),this.$refs.hirInput.selectedTemplate){e.next=8;break}return this.unifiedScanInput="",this.$refs.scanInput.focus(),this.$message.warning("请先选择打印模板"),e.abrupt("return");case 8:this.scanTimer=setTimeout(Object(s.a)(Object(n.a)().mark((function e(){var r,s,i,c,l;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,r=t.trim().replace(/[\r\n]/g,"")){e.next=4;break}return e.abrupt("return");case 4:if(!a.scannedList.some((function(e){return e.barcode===r}))){e.next=8;break}return a.$message.warning("该条码已扫描"),Object(p.a)(k.a),e.abrupt("return");case 8:return e.next=10,Object(o.b)("material_process_flow",{query:{processNodes:{$elemMatch:{barcode:r,isPackingBox:!0}}}});case 10:if(s=e.sent,console.log("boxResponse",s),!(s.data&&s.data.length>0)){e.next=30;break}return i=s.data[0].barcode,e.next=16,a.validateBarcode(i);case 16:if(c=e.sent,console.log("isValid",c),c.isValid){e.next=22;break}return a.$message.error("条码格式不正确，未在系统中注册"),Object(p.a)(b.a),e.abrupt("return");case 22:if(c.materialCode===a.mainMaterialCode){e.next=26;break}return a.$message.error("条码对应物料与当前工序所需物料不匹配"),Object(p.a)(b.a),e.abrupt("return");case 26:return e.next=28,a.handleBoxBarcode(r,s.data);case 28:e.next=45;break;case 30:return e.next=32,a.validateBarcode(r);case 32:if((l=e.sent).isValid){e.next=37;break}return a.$message.error("条码对应物料与当前工序所需物料不匹配"),Object(p.a)(b.a),e.abrupt("return");case 37:if(l.materialCode===a.mainMaterialCode){e.next=41;break}return a.$message.error("条码对应物料与当前工序所需物料不匹配"),Object(p.a)(b.a),e.abrupt("return");case 41:return e.next=43,a.handleMainBarcode(r);case 43:return e.next=45,a.handleSingleBarcode(r);case 45:e.next=52;break;case 47:e.prev=47,e.t0=e.catch(0),console.error("扫描处理失败:",e.t0),a.$message.error(e.t0.message||"扫描处理失败"),Object(p.a)(b.a);case 52:return e.prev=52,a.unifiedScanInput="",a.$refs.scanInput.focus(),e.finish(52);case 56:case"end":return e.stop()}}),e,null,[[0,47,52,56]])}))),1e3);case 9:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),handleBoxBarcode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t,a){var r,s,c,l,u,h,f,v,I,O=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,r=!1,s=!1,e.prev=3,l=Object(i.a)(a);case 5:return e.next=7,l.next();case 7:if(!(r=!(u=e.sent).done)){e.next=37;break}return h=u.value,e.next=11,Object(d.a)({lineId:this.productLineId,lineName:this.productLineName,processStepId:this.processStepId,materialId:this.mainMaterialId,materialCode:this.mainMaterialCode,materialName:this.mainMaterialName,materialSpec:this.mainMaterialSpec,mainBarcode:h.barcode,boxBarcode:t,totalQuantity:this.batchForm.batchSize,userId:this.$store.state.user.id});case 11:if(200!==(f=e.sent).code){e.next=31;break}return this.palletForm.palletCode=f.data.palletCode,this.palletForm.productionOrderId=f.data.productionOrderId,this.palletForm.workOrderNo=f.data.workOrderNo,this.palletForm.saleOrderId=f.data.saleOrderId,this.palletForm.saleOrderNo=f.data.saleOrderNo,this.palletForm.totalQuantity=f.data.totalQuantity,this.scannedList.push({barcode:h.barcode,type:"box",boxBarcode:t,scanTime:new Date}),e.next=22,Object(o.b)("material_palletizing",{query:{_id:f.data._id},populate:JSON.stringify([{path:"productLineId",select:"workshop"},{path:"productLineId",select:"lineCode"}])});case 22:v=e.sent,(I=v.data[0]).createAt=this.formatDate(I.createAt),I.workshop=I.productLineId.workshop||"未记录生产车间",I.qrcode="".concat(I.palletCode,"#").concat(I.saleOrderNo,"#").concat(I.materialCode,"#").concat(I.totalQuantity,"#").concat(I.productLineId.lineCode),this.printData=I,"STACKED"==f.data.status&&(this.palletForm.palletCode="",this.palletForm.totalQuantity=0,this.scannedList=[],this.$nextTick((function(){O.$refs.hirInput.handlePrints2()}))),e.next=34;break;case 31:return this.$message.error(f.message),"该工序节点已完成或处于异常状态"==f.message?Object(p.a)(k.a):"未查询到生产工单"==f.message?Object(p.a)(g.a):"重复扫码"==f.message?Object(p.a)(k.a):Object(p.a)(b.a),e.abrupt("return");case 34:r=!1,e.next=5;break;case 37:e.next=43;break;case 39:e.prev=39,e.t0=e.catch(3),s=!0,c=e.t0;case 43:if(e.prev=43,e.prev=44,!r||null==l.return){e.next=48;break}return e.next=48,l.return();case 48:if(e.prev=48,!s){e.next=51;break}throw c;case 51:return e.finish(48);case 52:return e.finish(43);case 53:Object(p.a)(m.a),this.$message.success("包装箱扫描成功，新增".concat(a.length,"个条码")),e.next=61;break;case 57:throw e.prev=57,e.t1=e.catch(0),console.error("处理包装箱条码失败:",e.t1),e.t1;case 61:case"end":return e.stop()}}),e,this,[[0,57],[3,39,43,53],[44,,48,52]])})));return function(t,a){return e.apply(this,arguments)}}(),handleSingleBarcode:function(){var e=Object(s.a)(Object(n.a)().mark((function e(t){var a,r,s,i=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Object(d.a)({lineId:this.productLineId,lineName:this.productLineName,processStepId:this.processStepId,materialId:this.mainMaterialId,materialCode:this.mainMaterialCode,materialName:this.mainMaterialName,materialSpec:this.mainMaterialSpec,mainBarcode:t,boxBarcode:null,totalQuantity:this.batchForm.batchSize,userId:this.$store.state.user.id});case 3:if(200!==(a=e.sent).code){e.next=26;break}return this.palletForm.palletCode=a.data.palletCode,this.palletForm.productionOrderId=a.data.productionOrderId,this.palletForm.workOrderNo=a.data.workOrderNo,this.palletForm.saleOrderId=a.data.saleOrderId,this.palletForm.saleOrderNo=a.data.saleOrderNo,this.palletForm.totalQuantity=a.data.totalQuantity,this.scannedList.push({barcode:t,type:"single",boxBarcode:"",scanTime:new Date}),e.next=14,Object(o.b)("material_palletizing",{query:{_id:a.data._id},populate:JSON.stringify([{path:"productLineId",select:"workshop"},{path:"productLineId",select:"lineCode"}])});case 14:r=e.sent,(s=r.data[0]).createAt=this.formatDate(s.createAt),s.workshop=s.productLineId.workshop||"未记录生产车间",s.palletBarcodes=s.palletBarcodes.map((function(e){return e.scanTime=i.formatDate(e.scanTime),e})),s.qrcode="".concat(s.palletCode,"#").concat(s.saleOrderNo,"#").concat(s.materialCode,"#").concat(s.totalQuantity,"#").concat(s.productLineId.lineCode),this.printData=s,"STACKED"==a.data.status&&(this.$nextTick((function(){i.$refs.hirInput.handlePrints2()})),this.palletForm.palletCode="",this.scannedList=[]),Object(p.a)(m.a),this.$message.success("条码扫描成功"),e.next=29;break;case 26:return this.$message.error(a.message),"该工序节点已完成或处于异常状态"==a.message?Object(p.a)(k.a):"未查询到生产工单"==a.message?Object(p.a)(g.a):Object(p.a)(b.a),e.abrupt("return");case 29:e.next=35;break;case 31:throw e.prev=31,e.t0=e.catch(0),console.error("处理单个条码失败:",e.t0),e.t0;case 35:case"end":return e.stop()}}),e,this,[[0,31]])})));return function(t){return e.apply(this,arguments)}}(),focusInput:function(){this.$refs.scanInput.focus()},handleCancelSave:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认取消当前工序设置？这将清除所有批次物料的缓存数据。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"取消设置中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),localStorage.removeItem("mainMaterialId"),localStorage.removeItem("processStepId"),localStorage.removeItem("materialName"),localStorage.removeItem("processName"),a=this.formData.productLine,r=this.formData.lineName,this.formData={productModel:"",productLine:a,lineName:r,processStep:"",componentName:""},this.$message.success("已取消工序设置"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("取消设置失败:",e.t0),this.$message.error("取消设置失败"));case 20:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),getValidateIcon:function(e){return this.validateStatus[e]?"el-icon-check success-icon":"el-icon-close error-icon"},handlePrintSuccess:function(){this.$message.success("批次条码打印成功"),this.currentBatchBarcode=""},handlePrintError:function(e){this.$message.error("打印失败: ".concat(e)),this.currentBatchBarcode=""},handleDialogClose:function(){this.printDialogVisible=!1,this.currentBatchBarcode=""},handleAutoPrintChange:function(e){localStorage.setItem("autoPrint",e),this.$message.success("已".concat(e?"开启":"关闭","自动打印模式"))},handleClearCache:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认清除所有页面缓存数据？此操作不可恢复。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:t=this.$loading({lock:!0,text:"清除缓存中...",spinner:"el-icon-loading",background:"rgba(0, 0, 0, 0.7)"}),Object.keys(localStorage).forEach((function(e){e.startsWith("batch_")&&localStorage.removeItem(e)})),this.$message.success("缓存清除成功"),setTimeout((function(){t.close(),window.location.reload()}),500),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),"cancel"!==e.t0&&(console.error("清除缓存失败:",e.t0),this.$message.error("清除缓存失败"));case 13:case"end":return e.stop()}}),e,this,[[0,10]])})));return function(){return e.apply(this,arguments)}}(),toggleCollapse:function(){this.isCollapsed=!this.isCollapsed},initWebSocket:function(){var e=this;try{this.ws&&this.ws.close();var t="ws://192.168.6.250:2223";console.log(t,"VUE_APP_WS_ADDRESS"),this.ws=new WebSocket("".concat(t,"?token=").concat("DcMes_Server_Token")),console.log(this.ws,"this.ws"),this.ws.onopen=function(){e.websocketConnected=!0,e.$message.success("设备服务器连接成功"),e.startHeartbeat(),e.reconnectAttempts=0},this.ws.onclose=function(t){if(e.websocketConnected=!1,e.stopHeartbeat(),console.log("WebSocket连接关闭:",t),e.reconnectAttempts<e.maxReconnectAttempts){e.reconnectAttempts++;var a=Math.min(1e3*Math.pow(2,e.reconnectAttempts),1e4);e.$message.warning("设备连接已断开，".concat(a/1e3,"秒后尝试第").concat(e.reconnectAttempts,"次重连...")),setTimeout((function(){e.initWebSocket()}),a)}else e.$message.error("重连次数已达上限，请检查网络连接或刷新页面")},this.ws.onerror=function(t){e.websocketConnected=!1,console.error("WebSocket连接错误:",t),console.log("错误详情:",{readyState:e.ws.readyState,url:e.ws.url,protocol:e.ws.protocol,error:t})},this.ws.onmessage=function(t){try{var a=JSON.parse(t.data);console.log("收到消息:",a),e.handleWebSocketMessage(a)}catch(e){console.error("消息解析错误:",e)}}}catch(e){console.error("WebSocket初始化失败:",e),this.$message.error("设备连接初始化失败: ".concat(e.message))}},handleWebSocketMessage:function(e){switch(e.type){case"connected":console.log("连接成功，用户ID:",e.userId);break;case"command":"refresh"===e.action&&window.location.reload();break;default:console.log("未知消息类型:",e)}},startHeartbeat:function(){var e=this;this.heartbeatTimer=setInterval((function(){e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send(JSON.stringify({type:"heartbeat"}))}),1e4)},stopHeartbeat:function(){this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null)},sendWebSocketMessage:function(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):this.$message.warning("设备未连接")},handleBatchSizeChange:function(e){this.batchForm.batchSize=e},handleSaveBatchSize:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认保存当前批次数量设置？保存后将无法修改。","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:this.savedBatchSize=this.batchForm.batchSize,this.batchSizeLocked=!0,this.$message.success("批次数量设置已保存"),e.next=11;break;case 8:e.prev=8,e.t0=e.catch(0),"cancel"!==e.t0&&this.$message.error("保存失败");case 11:case"end":return e.stop()}}),e,this,[[0,8]])})));return function(){return e.apply(this,arguments)}}(),handleCancelBatchSize:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.$confirm("确认取消当前批次数量设置？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});case 3:localStorage.removeItem("batchSize_".concat(this.mainMaterialId,"_").concat(this.processStepId)),this.batchSizeLocked=!1,this.batchForm.batchSize=10,this.$message.success("已取消批次数量设置"),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),"cancel"!==e.t0&&this.$message.error("取消失败");case 12:case"end":return e.stop()}}),e,this,[[0,9]])})));return function(){return e.apply(this,arguments)}}(),initBatchSize:function(){var e=this.savedBatchSize;e&&(this.batchForm.batchSize=parseInt(e),this.batchSizeLocked=!0)},formatDate:function(e){return new Date(e).toLocaleString()},clearScannedList:function(){var e=this;this.$confirm("确认清空已扫描列表?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((function(){e.scannedList=[],e.$message.success("列表已清空")})).catch((function(){}))},removeScannedItem:function(e){this.scannedList.splice(e,1)},getSalesOrders:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r,s,i=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,this.productLineId){e.next=4;break}return this.$message.warning("当前产线未设置"),e.abrupt("return");case 4:return e.next=6,Object(o.b)("production_plan_work_order",{query:{productionLineId:this.productLineId,status:"IN_PROGRESS"},populate:JSON.stringify([{path:"saleOrderId"},{path:"productionOrderId"}])});case 6:return t=e.sent,console.log(t,"response"),200===t.code&&t.data.length>0?(this.palletForm.saleOrderId=t.data[0].saleOrderId._id,this.palletForm.saleOrderNo=t.data[0].saleOrderNo,this.palletForm.productionOrderId=t.data[0].productionOrderId._id,this.palletForm.workOrderNo=t.data[0].workOrderNo,this.palletForm.totalQuantity=t.data[0].totalQuantity):this.$message.warning("当前产线没有在生产中的工单"),e.next=11,Object(o.b)("material_palletizing",{query:{productLineId:this.productLineId,status:"STACKING",materialId:this.mainMaterialId},populate:JSON.stringify([{path:"productLineId",select:"workshop"},{path:"productLineId",select:"lineCode"}])});case 11:(a=e.sent).data&&a.data[0]&&(r=a.data[0],this.palletForm.palletCode=r.palletCode,this.palletForm.totalQuantity=r.totalQuantity,this.scannedList=r.palletBarcodes.map((function(e){return{barcode:e.barcode,type:e.barcodeType,scanTime:e.scanTime}})),(s=r).createAt=this.formatDate(s.createAt),s.workshop=s.productLineId.workshop||"未记录生产车间",s.palletBarcodes=s.palletBarcodes.map((function(e){return e.scanTime=i.formatDate(e.scanTime),e})),s.qrcode="".concat(s.palletCode,"#").concat(s.saleOrderNo,"#").concat(s.materialCode,"#").concat(s.totalQuantity,"#").concat(s.productLineId.lineCode),this.printData=s),e.next=19;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("获取销售单号失败:",e.t0),this.$message.error("获取销售单号失败");case 19:case"end":return e.stop()}}),e,this,[[0,15]])})));return function(){return e.apply(this,arguments)}}(),handleSalesOrderChange:function(e){if(e){var t=this.salesOrderOptions.find((function(t){return t._id===e}));t&&(this.palletForm.saleOrderNo=t.saleOrderNo)}else this.palletForm.saleOrderNo=""}},created:function(){var e=Object(s.a)(Object(n.a)().mark((function e(){var t,a,r=this;return Object(n.a)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(t=localStorage.getItem("autoPrint"))&&(this.autoPrint="true"===t),this.initWebSocket(),a=localStorage.getItem("autoInit"),this.autoInit="true"===a,!this.autoInit){e.next=8;break}return e.next=8,this.getAutoInitConfig();case 8:if(!this.mainMaterialId){e.next=11;break}return e.next=11,this.getMainMaterialInfo();case 11:if(!this.processStepId){e.next=15;break}return e.next=14,this.getProcessMaterials();case 14:this.processMaterials.forEach((function(e){if(e.isBatch){var t="batch_".concat(r.mainMaterialId,"_").concat(r.processStepId,"_").concat(e._id),a=localStorage.getItem(t);a&&(r.$set(r.scanForm.barcodes,e._id,a),r.$set(r.validateStatus,e._id,!0))}}));case 15:return e.next=17,this.fillFormData();case 17:this.initBatchSize();case 18:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),mounted:function(){console.log("Complete roles data:",this.$store.getters.roles);var e=this.$store.getters.roles;if(!e||!e.buttonList)return!1;console.log(e.buttonList,"roles.buttonList"),e.buttonList.includes("scan_edit_configuration")&&(this.hasEditPermission=!0),this.mainMaterialId&&this.processStepId&&"F"==this.processStepData.processType&&this.$refs.scanInput.focus()},beforeDestroy:function(){this.scanTimer&&clearTimeout(this.scanTimer),this.ws&&this.ws.close(),this.stopHeartbeat()}},w=S,x=(a("dc4f"),a("2877")),_=Object(x.a)(w,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],staticClass:"scan-container"},[a("div",{staticClass:"left-form",class:{collapsed:e.isCollapsed}},[a("el-card",{staticClass:"init-card"},[a("div",{staticClass:"card-header"},[a("span",[a("i",{staticClass:"el-icon-setting"}),e._v("\n                    工序设置")]),e._v(" "),a("el-switch",{staticClass:"print-switch",attrs:{"active-text":"自动","inactive-text":"手动"},on:{change:e.handleAutoInitChange},model:{value:e.autoInit,callback:function(t){e.autoInit=t},expression:"autoInit"}})],1),e._v(" "),a("el-form",{attrs:{model:e.formData,"label-width":"100px"}},[a("div",{staticClass:"form-section"},[a("div",{staticClass:"section-header"},[a("el-tag",{attrs:{type:e.websocketConnected?"success":"danger"}},[a("i",{staticClass:"el-icon-goods"}),e._v("\n                            "+e._s(e.websocketConnected?"已连接":"未连接"))]),e._v(" "),a("span",[e._v("\n                            基础信息\n                        ")])],1),e._v(" "),a("el-form-item",{attrs:{label:"产品型号"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入物料编码/名称搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.productName,callback:function(t){e.$set(e.formData,"productName",t)},expression:"formData.productName"}}):a("zr-select",{attrs:{collection:"k3_BD_MATERIAL",disabled:!!e.mainMaterialId&&!!e.processStepId,"search-fields":["FNumber","FName"],"label-key":"FName","sub-key":"FMATERIALID",multiple:!1,placeholder:"请输入物料编码/名称搜索"},on:{select:e.handleProductChange},scopedSlots:e._u([{key:"option",fn:function(t){var r=t.item;return[a("div",{staticClass:"item-option"},[a("div",{staticClass:"item-info"},[a("span",[e._v(e._s(r.FNumber)+" - "+e._s(r.FName))]),e._v(" "),a("el-tag",{attrs:{size:"mini",type:"info"}},[e._v(e._s(r.FMATERIALID)+" -"+e._s(r.FUseOrgId))])],1)])]}}],null,!1,1794309911),model:{value:e.formData.productModel,callback:function(t){e.$set(e.formData,"productModel",t)},expression:"formData.productModel"}})],1),e._v(" "),a("el-form-item",{attrs:{label:"产品工序"}},[a("el-select",{staticClass:"custom-select",attrs:{placeholder:"请选择产品工序",disabled:!!e.mainMaterialId&&!!e.processStepId},on:{change:e.handleProcessChange},model:{value:e.formData.processStep,callback:function(t){e.$set(e.formData,"processStep",t)},expression:"formData.processStep"}},e._l(e.processStepOptions,(function(t){return a("el-option",{key:t._id,attrs:{label:t.processName,value:t._id}},[a("div",{staticClass:"option-content"},[a("span",{staticClass:"option-main"},[e._v(e._s(""+(t.levelPrefix||"")+t.sort+"."+t.processName))]),e._v(" "),a("span",{staticClass:"option-sub"},[e._v(e._s(t.processCode))])])])})),1)],1),e._v(" "),a("el-form-item",{attrs:{label:"产线编码"}},[e.mainMaterialId?a("el-input",{attrs:{placeholder:"请输入产线信息搜索",disabled:!!e.mainMaterialId&&!!e.processStepId},model:{value:e.formData.lineName,callback:function(t){e.$set(e.formData,"lineName",t)},expression:"formData.lineName"}}):a("zr-select",{attrs:{disabled:!!e.mainMaterialId&&!!e.processStepId,collection:"production_line","search-fields":["lineCode","lineName"],"label-key":"lineName","tag-key":"lineCode","sub-key":"workshop",multiple:!1,placeholder:"请输入产线信息搜索"},on:{select:e.handleProductionLineSelect},model:{value:e.formData.productLine,callback:function(t){e.$set(e.formData,"productLine",t)},expression:"formData.productLine"}})],1)],1),e._v(" "),e.hasEditPermission?a("div",{staticClass:"button-group"},[e.mainMaterialId&&e.processStepId?a("el-button",{attrs:{type:"danger",icon:"el-icon-close"},on:{click:e.handleCancelSave}},[e._v("\n                        取消设置\n                    ")]):a("el-button",{attrs:{type:"primary",icon:"el-icon-check"},on:{click:e.handleSave}},[e._v("\n                        保存设置\n                    ")])],1):e._e()])],1)],1),e._v(" "),a("div",{staticClass:"right-content"},[e.mainMaterialId&&e.processStepId&&"F"==e.processStepData.processType?[a("el-card",{staticClass:"scan-card"},[a("div",{staticClass:"card-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-box"}),e._v(" "),a("span",[e._v("托盘管理")]),e._v(" "),a("el-button",{attrs:{type:"text"},on:{click:e.toggleCollapse}},[a("i",{class:e.isCollapsed?"el-icon-d-arrow-right":"el-icon-d-arrow-left"}),e._v("\n                            "+e._s(e.isCollapsed?"展开":"收起")+"\n                        ")])],1),e._v(" "),e.hasEditPermission?a("el-form",{attrs:{model:e.batchForm,"label-width":"100px"}},[a("el-form-item",{attrs:{label:"产品数量"}},[a("div",{staticClass:"batch-size-control"},[a("el-input-number",{attrs:{size:"mini",min:1,max:999,disabled:e.batchSizeLocked},on:{change:e.handleBatchSizeChange},model:{value:e.batchForm.batchSize,callback:function(t){e.$set(e.batchForm,"batchSize",t)},expression:"batchForm.batchSize"}}),e._v(" "),e.batchSizeLocked?[a("el-button",{staticStyle:{color:"red"},attrs:{type:"text",icon:"el-icon-close"},on:{click:e.handleCancelBatchSize}},[e._v("\n                                        取消\n                                    ")])]:[a("el-button",{attrs:{type:"text",size:"mini",icon:"el-icon-check"},on:{click:e.handleSaveBatchSize}},[e._v("\n                                        保存\n                                    ")])]],2)])],1):e._e()],1),e._v(" "),a("el-form",{ref:"scanForm",attrs:{model:e.scanForm,"label-width":"100%"}},[a("div",{staticClass:"section-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-camera"}),e._v(" "),a("span",[e._v("统一扫描区域")])]),e._v(" "),a("hir-input",{ref:"hirInput",attrs:{"enable-template-cache":!0,"show-preview":!0,"show-browser-print":!0,"show-silent-print":!0,printData:e.printData}})],1),e._v(" "),a("div",{staticClass:"scan-input-section"},[a("el-input",{ref:"scanInput",attrs:{placeholder:"请扫描条码",clearable:""},on:{input:e.handleUnifiedScan,clear:e.focusInput},model:{value:e.unifiedScanInput,callback:function(t){e.unifiedScanInput=t},expression:"unifiedScanInput"}})],1),e._v(" "),a("el-row",{attrs:{gutter:30}},[a("div",{staticClass:"basic-info-section"},[a("div",{staticClass:"section-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-document"}),e._v(" "),a("span",[e._v("单据信息")])])]),e._v(" "),a("el-form",{staticClass:"pallet-form",attrs:{model:e.palletForm}},[a("el-row",{attrs:{gutter:10}},[a("el-col",{attrs:{span:8}},[a("el-card",{staticClass:"info-card",attrs:{shadow:"hover"}},[a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("销售单号：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.palletForm.saleOrderNo))])]),e._v(" "),a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("托盘单据编号：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.palletForm.palletCode||"未生成"))])])])],1),e._v(" "),a("el-col",{attrs:{span:8}},[a("el-card",{staticClass:"info-card",attrs:{shadow:"hover"}},[a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("生产工单：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.palletForm.workOrderNo))])]),e._v(" "),a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("托盘单据数量：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.palletForm.totalQuantity))])])])],1),e._v(" "),a("el-col",{attrs:{span:8}},[a("el-card",{staticClass:"info-card",attrs:{shadow:"hover"}},[a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("物料编号：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.mainMaterialCode))])]),e._v(" "),a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("物料名称：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.mainMaterialName))])]),e._v(" "),a("div",{staticClass:"info-item"},[a("span",{staticClass:"label"},[e._v("物料规格：")]),e._v(" "),a("span",{staticClass:"value"},[e._v(e._s(e.mainMaterialSpec))])])])],1)],1)],1)],1)]),e._v(" "),a("div",{staticClass:"scanned-list"},[a("div",{staticClass:"section-header"},[a("div",{staticClass:"header-left"},[a("i",{staticClass:"el-icon-document"}),e._v(" "),a("span",[e._v("已扫描条码")])]),e._v(" "),a("div",{staticClass:"progress-container"},[a("div",{staticClass:"progress-text"},[e._v("\n                                    当前进度: "+e._s(e.scannedList.length)+"/"+e._s(e.batchForm.batchSize)+"\n                                ")]),e._v(" "),a("el-progress",{attrs:{percentage:e.progressPercentage}})],1)]),e._v(" "),a("el-row",{staticClass:"barcode-list",attrs:{gutter:20}},e._l(e.scannedList,(function(t,r){return a("el-col",{key:r,attrs:{span:8}},[a("el-card",{staticClass:"barcode-card",attrs:{shadow:"hover"}},[a("div",{staticClass:"barcode-content"},[a("div",{staticClass:"barcode-info"},[a("div",{staticClass:"scan-time"},[e._v("条码：")]),e._v(" "),a("div",{staticClass:"scan-time"},[e._v(e._s(t.barcode))]),e._v(" "),a("div",{staticClass:"scan-time"},[e._v("扫描时间："+e._s(e.formatDate(t.scanTime)))])])])])],1)})),1)],1)],1)],1)]:[e._m(0)]],2)])}),[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"init-tip"},[a("div",{staticClass:"overlay"},[a("i",{staticClass:"el-icon-warning-outline pulse"}),e._v(" "),a("p",[e._v("请先初始化工序设置,检测当前工序是否为托盘工序")])])])}],!1,null,"570d8265",null);t.default=_.exports},"14e1":function(e,t,a){e.exports=a.p+"static/media/cfbd.7c42ce8c.mp3"},"22a8":function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"c",(function(){return s})),a.d(t,"b",(function(){return i}));var r=a("b775");function n(e){return Object(r.a)({url:"/handlePalletBarcode",method:"post",data:e})}function s(e){return Object(r.a)({url:"/unbindPalletBarcode",method:"post",data:e})}function i(e){return Object(r.a)({url:"/unbindPalletAllBarcode",method:"post",data:e})}},"33fd":function(e,t,a){e.exports=a.p+"static/media/tmyw.a5dd40df.mp3"},"668b":function(e,t,a){"use strict";function r(e){var t,a,r,s=2;for("undefined"!=typeof Symbol&&(a=Symbol.asyncIterator,r=Symbol.iterator);s--;){if(a&&null!=(t=e[a]))return t.call(e);if(r&&null!=(t=e[r]))return new n(t.call(e));a="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function n(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return n=function(e){this.s=e,this.n=e.next},n.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var a=this.s.return;return void 0===a?Promise.resolve({value:e,done:!0}):t(a.apply(this.s,arguments))},throw:function(e){var a=this.s.return;return void 0===a?Promise.reject(e):t(a.apply(this.s,arguments))}},new n(e)}a.d(t,"a",(function(){return r}))},"77d2":function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"b",(function(){return s}));var r=a("b775");function n(e){return Object(r.a)({url:"/machine/progress",method:"get",params:e})}function s(e){return Object(r.a)({url:"/machine/refresh",method:"post",data:e})}},"940a":function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var r=a("b775");function n(e){return Object(r.a)({url:"/material-barcode/create",method:"post",data:e})}},"9fc5":function(e,t,a){},dc4f:function(e,t,a){"use strict";a("9fc5")},de6b:function(e,t,a){e.exports=a.p+"static/media/smcg.fe637541.mp3"},ed8c:function(e,t,a){"use strict";function r(e){new Audio(e).play().catch((function(e){console.warn("音频播放失败:",e)}))}a.d(t,"a",(function(){return r}))},ed91:function(e,t,a){"use strict";a.d(t,"a",(function(){return n})),a.d(t,"c",(function(){return s})),a.d(t,"d",(function(){return i})),a.d(t,"e",(function(){return o})),a.d(t,"b",(function(){return c}));var r=a("b775");function n(e){return Object(r.a)({url:"/create-flow",method:"post",data:e})}function s(e){return Object(r.a)({url:"/scan-components",method:"post",data:e})}function i(e){return Object(r.a)({url:"/unbind-components",method:"post",data:e})}function o(e){return Object(r.a)({url:"/update-flow-nodes",method:"post",data:e})}function c(e){return Object(r.a)({url:"/all-process-steps/".concat(e),method:"get"})}},efc1:function(e,t,a){e.exports=a.p+"static/media/cxwgd.275a0cbb.mp3"}}]);