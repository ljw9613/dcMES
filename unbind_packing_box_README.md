# 包装箱工序解绑脚本使用说明

## 脚本功能

根据提供的包装箱条码列表，查找使用了这些包装箱的主条码，并解绑对应的装箱工序。

## 工作原理

1. **查询逻辑**：通过 `processNodes.barcode` 匹配包装箱条码，且 `isPackingBox = true`
2. **定位工序**：找到包装箱节点对应的装箱工序节点（通过 parentNodeId 或同层级工序）
3. **解绑操作**：调用 `MaterialProcessFlowService.unbindProcessComponents` 解绑装箱工序

## 使用步骤

### 1. 配置包装箱条码列表

编辑 `unbind_packing_box.js` 文件中的 `CONFIG` 对象：

```javascript
const CONFIG = {
  // 包装箱条码列表（在这里添加需要解绑的包装箱条码）
  packingBoxBarcodes: [
    "1001998510001142",
    "1001998510001143",
    "1001998510001144",
    // 继续添加更多条码...
  ],
  
  // 解绑原因
  unbindReason: "手动解绑包装箱工序",
  
  // 操作用户ID
  userId: "SYSTEM",
  
  // 预览模式：true=只查看不执行，false=真实执行
  dryRun: true,
};
```

### 2. 配置数据库连接

如果需要修改数据库连接信息，编辑 `DB_CONFIG` 对象：

```javascript
const DB_CONFIG = {
  host: "localhost",
  port: 27017,
  database: "dcMes",
  // 如果有用户名密码，请取消注释并填写
  // username: "your_username",
  // password: "your_password",
};
```

### 3. 预览模式运行（推荐先执行）

```bash
node unbind_packing_box.js
```

预览模式 (`dryRun: true`) 会显示：
- 找到多少个包装箱条码
- 每个包装箱对应多少个主条码
- 将要解绑哪些装箱工序
- **不会实际执行解绑操作**

### 4. 真实执行

确认预览结果无误后，修改配置：

```javascript
dryRun: false,  // 改为 false
```

然后再次运行：

```bash
node unbind_packing_box.js
```

## 输出示例

### 查询阶段
```
========================================
   包装箱工序解绑脚本
========================================
配置信息:
  - 包装箱条码数量: 3
  - 解绑原因: 手动解绑包装箱工序
  - 执行模式: 预览模式（不会实际执行）
========================================
✅ 数据库连接成功

🔍 正在查找使用包装箱条码 [1001998510001142] 的主条码...
   - 找到 2 条主条码记录
   ✅ 找到 2 个主条码

🔍 正在查找使用包装箱条码 [1001998510001143] 的主条码...
   - 找到 1 条主条码记录
   ✅ 找到 1 个主条码
```

### 查询摘要
```
============================================================
📊 查询摘要
============================================================
📦 提供的包装箱条码数量: 3
✅ 成功匹配的包装箱: 2
🔍 找到的主条码数量: 3
⚠️  未找到匹配的包装箱: 1

⚠️  以下包装箱条码未找到对应的主条码:
   1. 1001998510001144
============================================================
```

### 执行阶段
```
🔍 预览模式 - 开始解绑装箱工序...

[1/3] 处理主条码: P202508231755932375363-001
   - 物料: 1108102001 某物料名称
   - 包装箱条码: 1001998510001142
   - 装箱工序: 装箱 (PACK-001)
   - 工序序号: 第 5 道
   - 完成时间: 2024/10/30 14:30:25
   - 当前进度: 100%
   ✅ [预览] 该条码符合解绑条件，将解绑装箱工序
```

### 最终结果
```
============================================================
📊 预览结果
============================================================
✅ 成功: 3 个
❌ 失败: 0 个
============================================================

✅ 符合解绑条件的装箱工序:
   1. 主条码: P202508231755932375363-001 | 包装箱: 1001998510001142
   2. 主条码: P202508231755932375363-002 | 包装箱: 1001998510001142
   3. 主条码: P202508231755932375363-003 | 包装箱: 1001998510001143

💡 提示: 当前为预览模式，未实际执行解绑操作
   如需真实执行，请将 CONFIG.dryRun 设置为 false
```

## 查询逻辑说明

### 包装箱节点识别
脚本通过以下条件查找包装箱节点：
```javascript
{
  "processNodes.barcode": "包装箱条码",
  "processNodes.isPackingBox": true,
  "processNodes.status": "COMPLETED"
}
```

### 装箱工序定位
找到包装箱节点后，脚本会尝试以下方法定位装箱工序：

1. **方法1：通过 parentNodeId**
   - 包装箱节点的 `parentNodeId` 通常指向对应的装箱工序节点

2. **方法2：同层级工序查找**
   - 查找同一层级的工序节点
   - 工序名称包含 "装箱" 或 "包装"
   - 或者工序类型为 "PACKING"

## 注意事项

### ⚠️ 重要提醒

1. **先预览后执行**
   - 务必先在预览模式下运行，确认结果正确
   - 解绑操作不可逆，请谨慎操作

2. **数据完整性检查**
   - 确保包装箱条码准确无误
   - 检查是否会影响后续工序
   - 确认是否需要解绑后续工序（默认不解绑）

3. **批量操作建议**
   - 如果条码数量很多，建议分批执行
   - 每批建议不超过 100 条
   - 观察执行结果后再继续

4. **数据库备份**
   - 执行前建议备份 `material_process_flow` 集合
   - 防止误操作导致数据丢失

### 常见问题

**Q: 为什么某些包装箱条码找不到对应的主条码？**
- 检查包装箱条码是否正确
- 确认该包装箱是否已经在系统中使用
- 检查 `isPackingBox` 字段是否为 true

**Q: 解绑后会影响哪些数据？**
- 装箱工序状态会从 "COMPLETED" 变为其他状态
- 包装箱条码会从 processNodes 中移除
- 主条码的完成进度会重新计算
- 不会影响其他未选中的工序

**Q: 如何只解绑特定工序？**
- 脚本已经设置为只解绑装箱工序
- 不会解绑后续工序（`unbindSubsequent: false`）
- 如需修改，可以调整脚本中的参数

## 技术细节

### 依赖模块
- `mongoose`: MongoDB ORM
- `MaterialProcessFlow`: 物料工艺流程模型
- `MaterialProcessFlowService`: 工艺流程服务

### 主要函数
- `connectDB()`: 连接数据库
- `findMainBarcodesWithPackingBox()`: 根据包装箱条码查找主条码
- `findPackingProcessNode()`: 定位装箱工序节点
- `executeUnbind()`: 执行解绑操作
- `printResults()`: 打印执行结果

## 扩展功能

如需自定义功能，可以修改以下部分：

### 1. 修改查询条件
在 `findMainBarcodesWithPackingBox()` 函数中添加更多筛选条件

### 2. 修改解绑行为
在 `executeUnbind()` 函数中调整 `unbindProcessComponents` 的参数：
- `unbindSubsequent`: 是否解绑后续工序
- `fromPalletUnbind`: 是否来自托盘解绑

### 3. 添加日志记录
可以将执行结果写入日志文件，便于追溯

## 联系方式

如有问题或需要帮助，请联系开发团队。

