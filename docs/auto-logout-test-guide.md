# 自动退出功能测试指南

## 概述

本指南详细说明如何测试用户15分钟无活动自动退出功能，确保该功能在各种场景下都能正常工作。

**重要变更（最新版本）：**
- **完全由前端控制会话过期**：后端不再进行时间校验，避免前后端时间不同步问题
- **前端拦截机制**：会话过期后前端将阻止所有API请求和页面跳转
- **更精准的控制**：不会因为后端时间校验导致意外的会话终止

## 测试环境准备

### 1. 启动系统
```bash
# 启动后端服务
cd dcMes_server
npm start

# 启动前端服务
cd dcMes_vue_system
npm run serve
```

### 2. 访问测试页面
- 登录系统后，访问测试页面：`http://localhost:8080/#/autoLogoutTest`
- 或者在浏览器地址栏直接输入：`/autoLogoutTest`

## 测试功能说明

### 核心功能
1. **活动监听**：监听鼠标移动、点击、键盘输入、滚动等用户活动
2. **15分钟超时**：用户无活动15分钟后自动退出
3. **14分钟警告**：在第14分钟时显示警告提示
4. **页面刷新检查**：页面刷新时检查是否已超时
5. **Token自动更新**：API请求时自动更新token中的活动时间

### 测试页面功能
1. **实时监控**：显示剩余时间、活动状态、Token状态等
2. **手动测试**：提供各种测试按钮模拟不同场景
3. **自动化测试**：30秒快速测试功能
4. **日志记录**：详细记录所有测试活动
5. **数据导出**：支持导出测试日志为CSV文件

## 详细测试步骤

### 测试1：基本功能测试

#### 1.1 正常活动重置测试
1. 打开测试页面，观察剩余时间显示
2. 移动鼠标或点击页面
3. **预期结果**：剩余时间重置为15:00，进度条回到100%

#### 1.2 警告提示测试
1. 点击"模拟警告"按钮
2. 观察页面变化
3. **预期结果**：
   - 剩余时间显示约1分钟
   - 进度条变为橙色或红色
   - 系统显示警告消息

#### 1.3 超时自动退出测试
1. 点击"模拟超时"按钮
2. 刷新页面或发起API请求
3. **预期结果**：
   - 系统自动跳转到登录页
   - 显示"会话已过期"消息

### 测试2：强制重新登录测试（重要）

#### 2.1 过期状态测试
1. 点击"测试过期状态"按钮
2. 观察页面状态变化
3. 尝试移动鼠标或点击其他按钮
4. **预期结果**：
   - 活动状态显示为"会话已过期"
   - 任何用户操作都会触发强制重新登录弹窗
   - 倒计时显示为00:00

#### 2.2 强制重新登录弹窗测试
1. 点击"测试强制重登"按钮
2. 观察弹窗内容和行为
3. **预期结果**：
   - 显示"会话过期"弹窗
   - 弹窗不能通过ESC或点击遮罩关闭
   - 只能点击"重新登录"按钮
   - 点击后跳转到登录页

#### 2.3 时间到期后的活动测试
1. 等待倒计时到00:00（或使用"模拟超时"）
2. 尝试移动鼠标
3. **预期结果**：
   - 鼠标移动不会重置倒计时
   - 立即显示强制重新登录弹窗
   - 系统不允许继续操作

### 测试3：快速测试（推荐）

#### 3.1 30秒快速测试
1. 点击"开始快速测试"按钮
2. 观察进度条和状态变化
3. 在25秒时应显示警告
4. 30秒后应自动标记为过期状态
5. **预期结果**：
   - 进度条正常递减
   - 25秒时显示警告状态
   - 30秒时会话标记为过期，任何操作触发强制重登

#### 3.2 测试中断
1. 开始快速测试
2. 在测试过程中点击"停止测试"
3. **预期结果**：测试立即停止，超时时间恢复为15分钟

### 测试4：API请求和Token更新

#### 4.1 单个API请求测试
1. 点击"发送测试请求"按钮
2. 观察请求结果和日志
3. **预期结果**：
   - API请求成功
   - 控制台显示token更新信息
   - 活动时间重置

#### 4.2 连续API请求测试
1. 点击"连续请求测试"按钮
2. 观察5个连续请求的执行情况
3. **预期结果**：
   - 所有请求都成功
   - 每次请求都更新活动时间
   - Token状态保持正常

### 测试5：页面刷新和持久化

#### 5.1 正常刷新测试
1. 在活动时间内刷新页面
2. **预期结果**：
   - 页面正常加载
   - 活动监听自动启动
   - 剩余时间正确显示

#### 5.2 超时刷新测试
1. 模拟超时状态
2. 点击"测试刷新"按钮
3. **预期结果**：
   - 页面刷新后会话标记为过期
   - 任何操作触发强制重新登录弹窗

### 测试6：全局拦截测试（重要安全功能）

#### 6.1 路由拦截测试
1. 点击"测试过期状态"按钮标记会话为过期
2. 点击"测试路由跳转"按钮
3. **预期结果**：
   - 路由跳转被阻止
   - 显示强制重新登录弹窗
   - 页面保持在当前测试页面

#### 6.2 API请求拦截测试
1. 确保会话已过期
2. 点击"发送测试请求"按钮
3. **预期结果**：
   - API请求被拦截
   - 显示"会话已过期，请重新登录"错误
   - 触发强制重新登录弹窗

#### 6.3 新页面访问拦截测试
1. 确保会话已过期
2. 点击"测试页面访问"按钮
3. 尝试在新标签页中访问其他页面
4. **预期结果**：
   - 新标签页中的页面被路由守卫拦截
   - 显示强制重新登录弹窗
   - 无法正常访问受保护的页面

#### 6.4 浏览器标签页切换测试
1. 标记会话为过期状态
2. 切换到其他浏览器标签页再切换回来
3. **预期结果**：
   - 页面变为可见时检测到过期状态
   - 自动显示强制重新登录弹窗

### 测试7：边界条件测试

#### 7.1 临界时间测试（重要变更）
1. 等待剩余时间接近1分钟但未到00:00
2. 进行用户活动
3. **预期结果**：时间重置，警告消失
4. 等待剩余时间到达00:00
5. 再进行用户活动
6. **预期结果**：时间不会重置，触发强制重新登录弹窗

#### 7.2 网络异常测试
1. 断开网络连接
2. 尝试发送API请求
3. **预期结果**：
   - 请求失败
   - 错误信息正确显示
   - 系统状态保持稳定

## 测试检查清单

### 功能检查
- [ ] 用户活动正确重置计时器（15分钟内）
- [ ] 14分钟时显示警告提示
- [ ] 15分钟时标记会话过期（不是直接退出）
- [ ] 会话过期后用户活动触发强制重新登录弹窗
- [ ] 强制重新登录弹窗不能关闭（只能点击重新登录）
- [ ] 页面刷新时检查超时状态
- [ ] API请求时更新token（仅在未过期时）
- [ ] 登录后自动启动监听
- [ ] 退出时停止监听
- [ ] 过期状态在测试页面正确显示

### 全局拦截检查
- [ ] 路由守卫拦截过期会话的页面跳转
- [ ] 请求拦截器阻止过期会话的API调用
- [ ] 新标签页访问被正确拦截
- [ ] 页面可见性变化时触发过期检查
- [ ] 所有受保护页面都无法在过期状态下访问

### 界面检查
- [ ] 剩余时间显示正确
- [ ] 进度条颜色变化正常
- [ ] 活动状态显示准确
- [ ] Token状态监控正常
- [ ] 日志记录完整

### 性能检查
- [ ] 监听不影响页面性能
- [ ] 内存使用正常
- [ ] 定时器正确清理
- [ ] 事件监听器正确移除

## 常见问题排查

### 1. 自动退出不工作
**可能原因**：
- 活动监听未启动
- 浏览器阻止了定时器
- localStorage被清除

**排查方法**：
- 检查控制台是否有错误
- 确认localStorage中有lastActivityTime
- 检查userActivityMonitor.isActive状态

### 2. 警告不显示
**可能原因**：
- 消息组件被阻止
- 时间计算错误

**排查方法**：
- 检查Element UI消息组件
- 验证时间计算逻辑

### 3. Token更新失败
**可能原因**：
- 后端中间件未正确配置
- 请求头处理错误

**排查方法**：
- 检查网络请求响应头
- 查看后端日志
- 验证JWT处理逻辑

## 测试报告模板

### 测试环境
- 浏览器：
- 操作系统：
- 测试时间：
- 测试人员：

### 测试结果
| 测试项目 | 预期结果 | 实际结果 | 状态 | 备注 |
|---------|---------|---------|------|------|
| 基本功能测试 | | | | |
| 快速测试 | | | | |
| API请求测试 | | | | |
| 页面刷新测试 | | | | |
| 边界条件测试 | | | | |

### 问题记录
1. 问题描述：
   - 重现步骤：
   - 预期结果：
   - 实际结果：
   - 严重程度：

### 测试结论
- [ ] 功能完全正常
- [ ] 存在轻微问题但不影响使用
- [ ] 存在严重问题需要修复

## 自动化测试脚本

可以使用以下JavaScript代码进行自动化测试：

```javascript
// 在浏览器控制台中运行
async function autoTest() {
  console.log('开始自动化测试...');
  
  // 测试1：检查初始状态
  console.log('测试1：检查初始状态');
  const remainingTime = userActivityMonitor.getRemainingTime();
  console.log('剩余时间：', remainingTime);
  
  // 测试2：模拟用户活动
  console.log('测试2：模拟用户活动');
  document.dispatchEvent(new Event('mousemove'));
  
  // 测试3：API请求
  console.log('测试3：API请求');
  try {
    const response = await fetch('/api/v1/user/info', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('Admin-Token')}`
      },
      body: JSON.stringify({ id: localStorage.getItem('Admin-UserId') })
    });
    console.log('API请求结果：', response.status);
  } catch (error) {
    console.error('API请求失败：', error);
  }
  
  console.log('自动化测试完成');
}

// 运行测试
autoTest();
```

## 总结

通过以上测试步骤，可以全面验证自动退出功能的正确性和稳定性。建议在不同浏览器和设备上进行测试，确保功能的兼容性。测试过程中如发现问题，请及时记录并反馈给开发团队。
